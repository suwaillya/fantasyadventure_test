
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹»æƒ³å†’éšªv1.1.1 </title>
    <style>
        :root {
            /* åŸæœ¬çš„è®Šæ•¸ */
            --bg-color: #1a1a1a;
            --panel-color: #2d2d2d;
            --text-color: #e0e0e0;
            --accent-color: #ff9800;
            --border-radius: 8px;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            
            /* Rarity Colors */
            --common: #b0b0b0;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ffd700;
            --mythic: #ff0055;
            --ultra: #00ffcc;
            
            /* Buff Colors */
            --buff-angel: #4fc3f7;
            --buff-demon: #ef5350;
        }

        /* ç…‰ç„æ¨¡å¼è®Šæ•¸è¦†è“‹ */
        body.inferno-mode {
            --bg-color: #050000;
            --panel-color: #1a0505;
            --text-color: #ffcccc;
            --accent-color: #ff3333;
            background-image: repeating-linear-gradient(
                45deg,
                #050000,
                #050000 10px,
                #110000 10px,
                #110000 20px
            );
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background-color 1s, color 1s;
        }

        #game-container {
            width: 100%;
            max-width: 700px;
            background-color: var(--panel-color);
            padding: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            transition: background-color 1s, box-shadow 1s;
        }
        
        /* ç…‰ç„æ¨¡å¼ä¸‹çš„å®¹å™¨ç‰¹æ•ˆ */
        body.inferno-mode #game-container {
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
            border: 1px solid #330000;
        }

        /* Header & Stats */
        header {
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .class-badge {
            font-size: 0.8em;
            background: #444;
            padding: 2px 8px;
            border-radius: 4px;
            color: var(--accent-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            background: #222;
            padding: 10px;
            border-radius: var(--border-radius);
            font-size: 0.9em;
        }
        
        body.inferno-mode .stats-grid {
            background: #220000;
            border: 1px solid #550000;
        }

        .stat-item span { font-weight: bold; color: var(--accent-color); }
        
		#buff-display {
			grid-column: span 2;
			border-top: 1px solid #444;
			padding-top: 5px;
			margin-top: 5px;
			font-size: 0.85em;
			color: #aaa;
			cursor: help;
			transition: 0.2s;

			/* è®“ç‹€æ…‹æ–‡å­— + å‹¾é¸æ¡†åŒè¡Œæ’åˆ— */
			display: flex;
			justify-content: space-between;
			align-items: center;
			gap: 8px;
		}
		#buff-display:hover { background: #333; }

		/* å‹¾é¸æ¡†é‚£ä¸€å´çš„æ¨£å¼ */
		.opt-auto-skip {
			display: flex;
			align-items: center;
			gap: 4px;
			font-size: 0.8em;
			color: #aaa;
			cursor: default;             /* ä¸è¦é¡¯ç¤ºã€Œèªªæ˜ã€çš„å•è™Ÿ */
		}
		.opt-auto-skip input {
			cursor: pointer;
		}


		/* å¤–å±¤ï¼šé«˜åº¦å›ºå®šï¼Œè² è²¬ç½®ä¸­ event-inner */
		#event-display {
			background: #222;
			border-radius: var(--border-radius);
			padding: 20px;
			border: 1px solid #444;
			position: relative;

			display: flex;
			flex-direction: column;
			align-items: center;   /* âœ… ä¿ç•™ä½ è¦çš„ç½®ä¸­ */
			justify-content: center;
			text-align: center;

			height: 3000px;         /* âœ… å›ºå®šé«˜åº¦ï¼Œæƒ³é«˜ä¸€é»è‡ªå·±èª¿ */
			overflow: hidden;      /* å¤–å±¤ä¸æ²ï¼Œç”±å…§å±¤æ² */
		}

		/* å…§å±¤ï¼šçœŸæ­£æ»¾å‹•çš„å€å¡Šï¼Œè£ iconï¼‹æ¨™é¡Œï¼‹æ•˜è¿°ï¼‹å•†åº— */
		#event-inner {
			max-height: 100%;
			width: 100%;
			overflow-y: auto;      /* âœ… å…¨éƒ¨ä¸€èµ·è®Šæˆå‚ç›´æ²å‹• */
			overflow-x: hidden;
		}

		/* å•†åº— / è£½ä½œç¨å¾®ç•™å€‹ç©ºéš™ï¼Œçœ‹èµ·ä¾†æ¯”è¼ƒä¸æ“  */
		#merchant-area,
		#crafting-area {
			margin-top: 10px;
		}

        
        body.inferno-mode #event-display {
            background: #110000;
            border-color: #660000;
        }

        .monster-icon { font-size: 4em; margin-bottom: 10px; display: inline-block; transition: 0.3s; }
        
        /* Glow Effects */
        .glow-blue { filter: drop-shadow(0 0 10px #2196f3); }
        .glow-red { filter: drop-shadow(0 0 15px #f44336); transform: scale(1.1); }
        .glow-purple { filter: drop-shadow(0 0 20px #9c27b0); animation: true-form-pulse 2s infinite; transform: scale(1.3); }
        
        /* Inferno Specific Glows */
        .glow-inferno { filter: drop-shadow(0 0 15px #ff0000); animation: inferno-pulse 1s infinite alternate; }
        .glow-void { filter: drop-shadow(0 0 15px #000000) drop-shadow(0 0 5px #ff00ff); animation: glitch-anim 2s infinite; }

        @keyframes true-form-pulse {
            0% { filter: drop-shadow(0 0 20px #9c27b0); }
            50% { filter: drop-shadow(0 0 40px #e040fb); }
            100% { filter: drop-shadow(0 0 20px #9c27b0); }
        }
        
        @keyframes inferno-pulse {
            from { filter: drop-shadow(0 0 10px #ff0000); }
            to { filter: drop-shadow(0 0 25px #ff3300); }
        }

        @keyframes glitch-anim {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }
@keyframes lilith-pulse {
            0% { filter: drop-shadow(0 0 2px rgba(255, 192, 203, 0.5)); }
            50% { filter: drop-shadow(0 0 15px rgba(255, 20, 147, 0.9)); }
            100% { filter: drop-shadow(0 0 2px rgba(255, 192, 203, 0.5)); }
        }
        .lilith-glow {
            animation: lilith-pulse 3s infinite ease-in-out;
        }
        /* Animations */
        @keyframes spawn-pop { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes damage-shake { 0% { transform: translate(0, 0); filter: none; } 20% { transform: translate(-10px, 0) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translate(10px, 0) rotate(5deg); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        @keyframes attack-lunge { 0% { transform: translateY(0) scale(1); } 30% { transform: translateY(20px) scale(1.2); } 100% { transform: translateY(0) scale(1); } }
        @keyframes screen-shake { 0% { transform: translate(0, 0); } 25% { transform: translate(-5px, 5px); } 50% { transform: translate(5px, -5px); } 75% { transform: translate(-5px, -5px); } 100% { transform: translate(0, 0); } }
        @keyframes float-up { 0% { transform: translateY(0) scale(1); opacity: 1; } 50% { transform: translateY(-30px) scale(1.2); opacity: 1; } 100% { transform: translateY(-60px) scale(1); opacity: 0; } }

        .anim-spawn { animation: spawn-pop 0.5s ease-out forwards; }
        .anim-damage { animation: damage-shake 0.4s ease-in-out; }
        .anim-lunge { animation: attack-lunge 0.3s ease-in-out; }
        .anim-screen-shake { animation: screen-shake 0.3s ease-in-out; }

        .floating-text {
            position: absolute; left: 50%; top: 40%; transform: translateX(-50%);
            font-weight: bold; font-size: 1.5em; pointer-events: none;
            text-shadow: 2px 2px 0 #000; z-index: 100;
            animation: float-up 1s ease-out forwards;
        }

        /* Text Styles */
        .damage-text { color: #ff5252; font-weight: bold; }
        .crit-text { color: #ff0000; font-size: 1.2em; font-weight: bold; text-shadow: 0 0 5px #fff; }
        .heal-text { color: #69f0ae; }
        .gold-text { color: #ffd700; }
        .block-text { color: #2196f3; font-weight: bold; }
        .pierce-text { color: #ff9800; font-weight: bold; }
        .angel-text { color: var(--buff-angel); font-weight: bold; }
        .demon-text { color: var(--buff-demon); font-weight: bold; }
        .mythic-text { color: var(--mythic); font-weight: bold; text-shadow: 0 0 5px #fff; }

        /* Controls */
        #controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button { padding: 12px; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 1em; font-weight: bold; transition: 0.2s; background: #444; color: white; }
        button:hover { background: #555; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent-color); color: #000; }
        .btn-primary:hover { background: #ffb74d; }
        
        /* Inventory */
        #inventory-section { background: #222; padding: 10px; border-radius: var(--border-radius); }
        body.inferno-mode #inventory-section { background: #220000; }

        .equipment-slots { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #444; }
        .equip-row { display: flex; gap: 5px; }
        .equip-slot { flex: 1; background: #333; padding: 8px; border-radius: 4px; text-align: center; font-size: 0.75em; min-height: 40px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #444; }
        body.inferno-mode .equip-slot { background: #331111; border-color: #550000; }
        
        /* é è¨­ï¼ˆé›»è…¦ç‰ˆï¼‰ï¼šç¶­æŒ 4 æ¬„ï¼Œè®“å¯¬è¢å¹•å¯ä»¥ä¸€åˆ—çœ‹å®Œ */
.inv-container { 
    display: grid; 
    grid-template-columns: 1fr 1fr 1fr 1fr; 
    gap: 10px; 
}

/* æ‰‹æ©Ÿç‰ˆé©é…ï¼šç•¶è¢å¹•å¯¬åº¦å°æ–¼ 600px æ™‚ï¼Œè‡ªå‹•æ”¹ç‚º 2 æ¬„ */
@media screen and (max-width: 600px) {
    .inv-container {
        grid-template-columns: 1fr 1fr; /* æ”¹ç‚ºä¸€åˆ—åªé¡¯ç¤º 2 å€‹åˆ†é¡ */
    }
    
    /* é¡å¤–å„ªåŒ–ï¼šè®“æ¨™é¡Œå­—é«”åœ¨æ‰‹æ©Ÿä¸Šç¨å¾®ç¸®å°ï¼Œé¿å…æ“ å£“ */
    .inv-col h4 {
        font-size: 0.85em;
        white-space: nowrap; /* å¼·åˆ¶æ¨™é¡Œæ–‡å­—ä¸æ›è¡Œ */
    }
}
        .inv-col h4 { margin: 0 0 5px 0; font-size: 0.85em; color: #888; text-align: center; border-bottom: 1px solid #444; padding-bottom: 3px; }
        .item-list { display: flex; flex-direction: column; gap: 4px; max-height: 200px; overflow-y: auto; min-height: 50px; background: #2a2a2a; padding: 5px; border-radius: 4px; }
        body.inferno-mode .item-list { background: #1a0505; }
        
        .item { padding: 4px 8px; background: #333; border-radius: 3px; font-size: 0.8em; cursor: pointer; border: 1px solid transparent; display: flex; align-items: center; gap: 5px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        body.inferno-mode .item { background: #331111; }
        .item:hover { background: #444; }

        /* Rarity */
        .rarity-common { color: var(--common); border-color: #555; }
        .rarity-uncommon { color: var(--uncommon); border-color: var(--uncommon); }
        .rarity-rare { color: var(--rare); border-color: var(--rare); }
        .rarity-epic { color: var(--epic); border-color: var(--epic); box-shadow: 0 0 5px var(--epic); }
        .rarity-legendary { color: var(--legendary); border-color: var(--legendary); box-shadow: 0 0 8px var(--legendary); background: linear-gradient(45deg, #333, #443300); animation: shine 2s infinite linear; }
        .rarity-mythic { color: var(--mythic); border-color: var(--mythic); box-shadow: 0 0 15px var(--mythic); background: #220011; animation: shine 1s infinite linear; }
        .rarity-ultra { color: var(--ultra); border-color: var(--ultra); box-shadow: 0 0 20px var(--ultra); background: #001122; animation: shine 0.5s infinite linear; }
        
        @keyframes shine { 0% { border-color: var(--legendary); } 50% { border-color: #fff; } 100% { border-color: var(--legendary); } }

        /* Merchant & Crafting */
        .merchant-grid, .craft-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        .merchant-item, .craft-item { display: flex; flex-direction: column; background: #333; padding: 10px; border-radius: 4px; cursor: pointer; border: 1px solid #444; }
        .merchant-item:hover, .craft-item:hover { background: #444; }
        .m-top { display: flex; justify-content: space-between; font-weight: bold; }
        .m-desc { font-size: 0.8em; color: #aaa; margin-top: 4px; }

        /* Crafting Table */
        #crafting-area { width: 100%; max-height: 300px; overflow-y: auto; }
        .craft-req { color: #888; font-size: 0.85em; margin-top: 3px; }
        .craft-req.ok { color: #4caf50; }
        .craft-req.no { color: #f44336; }

        /* Modals */
        #class-modal, #achieve-modal, #compendium-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        /* JS will toggle display flex */

        .class-options { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; width: 100%; padding: 20px; max-height: 90vh; overflow-y: auto; }
        .class-card {
            background: #333; padding: 20px; border-radius: 8px; cursor: pointer;
            border: 2px solid #555; text-align: center; transition: 0.2s;
        }
        .class-card:hover { border-color: var(--accent-color); background: #444; transform: translateY(-5px); }
        .class-title { font-size: 1.2em; font-weight: bold; color: var(--accent-color); margin-bottom: 10px; }
        .class-desc { font-size: 0.9em; color: #ccc; }

        /* Achievements & Compendium */
        .achieve-list, .compendium-container { max-height: 70vh; overflow-y: auto; width: 90%; max-width: 600px; background: #222; padding: 20px; border-radius: 8px; border: 1px solid #444; }
        .achieve-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; opacity: 0.5; }
        .achieve-item.unlocked { opacity: 1; background: #2a2a2a; }
        .achieve-info { display: flex; flex-direction: column; }
        .achieve-name { font-weight: bold; font-size: 1.1em; }
        .achieve-cond { font-size: 0.8em; color: #aaa; }
        .achieve-badge { padding: 2px 6px; border-radius: 4px; font-size: 0.8em; font-weight: bold; }

        .compendium-tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab-btn { background: #333; border: 1px solid #555; padding: 5px 15px; cursor: pointer; color: #888; }
        .tab-btn.active { background: #555; color: white; border-color: var(--accent-color); }

        .compendium-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; padding-top: 10px; }
        .c-item { 
            background: #333; border: 1px solid #444; border-radius: 4px; padding: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            text-align: center; cursor: help; min-height: 80px; position: relative;
        }
        .c-item.unlocked { background: #2d2d2d; }
        .c-item.unknown { background: #222; border-color: #333; opacity: 0.7; filter: grayscale(100%); }
        .c-item.secret-hidden { background: #000; border-color: #000; cursor: default; }
        
        .c-icon { font-size: 2em; margin-bottom: 5px; }
        .c-name { font-size: 0.75em; line-height: 1.2; word-break: break-all; }
        .c-item.unknown .c-name { color: #666; }

        .hidden { display: none !important; }

/* --- é­…é­”è‰è‰çµ² CSS Art (æå–è‡ª è‰è‰çµ².htm) --- */
        /* è®Šæ•¸è¨­å®š */
        .demon-wrapper {
            --skin-color: #ffcdd8;
            --hair-color: #3d2b3d;
            --shadow-color: rgba(0,0,0,0.1);
            
            /* [ä¿®æ­£] ä½¿ç”¨ç›¸å°å®šä½å®¹å™¨ï¼Œå–æ¶ˆ flex ä»¥é¿å…æ’ç‰ˆæ¨æ“  */
            width: 100px; 
            height: 100px;
            position: relative; 
            margin: 0 auto; /* ç¢ºä¿ wrapper æœ¬èº«å±…ä¸­ */
            overflow: visible;
pointer-events: none;
        }

        .demon-container * {
            position: absolute;
            box-sizing: border-box;
        }

        .demon-container {
            /* [ä¿®æ­£] æ”¹ç‚ºçµ•å°å®šä½ï¼Œå¼·åˆ¶ç½®ä¸­ */
            position: absolute;
            width: 300px;
            height: 350px;
            
            /* çµ•å°ç½®ä¸­æŠ€å·§ */
            left: 50%;
            top: 50%;
            margin-left: -150px; /* å¯¬åº¦çš„ä¸€åŠ */
            margin-top: -175px;  /* é«˜åº¦çš„ä¸€åŠ */
            
            /* ç¸®æ”¾ */
            transform: scale(0.25); 
            transform-origin: center center; /* å¾ä¸­å¿ƒç¸®æ”¾ */
            
            /* å¾®èª¿å‚ç›´ä½ç½® (å¦‚æœè¦ºå¾—å¤ªé«˜æˆ–å¤ªä½å¯ä»¥æ”¹é€™è£¡) */
            top: 60%; 
        }

        /* --- 1. é›™é¦¬å°¾ --- */
        .twin-tail { width: 35px; height: 170px; background: var(--hair-color); top: 120px; z-index: 0; border-radius: 20px; }
        .twin-tail.left { left: 45px; transform-origin: top right; transform: rotate(20deg); }
        .twin-tail.right { right: 45px; transform-origin: top left; transform: rotate(-20deg); }

        /* --- 2. å°¾å·´ --- */
        .tail { width: 120px; height: 100px; top: 220px; left: 150px; z-index: 2; }
        .tail-curve { width: 80px; height: 80px; border-radius: 50%; border: 8px solid transparent; border-bottom-color: var(--hair-color); border-right-color: var(--hair-color); transform: rotate(45deg); }
        .tail-tip { width: 25px; height: 25px; background: var(--hair-color); bottom: -5px; right: -15px; transform: rotate(45deg); border-radius: 3px; }

        /* --- 3. èº«é«” --- */
        .body-shape { width: 90px; height: 100px; background: var(--hair-color); top: 200px; left: 105px; border-radius: 50% 50% 40% 40% / 60% 60% 30% 30%; z-index: 5; }
        .collar { width: 40px; height: 20px; background: #fff; top: 0px; left: 25px; border-radius: 0 0 50% 50%; }

        /* --- 4. å°æ‰‹æ‰‹ --- */
        .hands { top: 215px; left: 105px; width: 90px; height: 30px; z-index: 6; }
        .hand { width: 30px; height: 30px; background: var(--skin-color); border-radius: 50%; top: 0; box-shadow: 0 2px 5px var(--shadow-color); }
        .hand.left { left: -15px; }
        .hand.right { right: -15px; }

        /* --- 5. é ­éƒ¨ --- */
        .head { width: 180px; height: 170px; background: var(--skin-color); border-radius: 50% 50% 45% 45% / 55% 55% 45% 45%; top: 50px; left: 60px; z-index: 10; box-shadow: 0 5px 15px var(--shadow-color); }
        .hair-bangs { width: 190px; height: 80px; background: var(--hair-color); top: -10px; left: -5px; border-radius: 50% 50% 20% 20% / 70% 70% 30% 30%; z-index: 11; }
        .hair-side { width: 50px; height: 100px; background: var(--hair-color); top: 50px; z-index: 9; }
        .hair-side.left { left: -10px; border-radius: 50% 0 0 50%; transform: rotate(5deg); }
        .hair-side.right { right: -10px; border-radius: 0 50% 50% 0; transform: rotate(-5deg); }
        .horn { width: 35px; height: 55px; background: var(--hair-color); top: -35px; z-index: 8; }
        .horn.left { left: 30px; border-radius: 100% 0 0 0; transform: rotate(-15deg); }
        .horn.right { right: 30px; border-radius: 0 100% 0 0; transform: rotate(15deg); }
    </style>
</head>
<body>

<div id="rebirth-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:400; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#111; padding:30px; border-radius:8px; width:90%; max-width:500px; text-align:center; border: 2px solid #00ffcc; box-shadow: 0 0 30px rgba(0, 255, 204, 0.2);">
        <div style="font-size:3em; margin-bottom:10px;">â³</div>
        <h2 style="color:#00ffcc; margin:0 0 10px 0;">è¼ªè¿´çš„æŠ‰æ“‡</h2>
        <p style="color:#ccc; margin-bottom:20px; line-height:1.6;">
            æ™‚å…‰å€’æµï¼Œä¸€åˆ‡æ­¸é›¶ã€‚<br>
            ä½ åªèƒ½é¸æ“‡ <span style="color:#fff; font-weight:bold;">ä¸€ä»¶é£¾å“</span> å¸¶å…¥ä¸‹ä¸€å€‹è¼ªè¿´ã€‚<br>
            <span style="font-size:0.8em; color:#888;">(å…¶é¤˜æ‰€æœ‰è£å‚™ã€é“å…·ã€é‡‘å¹£èˆ‡èƒ½åŠ›å€¼å°‡è¢«é‡ç½®)</span>
        </p>
        
        <div id="rebirth-list" style="max-height:300px; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap:10px; padding:10px; background:#222; border-radius:4px; margin-bottom:20px;">
            </div>

        <button onclick="Game.executeRebirth(null)" style="background:#d32f2f; width:100%; padding:15px; border:1px solid #555;">ä»€éº¼éƒ½ä¸å¸¶ï¼Œç›´æ¥é–‹å§‹</button>
        <button onclick="document.getElementById('rebirth-modal').style.display='none'" style="background:#555; width:100%; margin-top:10px; padding:10px;">å–æ¶ˆ</button>
    </div>
</div>




<div id="class-modal"> 
    <h2 style="color:white; margin-bottom: 30px;">é¸æ“‡ä½ çš„è·æ¥­</h2> <div class="class-options">
        <div class="class-card" onclick="Game.selectClass('knight')">
            <div class="class-title">ğŸ›¡ï¸ é¨å£«</div>
            <div class="class-desc">é–‹å±€è£å‚™ã€Œé¨å£«é•·æ§ã€<br>çˆ†æ“Šå¼·åŒ–ç‚ºã€Œæ¸¾èº«ä¸€æ“Šã€ (3å€å‚·å®³)</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('merchant')">
            <div class="class-title">ğŸ’° å•†è²©</div>
            <div class="class-desc">å‡ºå”®åƒ¹æ ¼ 1.2 å€<br>å•†åº—å¯è³¼è²· 6 é …å•†å“</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('thief')">
            <div class="class-title">ğŸ—¡ï¸ ç›œè³Š</div>
            <div class="class-desc">é–‹å•Ÿå¯¶ç®±æ™‚<br>ä¸æœƒé‡åˆ°é™·é˜±æˆ–ç©ºç®±</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('cultist')">
            <div class="class-title">ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’</div>
            <div class="class-desc">é–‹å±€è‡ªå¸¶<br>ä¸€å€‹æƒ¡é­”è©›å’’</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('scarecrow')">
            <div class="class-title">ğŸŒ¾ ç¨»è‰äºº</div>
            <div class="class-desc">é­é‡å“ˆæ¯”æ™‚<br>å¿…å®šå°‡å…¶è¶•èµ°</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('ape')">
            <div class="class-title">ğŸ¦ äººçŒ¿</div>
            <div class="class-desc">é­é‡è·Œå€’äº‹ä»¶<br>å¿…å®šæŠ“ä½å²©å£</div>
        </div>
        <div class="class-card" onclick="Game.selectClass('challenger')">
            <div class="class-title">ğŸ§— æŒ‘æˆ°è€…</div>
            <div class="class-desc">ç„¡ä»»ä½•ç‰¹æ®ŠæŠ€èƒ½<br>é–‹å±€ç²å¾—ä¸€ç“¶ã€Œå¼·åŠ›è—¥æ°´ã€</div>
        </div>
<div class="class-card" onclick="Game.selectClass('dragonslayer')">
            <div class="class-title">ğŸ‰ å± é¾è€…</div>
            <div class="class-desc">é–‹å±€è£å‚™ã€Œå± é¾åˆ€ã€èˆ‡ã€Œé¾é±—é§ç”²ã€</div>
        </div>
    </div>
</div>

<div id="achieve-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ† æˆå°±åˆ—è¡¨</h2>
        <button onclick="document.getElementById('achieve-modal').style.display='none'" style="background:#555;">é—œé–‰</button>
    </div>
    <div id="achieve-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="achieve-list" id="achieve-list-content"></div>
</div>

<div id="compendium-modal">
    <div style="width:90%; max-width:600px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="color:white; margin:0;">ğŸ“– ç‰©å“åœ–é‘‘</h2>
        <button onclick="document.getElementById('compendium-modal').style.display='none'" style="background:#555;">é—œé–‰</button>
    </div>
    <div class="compendium-tabs">
        <button class="tab-btn active" onclick="Game.switchCompendiumTab('items')">ä¸€èˆ¬ç‰©å“</button>
        <button class="tab-btn" onclick="Game.switchCompendiumTab('accessories')">é£¾å“</button>
        <button class="tab-btn" onclick="Game.switchCompendiumTab('inferno')">ç…‰ç„ç¥è©±</button>
    </div>
    <div id="compendium-stats" style="color:#aaa; margin-bottom:10px;"></div>
    <div class="compendium-container">
        <div class="compendium-grid" id="compendium-content"></div>
    </div>
</div>

<div id="credits-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:200; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:90%; max-width:400px; background:#222; padding:30px; border-radius:8px; border:1px solid #444; text-align:center; box-shadow: 0 0 20px rgba(0,0,0,0.8);">
        <h2 style="color:white; margin:0 0 15px 0;">ğŸ‘¨â€ğŸ’» ä½œè€…åå–®</h2>
        <p style="color:#ccc; margin-bottom:25px; line-height: 1.5;">
            æ„Ÿè¬éŠç©ã€Šå¹»æƒ³å†’éšªã€‹ï¼<br>æ­¡è¿é—œæ³¨æˆ‘çš„ç¤¾ç¾¤ä»¥ç²å¾—æœ€æ–°è³‡è¨Šã€‚
        </p>
        <div style="display:flex; flex-direction:column; gap:15px;">
            <a href="https://www.threads.net/@kanda_shota_art?igshid=NTc4MTIwNjQ2YQ==" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#111; color:#fff; border:1px solid #333; font-size:1em; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>â—‰</span> Threads (@kanda_shota_art)
                </button>
            </a>
            <a href="https://x.com/shota_at_?s=21" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#000; color:#fff; border:1px solid #333; font-size:1em; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>ğ•</span> Twitter (X)
                </button>
            </a>
            <a href="https://www.buymeacoffee.com/maker.shota" target="_blank" style="text-decoration:none;">
                <button style="width:100%; padding:15px; background:#FFDD00; color:#000; border:none; font-size:1em; font-weight:bold; display:flex; align-items:center; justify-content:center; gap:10px;">
                    <span>âš”ï¸</span> è´ŠåŠ©æˆ‘å‰é€²
                </button>
            </a>
        </div>
        <button onclick="document.getElementById('credits-modal').style.display='none'" style="margin-top:25px; background:#555; width: 100%;">é—œé–‰</button>
    </div>
</div>
    
<div id="portable-crafting-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:350; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:95%; max-width:500px; max-height:80vh; display:flex; flex-direction:column; border: 2px solid #aaa; box-shadow: 0 0 20px rgba(255,255,255,0.15);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <h3 style="color:#e0e0e0; margin:0;">ğŸ§° æ”œå¸¶å¼å·¥ä½œæª¯</h3>
            <button onclick="document.getElementById('portable-crafting-modal').style.display='none'" style="background:#555; padding:5px 15px;">é—œé–‰</button>
        </div>
        <div style="margin-bottom:10px; color:#888; font-size:0.9em; text-align:center;">(ä¾¿æ”œæ¨¡å¼ï¼šåƒ…èƒ½è£½ä½œä¸€èˆ¬é£¾å“)</div>
        <div id="portable-craft-content" style="flex:1; overflow-y:auto;"></div>
    </div>
</div>

<div id="inventory-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:300; flex-direction:column; align-items:center; justify-content:center;">
    <div style="width:90%; max-width:600px; max-height:80vh; background:#222; border:1px solid #444; border-radius:8px; display:flex; flex-direction:column; padding:20px; box-shadow:0 0 30px rgba(0,0,0,0.5);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
            <h3 id="inv-modal-title" style="margin:0; color:#e0e0e0;">èƒŒåŒ…å…§å®¹</h3>
            <button onclick="document.getElementById('inventory-modal').style.display='none'" style="background:#555; padding:5px 15px;">é—œé–‰</button>
        </div>
        <div id="inv-modal-content" style="flex:1; overflow-y:auto; display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px; padding-right:5px;">
            </div>
    </div>
</div>

<div id="sell-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:310; flex-direction:column; align-items:center; justify-content:center;">
    <div style="background:#2d2d2d; padding:20px; border-radius:8px; width:80%; max-width:400px; text-align:center; border: 1px solid #ff9800; box-shadow: 0 0 20px rgba(255, 152, 0, 0.2);">
        <h3 style="color:#ff9800; margin-top:0;">ğŸ’° é¸æ“‡è¦å‡ºå”®çš„åˆ†é¡</h3>
        <p style="color:#aaa; font-size:0.9em; margin-bottom:20px;">(åƒ…å‡ºå”®èƒŒåŒ…ä¸­çš„ç´ æï¼Œä¸å«å—ä¿è­·/ç¥è©±ç‰©å“)</p>
        
        <div id="sell-options-grid" style="display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow-y:auto;">
            </div>

        <button onclick="document.getElementById('sell-modal').style.display='none'" style="margin-top:20px; background:#555; width:100%;">å–æ¶ˆ</button>
    </div>
</div>

<div id="game-container">


<header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div style="font-weight: bold; font-size: 1.2em;">âš”ï¸ å¹»æƒ³å†’éšª</div>
            <button onclick="Game.showAchievements()" style="padding:4px 8px; font-size:0.8em;">ğŸ† æˆå°±</button>
            <button onclick="Game.showCompendium()" style="padding:4px 8px; font-size:0.8em; background:#673ab7;">ğŸ“– åœ–é‘‘</button>
<button onclick="Game.showCredits()" style="padding:4px 8px; font-size:0.8em; background:#ff5722; color:white; margin-left:5px;">ğŸ‘¨â€ğŸ’» ä½œè€…</button>
        </div>
        <div id="class-badge" class="class-badge"></div>
    </header>

    <div class="stats-grid">
        <div class="stat-item">ç”Ÿå‘½: <span id="hp-val">300000000</span> / <span id="max-hp-val">100</span></div>
        <div class="stat-item">æ”»æ“Š: <span id="atk-val">30000000</span></div>
        <div class="stat-item">æš´æ“Š: <span id="crit-val">100</span>%</div> <div class="stat-item">é‡‘å¹£: <span id="gold-val">100</span></div>
        <div class="stat-item">æ·±åº¦: <span id="depth-val">0</span> å±¤</div>
        <div id="buff-display" title="é»æ“ŠæŸ¥çœ‹è©³ç´°æ•ˆæœ">
        <span id="buff-text">ç‹€æ…‹: ç„¡</span>

        <label class="opt-auto-skip" onclick="event.stopPropagation();">
            <input 
                type="checkbox" 
                id="opt-auto-skip-statue" 
                onchange="Game.toggleAutoSkipStatue(this.checked)"
            >
            è‡ªå‹•ç•¥éã€Œç¥ˆç¦±è–åƒã€
        </label>
		</div>	
    </div>



    <div id="event-display">
		<div id="event-inner">
			<div id="event-icon" class="monster-icon">ğŸ²</div>
			<h3 id="event-title">æº–å‚™å†’éšª</h3>
			<div id="event-desc">è«‹å…ˆé¸æ“‡è·æ¥­...</div>
			<div id="merchant-area" class="hidden"></div>
			<div id="crafting-area" class="hidden"></div>
		</div>
    </div>

    <div id="controls">
        <button id="btn-main" class="btn-primary" onclick="Game.nextEvent()">é–‹å§‹å†’éšª</button>
        <button id="btn-sub" onclick="Game.handleSubAction()" disabled>...</button>
    </div>

    <div id="inventory-section">
        <div class="equipment-slots">
            <div class="equip-row">
                <div class="equip-slot" id="slot-weapon" onclick="Game.unequip('weapon')">ç„¡æ­¦å™¨</div>
                <div class="equip-slot" id="slot-armor" onclick="Game.unequip('armor')">ç„¡é˜²å…·</div>
                <div class="equip-slot" id="slot-shield" onclick="Game.unequip('shield')">ç„¡ç›¾ç‰Œ</div>
            </div>
            <div class="equip-row">
                <div class="equip-slot" id="slot-acc1" onclick="Game.unequipAccessory(0)">é£¾å“æ¬„ 1</div>
                <div class="equip-slot" id="slot-acc2" onclick="Game.unequipAccessory(1)">é£¾å“æ¬„ 2</div>
                <div class="equip-slot" id="slot-acc3" onclick="Game.unequipAccessory(2)">é£¾å“æ¬„ 3</div>
            </div>
        </div>
        
<div class="inv-container">
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ“¦ è£å‚™</span>
                    <button onclick="Game.openInventoryModal('equipment')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-equip"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ’ é£¾å“</span>
                    <button onclick="Game.openInventoryModal('accessory')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-acc"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ§ª æ¶ˆè€—</span>
                    <button onclick="Game.openInventoryModal('consumable')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-consum"></div>
            </div>
            <div class="inv-col">
                <h4 style="display:flex; justify-content:space-between; align-items:center;">
                    <span>ğŸ§© ç´ æ</span>
                    <button onclick="Game.openInventoryModal('material')" style="padding:2px 6px; font-size:0.8em; background:#444;">ğŸ”</button>
                </h4>
                <div class="item-list" id="inv-mat"></div>
            </div>
        </div>

    <div style="margin-top: 20px; border-top: 1px solid #444; padding-top: 15px;">
        <button onclick="Game.manualRestart()" style="width: 100%; background: #d32f2f; opacity: 0.8;">ğŸ”„ é‡æ–°é–‹å§‹éŠæˆ²</button>
    </div>
</div>
<script>
const LILITH_HTML = `
<div class="demon-wrapper">
    <div class="demon-container">
        <div class="twin-tail left"></div>
        <div class="twin-tail right"></div>
        <div class="tail"><div class="tail-curve"><div class="tail-tip"></div></div></div>
        <div class="body-shape"><div class="collar"></div></div>
        <div class="hands"><div class="hand left"></div><div class="hand right"></div></div>
        <div class="head">
            <div class="horn left"></div><div class="horn right"></div>
            <div class="hair-bangs"></div>
            <div class="hair-side left"></div><div class="hair-side right"></div>
        </div>
    </div>
</div>`;
const CONFIG = {
    rarityProb: { common: 0.5, uncommon: 0.3, rare: 0.15, epic: 0.04, legendary: 0.01 },
    rarityDisplay: {
        common: { color: "rarity-common", label: "ä¸€èˆ¬", val: 1 },
        uncommon: { color: "rarity-uncommon", label: "å„ªè³ª", val: 2 },
        rare: { color: "rarity-rare", label: "ç¨€æœ‰", val: 3 },
        epic: { color: "rarity-epic", label: "å²è©©", val: 4 },
        legendary: { color: "rarity-legendary", label: "å‚³èªª", val: 5 },
        mythic: { color: "rarity-mythic", label: "ç¥è©±", val: 6 },
        ultra: { color: "rarity-ultra", label: "æ¥µå‚³èªª", val: 7 }
    },
   infernoMonsters: [
        { name: "æš—å½±å²èŠå§†", weight: 20, baseGold: 50, icon: "ğŸŒ‘", hp: 1000, atk: 150, drop: "æš—å½±å‡è† " },
        { name: "è™›ç©ºé­”çœ¼", weight: 20, baseGold: 60, icon: "ğŸ‘ï¸", hp: 2400, atk: 360, drop: "è™›ç©ºä¹‹å¡µ" },
        { name: "ç†”å²©é­”åƒ", weight: 15, baseGold: 100, icon: "ğŸŒ‹", hp: 6000, atk: 400, drop: "ç†”å²©æ ¸å¿ƒ", tier: "normal" },
        { name: "å¤¢é­˜æˆ°é¦¬", weight: 15, baseGold: 120, icon: "ğŸ¦„", hp: 5000, atk: 600, drop: "å¤¢é­˜ä¹‹è§’", tier: "normal" },
        { name: "å¢®è½é¨å£«", weight: 10, baseGold: 300, icon: "ğŸ¤º", hp: 10000, atk: 800, drop: "è…æœ½é§ç”²", tier: "elite" },
        { name: "æ··æ²Œè§¸æ‰‹", weight: 10, baseGold: 350, icon: "ğŸ¦‘", hp: 9000, atk: 900, drop: "æ··æ²Œç¥ç¶“", tier: "elite" },
        { name: "é®®è¡€ä¼¯çˆµ", weight: 4, baseGold: 800, icon: "ğŸ§›", hp: 24000, atk: 1200, drop: "é®®è¡€ç²¾è¯", tier: "boss" },
        { name: "å·«å¦–ç‹", weight: 4, baseGold: 900, icon: "ğŸ’€", hp: 20000, atk: 1400, drop: "å‘½åŒ£ç¢ç‰‡", tier: "boss" },
        { name: "æ·±æ·µé­”é¾", weight: 2, baseGold: 2000, icon: "ğŸ²", hp: 60000, atk: 2000, drop: "é­”é¾é€†é±—", tier: "boss" },
        { name: "èˆŠæ—¥æ”¯é…è€…", weight: 0.1, baseGold: 9999, icon: "ğŸ™", hp: 99999, atk: 9999, drop: "ä¸å¯åç‹€ä¹‹ç‰©", tier: "boss", isOldOne: true }
    ],
    // ç…‰ç„ç¥è©±è£å‚™
    infernoItems: [
        { id: "w_ragnarok", name: "è«¸ç¥é»ƒæ˜", type: "weapon", val: 2000, rarity: "mythic", price: 10000, icon: "â˜„ï¸", desc: "[çœŸå¯¦å‚·å®³] 5% æ©Ÿç‡ä¸€æ“Šå¿…æ®º (å°æ”¯é…è€…èˆ‡ç¥ç„¡æ•ˆ)" },
{ id: "acc_red_cloth", name: "ç´…å¸ƒ", type: "accessory", rarity: "mythic", price: 5000, icon: "ğŸ§£", desc: "[é¬¥ç‰›å£«] æš´æ“Šç‡ +10%ï¼Œé­é‡ç‰›é ­äººè¡æ’æ™‚å¿…å®šå…ç–«" },
        { id: "w_minotaur", name: "ç‰›é ­äººæˆ°æ–§", type: "weapon", val: 3000, rarity: "mythic", price: 8000, icon: "ğŸª“", desc: "[å—œè¡€æˆé•·] æ“Šæ®ºæ•µäººæ™‚ 1% æ©Ÿç‡æ°¸ä¹…æå‡ 3% åŸºç¤æš´æ“Šç‡" },
        { id: "w_soulreaver", name: "å™¬é­‚é®åˆ€", type: "weapon", val: 1500, rarity: "mythic", price: 8000, icon: "â˜ ï¸", desc: "[å¸è¡€] é€ æˆå‚·å®³çš„ 5% è½‰ç‚ºç”Ÿå‘½åŠ›" },
        { id: "a_voidwalker", name: "è™›ç©ºè¡Œè€…æ–—ç¯·", type: "armor", val: 3000, rarity: "mythic", price: 9000, icon: "ğŸ‘»", desc: "[çµ•å°è¿´é¿] æ•µæ–¹æ”»æ“Šæœ‰ 10% æ©Ÿç‡è½ç©º" },
        { 
            id: "acc_wheel", 
            name: "å‘½é‹ä¹‹è¼ª", 
            type: "accessory", 
            rarity: "mythic", 
            price: 12000, 
            icon: "ğŸ¡", 
            // [ä¿®æ”¹] æè¿°æ”¹ç‚º æ¯ 20%
            desc: "[æš´æ“Šçªç ´] æš´æ“Šç‡æ­¸0è½‰åŒ–ç‚ºå‚·å®³å€ç‡ (æ¯ 20% æš´ç‡æå‡ 1 å€å‚·å®³)" 
        },
        { id: "acc_chaos", name: "æ··æ²Œé­”æ–¹", type: "accessory", rarity: "mythic", price: 15000, icon: "ğŸ²", desc: "[éš¨æ©Ÿå€ç‡] è£å‚™æ™‚éª°å‡º 0.5~3.0 å€æ”»æ“Šå€ç‡" },
        { id: "c_harpy_blood", name: "å“ˆæ¯”è¡€", type: "consumable", val: 500, rarity: "mythic", price: 500, icon: "ğŸ·", desc: "æ¢å¾© 500 é»ç”Ÿå‘½" },
        { id: "c_pure_blood", name: "æ·¨åŒ–è¡€", type: "consumable", val: 99999, rarity: "mythic", price: 2000, icon: "âœ¨", desc: "å®Œå…¨æ¢å¾©ç”Ÿå‘½" },
{ id: "w_doom", name: "ç ´æ»…å¤§åŠ", type: "weapon", val: 3000, rarity: "mythic", price: 20000, icon: "ğŸ—¡ï¸", desc: "å–®ç´”ä¸”æ¥µè‡´çš„ç ´å£åŠ› (æ”»æ“ŠåŠ› 3000)" },

{ 
            id: "s_demon_wall", 
            name: "é­”ç¥ä¹‹å£", 
            type: "shield", 
            val: 10, 
            rarity: "mythic", 
            price: 25000, 
            icon: "ğŸ›¡ï¸", 
            desc: "[çµ•å°é˜²ç¦¦] ä¾†è‡ªåœ°ç„çš„é»‘æ›œçŸ³å·¨ç›¾ï¼Œå¯æŠµæ“‹ 10 æ¬¡æ”»æ“Š" 
        },
        { id: "a_apocalypse", name: "æœ«ä¸–ä¹‹é§", type: "armor", val: 1000, rarity: "mythic", price: 20000, icon: "ğŸ›¡ï¸", desc: "[åå™¬ç”Ÿå‘½] æ”»æ“Šæ™‚ 1% æ©Ÿç‡æ°¸ä¹…å¢åŠ  100 é»åŸºç¤ç”Ÿå‘½" },

// --- è«‹è£œä¸Šé€™å…©æ®µ ---
    { 
        id: "acc_transcendence", 
        name: "è¶…è¶Šé­”æ–¹", 
        type: "accessory", 
        rarity: "mythic", 
        price: 30000, 
        icon: "ğŸ§Š", 
        desc: "[è¶…è¶Šæ¥µé™] æ¯å›åˆéš¨æ©Ÿéª°å‡º 1.0~5.0 å€æ”»æ“Šå€ç‡ (èˆ‡æ··æ²Œç–ŠåŠ )" 
    },
    { 
        id: "w_void_breaker", 
        name: "è™›ç©ºç ´æ»…åŠ", 
        type: "weapon", 
        val: 2000, 
        rarity: "mythic", 
        price: 30000, 
        icon: "ğŸŒŒ", 
        desc: "[éˆé­‚åå™¬] æ“Šæ®ºæ•µäººæ™‚ 10% æ©Ÿç‡æ°¸ä¹…å¢åŠ  100 é»åŸºç¤æ”»æ“ŠåŠ›" 
    },
{ 
    id: "w_primordial", 
    name: "åŸåˆä¹‹åŠ", 
    type: "weapon", 
    val: 33333, 
    rarity: "ultra", 
    price: 99999, 
    icon: "âš”ï¸", 
    desc: "[åŸåˆä¹‹åŠ›] æ”»æ“ŠåŠ›x1.5ï¼Œä¸”æ”»æ“Šç„¡è¦–ç¥ä¹‹ä»£è¡Œè€…çš„ã€è–æ½”åŠ›å ´ã€‘(å‚·å®³ä¸Šé™ç„¡æ•ˆ)" 
},
// [æ–°å¢] ç…‰ç„çˆå·è»¸
        { 
            id: "c_inferno_scroll", 
            name: "ç…‰ç„çˆå·è»¸", 
            type: "consumable", 
            rarity: "mythic", 
            price: 5000, 
            icon: "ğŸ“œ", 
            desc: "éš¨æ™‚éš¨åœ°å¬å–šç…‰ç„çˆç« (æ¶ˆè€—å“)" 
        }
    
    ],
    // --- [NEW] ä¸ƒå®—ç½ªæ–°å¢è³‡æ–™ ---
   sinItems: [
    { id: "acc_pride", name: "å‚²æ…¢ä¹‹çœ¼", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ¦", desc: "[å‚²æ…¢] æ”»æ“ŠåŠ› +100%ï¼Œä½†æ‰€å—å‚·å®³ +50%" },
    { id: "acc_envy", name: "å«‰å¦’é­”ç›’", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ¦Š", desc: "[å«‰å¦’] æ”»æ“Šæ™‚ 10% æ©Ÿç‡å®Œå…¨æ¢å¾©ç”Ÿå‘½" },
    { id: "acc_wrath", name: "æš´æ€’æŒ‡è™", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ˜¡", desc: "[æš´æ€’] æ”»æ“ŠåŠ› +1000ï¼Œä¸”æ”»æ“Šæ™‚ 10% æ©Ÿç‡é€ æˆå…©æ¬¡å‚·å®³" },
    { id: "acc_sloth", name: "çœ æˆ’", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ’¤", desc: "[æ€ æƒ°] é€ƒè·‘å¤±æ•—æ™‚å—åˆ°çš„å‚·å®³æ¸›å°‘ 50%" },
    { id: "acc_greed", name: "é‡‘è‰²è–åƒ", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ·", desc: "[è²ªå©ª] æ“Šæ®ºæ€ªç‰©ç²å¾—é‡‘å¹£ +100%" },
    { id: "acc_gluttony", name: "æš´é£Ÿä¹‹ç‰™", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ²", desc: "[æš´é£Ÿ] æ¯æ¬¡æ”»æ“Šæ¢å¾© 10% æœ€å¤§ç”Ÿå‘½" },
    { id: "acc_lust", name: "é­…é­”é¦™æ°´", type: "accessory", rarity: "mythic", price: 25000, icon: "ğŸ‘™", desc: "[è‰²æ…¾] æ¯å ´æˆ°é¬¥ç¬¬ä¸€æ¬¡æ”»æ“Šå¿…å®šæš´æ“Š" },
    { id: "m_crown_sin", name: "åŸç½ªä¹‹å† ", type: "material", rarity: "ultra", price: 99999, icon: "ğŸ‘‘", desc: "[çµ‚æ¥µ] é›†é½Šä¸ƒå®—ç½ªçš„è­‰æ˜ï¼Œå¯å¬å–šçœŸç¥ã€‚" }
],

specialItems: {
        chocolate: { name: "å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›", type: "material", rarity: "epic", icon: "ğŸ«", desc: "æ•£ç™¼è‘—é­”åŠ›çš„å·§å…‹åŠ›ï¼Œç„¡æ³•é£Ÿç”¨ã€‚" },
        note: { name: "ç´™æ¢", type: "material", rarity: "mythic", icon: "ğŸ“„", desc: "ä¸Šé¢å¯«è‘—é­…é­”çš„çœŸåã€‚(é‡è¦é“å…·)" },
        holy_sword: { name: "ç¥è–å…‰åŠ", type: "weapon", val: 1000, rarity: "mythic", price: 0, icon: "âš”ï¸", desc: "è‰è‰çµ²è´ˆé€çš„ç¥å™¨ã€‚" },

        
        hourglass: { 
        name: "è¼ªè¿´æ²™æ¼", 
        type: "consumable", // é€™è£¡å»ºè­°ä¿æŒ consumable æˆ–æ”¹ç‚º special
        rarity: "ultra", 
        icon: "â³", 
        desc: "ç™¼å‹•å¾Œé‡ç½®éŠæˆ²è‡³åˆå§‹ç‹€æ…‹ (ç­‰ç´š/é‡‘å¹£/ç‰©å“æ­¸é›¶)ï¼Œä½†å¯é¸æ“‡ä¸€ä»¶é£¾å“ç¹¼æ‰¿ã€‚", 
        price: 0 
    },
},

forgeItems: [
        { 
            id: "acc_shadow", name: "æš—å½±æ›¿èº«", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ‘¤", 
            desc: "[æµé«”è¿´é¿] 10% æ©Ÿç‡ç„¡æ•ˆåŒ–å‚·å®³ä¸¦åæ“Š (10% é˜²ç¦¦åŠ›)",
            recipe: { mat: "æš—å½±å‡è† ", count: 10 }
        },
        { 
            id: "shield_void", name: "è™›ç©ºä¹‹é¡", type: "shield", 
            val: 2, 
            rarity: "mythic", price: 20000, icon: "ğŸª", 
            // [ä¿®æ”¹] æè¿°æ›´æ–°ç‚º åå½ˆ 50%
            desc: "[è¦–ç·šæŠ˜å°„] å¯æ“‹æš´æ“Šï¼Œ70% æ©Ÿç‡ä¸æ¶ˆè€—è€ä¹…ï¼Œåå½ˆ 50% å‚·å®³",
            recipe: { mat: "è™›ç©ºä¹‹å¡µ", count: 10 }
        },
        { 
            id: "armor_magma", name: "åœ°å¿ƒç†”çˆé§", type: "armor", val: 2000, rarity: "mythic", price: 20000, icon: "ğŸŒ‹", 
            desc: "[éç†±åæ‡‰] å—å‚·-20%ã€‚å›åˆé–‹å§‹é›™æ–¹å„æ‰£ 5% HP (è‡ªèº«Max, æ•µæ–¹Current)",
            recipe: { mat: "ç†”å²©æ ¸å¿ƒ", count: 10 }
        },
        { 
            id: "w_nightmare", name: "å¤¢é­˜ç©¿åˆºè€…", type: "weapon", val: 1500, rarity: "mythic", price: 20000, icon: "ğŸ¦„", 
            desc: "[ææ‡¼è¡é‹’] é¦–å›åˆæ”»æ“Š +100%ã€‚è‹¥æœªæ“Šæ®ºï¼Œä¸‹å›åˆæšˆçœ©",
            recipe: { mat: "å¤¢é­˜ä¹‹è§’", count: 10 }
        },
        { 
            id: "acc_dead", name: "äº¡è€…é …éŠ", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ’€", 
            desc: "[äº¡è€…æ€¨å¿µ] æ­»äº¡æ™‚é€²å…¥éˆé­‚å‹æ…‹ 3 å›åˆ (æ”»x2)ï¼Œæ“Šæ®ºå‰‡å¾©æ´»",
            recipe: { mat: "è…æœ½é§ç”²", count: 10 }
        },
        { 
            id: "w_chaos", name: "ç†æ™ºé­ç¬", type: "weapon", val: 0, rarity: "mythic", price: 20000, icon: "ğŸ¦‘", 
            desc: "[æ€ç¶­æ±¡æŸ“] æ”»æ“Š 500~5000ã€‚10% æ©Ÿç‡æ··äº‚æ•µäºº",
            recipe: { mat: "æ··æ²Œç¥ç¶“", count: 10 }
        },
        { 
            id: "acc_blood", name: "è¡€ä¹‹å¥‘ç´„æ›¸", type: "accessory", rarity: "mythic", price: 20000, icon: "ğŸ“œ", 
            desc: "[é®®è¡€è½‰åŒ–] MaxHP æ¸›åŠï¼Œæ¸›å°‘å€¼è½‰ç‚ºæ”»æ“Šã€‚ç„¡æ³•ä½¿ç”¨è—¥æ°´",
            recipe: { mat: "é®®è¡€ç²¾è¯", count: 10 }
        },
        { 
            id: "acc_phylactery", name: "æ°¸ç”Ÿè­·ç¬¦", type: "accessory", rarity: "mythic", price: 20000, icon: "âš±ï¸", 
            desc: "[å‘½åŒ£å„²å­˜] æ“Šæ®ºå­˜é­‚ (Max 200)ã€‚è‡´æ­»æ™‚è€— 50 é­‚å¾©æ´» 50% HP",
            recipe: { mat: "å‘½åŒ£ç¢ç‰‡", count: 10 }
        },
        { 
            id: "armor_dragon", name: "é€†é±—é¾è£", type: "armor", val: 4000, rarity: "mythic", price: 20000, icon: "ğŸ‰", 
            desc: "[é¾ä¹‹æ€’] è¢«æš´æ“Šæ™‚ 10% æ©Ÿç‡æ–¬æ®º (å°ç¥ä¹‹ä»£è¡Œè€…ç„¡æ•ˆ)",
            recipe: { mat: "é­”é¾é€†é±—", count: 10 }
        },
        
        { 
            id: "w_oldone", name: "æ»…ä¸–ä¹‹æ§", type: "weapon", val: 5000, rarity: "mythic", price: 50000, icon: "ğŸ”±", 
            desc: "[æ”¯é…è€…] 50% æ©Ÿç‡æ”¯é…æ•µäºº (DoT 20, 100% æ‰è½)",
            recipe: { mat: "ä¸å¯åç‹€ä¹‹ç‰©", count: 5 }
        }
    ],


    sinBuffs: {
        sloth_curse: { id: 'sloth_curse', name: 'ğŸ’¤ æ‡¶æƒ°çš„è©›å’’', type: 'debuff', desc: 'ç„¡æ³•æ”»æ“Šï¼Œåªèƒ½é€ƒè·‘ (å‰©é¤˜ 10 å ´)' },
        greed_shackle: { id: 'greed_shackle', name: 'â›“ï¸ é»ƒé‡‘æ·é–', type: 'debuff', desc: 'æ•æ·ä¸‹é™ï¼Œå—å‚·å¢åŠ  20% (éœ€æ‰¾æƒ¡é­”å•†äººæ¶ˆé™¤)' },
        lust_charm: { id: 'lust_charm', name: 'ğŸ’‹ åªšæ°£ç’°ç¹', type: 'debuff', desc: 'æ¯æ¬¡é­é‡äº‹ä»¶æ‰£é™¤ 10% æœ€å¤§ç”Ÿå‘½' }
    },
    sinMonsters: [
        { name: "é¡åƒ", icon: "ğŸ‘¤", hp: 1, atk: 1, drop: "", tier: "boss" }, // æ•¸å€¼å‹•æ…‹ç”Ÿæˆ
        { name: "ç‹‚æˆ°å£«", icon: "â›“ï¸", hp: 40000, atk: 1000, drop: "", tier: "boss" },
        { name: "é»ƒé‡‘å·¨åƒ", icon: "ğŸ—½", hp: 1, atk: 1000, drop: "", tier: "boss" } // HP å‹•æ…‹ç”Ÿæˆ
    ],
    // ---------------------------
   accessories: {
        // --- å²èŠå§†ç³»åˆ— ---
        acc_slime_1: { id: 'acc_slime_1', name: "å‡è† æˆ’æŒ‡", type: 'accessory', rarity: 'common', price: 100, icon: "âšª", desc: "æ¯«ç„¡ç”¨è™•", recipe: {mat: "å²èŠå§†é»æ¶²", count: 10} },
        acc_slime_2: { id: 'acc_slime_2', name: "ç²¾è¯è­·èº«ç¬¦", type: 'accessory', rarity: 'rare', price: 500, icon: "ğŸ”µ", desc: "æ¯æ¬¡äº‹ä»¶å›å¾© 2 é»ç”Ÿå‘½", recipe: {mat: "å²èŠå§†ç²¾è¯", count: 10} },
        acc_slime_3: { id: 'acc_slime_3', name: "é»æ¶²çš‡å† ", type: 'accessory', rarity: 'epic', price: 2000, icon: "ğŸŸ ", desc: "æ¯æ¬¡äº‹ä»¶å›å¾© 10 é»ç”Ÿå‘½", recipe: {mat: "å²èŠå§†ç‹å† ", count: 5} },
        
        // --- å“¥å¸ƒæ—ç³»åˆ— ---
        acc_gob_1: { id: 'acc_gob_1', name: "ç ´å¸ƒèƒŒåŒ…", type: 'accessory', rarity: 'common', price: 150, icon: "âšª", desc: "é‡‘å¹£ç²å–é‡ +5% (éå•†äºº)", recipe: {mat: "ç ´å¸ƒ", count: 10} },
        acc_gob_2: { id: 'acc_gob_2', name: "é‡‘è€³ç’°", type: 'accessory', rarity: 'rare', price: 600, icon: "ğŸ”µ", desc: "é‡‘å¹£ç²å–é‡ +10% (éå•†äºº)", recipe: {mat: "å“¥å¸ƒæ—è€³ç’°", count: 10} },
        acc_gob_3: { id: 'acc_gob_3', name: "è²ªå©ªé‡‘ç‰™", type: 'accessory', rarity: 'epic', price: 2500, icon: "ğŸŸ ", desc: "é‡‘å¹£ç²å–é‡ +20% (éå•†äºº)", recipe: {mat: "å“¥å¸ƒæ—é‡‘ç‰™", count: 5} },
        
        // --- ç‹‚ç‹¼ç³»åˆ— ---
        acc_wolf_1: { id: 'acc_wolf_1', name: "ç‹¼çš®æ‰‹å¥—", type: 'accessory', rarity: 'common', price: 200, icon: "âšª", desc: "è‡´å‘½ä¸€æ“Šæ©Ÿç‡ +1%", recipe: {mat: "ç‹¼çš®", count: 10} },
        acc_wolf_2: { id: 'acc_wolf_2', name: "ç‹¼ç‰™é …éŠ", type: 'accessory', rarity: 'rare', price: 800, icon: "ğŸ”µ", desc: "è‡´å‘½ä¸€æ“Šæ©Ÿç‡ +3%", recipe: {mat: "ç‹¼ç‰™", count: 10} },
        acc_wolf_3: { id: 'acc_wolf_3', name: "è¡€æœˆæŠ«é¢¨", type: 'accessory', rarity: 'epic', price: 3000, icon: "ğŸŸ ", desc: "è‡´å‘½ä¸€æ“Šæ©Ÿç‡ +8%", recipe: {mat: "ç‹¼ç‹æŠ«é¢¨", count: 5} },
        
        // --- éª·é«ç³»åˆ— ---
        acc_skel_1: { id: 'acc_skel_1', name: "éª¨æˆ’", type: 'accessory', rarity: 'common', price: 250, icon: "âšª", desc: "å‚·å®³æ¸›å°‘ 5% (ä¸å«æš´æ“Š)", recipe: {mat: "éª¨é ­", count: 10} },
        acc_skel_2: { id: 'acc_skel_2', name: "éˆé­‚å®¹å™¨", type: 'accessory', rarity: 'rare', price: 1000, icon: "ğŸ”µ", desc: "å‚·å®³æ¸›å°‘ 10% (ä¸å«æš´æ“Š)", recipe: {mat: "éˆé­‚ç¢ç‰‡", count: 10} },
        acc_skel_3: { id: 'acc_skel_3', name: "æ­»éˆè­·ç¬¦", type: 'accessory', rarity: 'epic', price: 3500, icon: "ğŸŸ ", desc: "å‚·å®³æ¸›å°‘ 15% (å«æš´æ“Š)", recipe: {mat: "æ­»éˆé ­éª¨", count: 5} },
        
        // --- åŠç¸äººç³»åˆ— ---
        acc_orc_1: { id: 'acc_orc_1', name: "æ–·åŠæ›é£¾", type: 'accessory', rarity: 'common', price: 300, icon: "âšª", desc: "å“ˆæ¯”äº‹ä»¶æ“Šé€€ç‡ +10%", recipe: {mat: "æ–·åŠ", count: 10} },
        acc_orc_2: { id: 'acc_orc_2', name: "è »æ—è­·ç¬¦", type: 'accessory', rarity: 'rare', price: 1200, icon: "ğŸ”µ", desc: "å“ˆæ¯”äº‹ä»¶æ“Šé€€ç‡ +30%", recipe: {mat: "åŠç¸äººè­·ç¬¦", count: 10} },
        acc_orc_3: { id: 'acc_orc_3', name: "å¨æœ›è™Ÿè§’", type: 'accessory', rarity: 'epic', price: 4000, icon: "ğŸŸ ", desc: "å“ˆæ¯”äº‹ä»¶å¿…å®šæ“Šé€€", recipe: {mat: "æˆ°çˆ­è™Ÿè§’", count: 5} },
        
        // --- å¹½éˆç³»åˆ— ---
        acc_ghost_1: { id: 'acc_ghost_1', name: "éˆè³ªæ–—ç¯·", type: 'accessory', rarity: 'common', price: 350, icon: "âšª", desc: "é€ƒè·‘æˆåŠŸç‡ +2%", recipe: {mat: "éˆè³ª", count: 10} },
        acc_ghost_2: { id: 'acc_ghost_2', name: "æ€¨å¿µå¿µç ", type: 'accessory', rarity: 'rare', price: 1500, icon: "ğŸ”µ", desc: "é€ƒè·‘æˆåŠŸç‡ +5%", recipe: {mat: "æ€¨å¿µé›†åˆé«”", count: 10} },
        acc_ghost_3: { id: 'acc_ghost_3', name: "å†¥ç•Œæç‡ˆ", type: 'accessory', rarity: 'epic', price: 4500, icon: "ğŸŸ ", desc: "é€ƒè·‘æˆåŠŸç‡ +10%", recipe: {mat: "å¹½éˆæç‡ˆ", count: 5} },
        
        // --- çŸ³å·¨äººç³»åˆ— ---
        acc_golem_1: { id: 'acc_golem_1', name: "çŸ³å¡Šå¾½ç« ", type: 'accessory', rarity: 'common', price: 500, icon: "âšª", desc: "ç”Ÿå‘½ä¸Šé™ +30", recipe: {mat: "çŸ³å¡Š", count: 10} },
        acc_golem_2: { id: 'acc_golem_2', name: "é­”å°æ ¸å¿ƒ", type: 'accessory', rarity: 'rare', price: 2000, icon: "ğŸ”µ", desc: "ç”Ÿå‘½ä¸Šé™ +100", recipe: {mat: "é­”åŠ›æ ¸å¿ƒ", count: 10} },
        acc_golem_3: { id: 'acc_golem_3', name: "ç£çŸ³ä¹‹å¿ƒ", type: 'accessory', rarity: 'epic', price: 6000, icon: "ğŸŸ ", desc: "ç”Ÿå‘½ä¸Šé™ +200", recipe: {mat: "å¤§åœ°ä¹‹å¿ƒ", count: 5} },
        
        // --- é£Ÿäººå¦–ç³»åˆ— ---
        acc_troll_1: { id: 'acc_troll_1', name: "æœ¨æ£’è­·èº«ç¬¦", type: 'accessory', rarity: 'common', price: 600, icon: "âšª", desc: "æ”»æ“ŠåŠ› +10", recipe: {mat: "å·¨æ£’", count: 10} },
        acc_troll_2: { id: 'acc_troll_2', name: "é®®è¡€ç“¶", type: 'accessory', rarity: 'rare', price: 2500, icon: "ğŸ”µ", desc: "æ”»æ“ŠåŠ› +20", recipe: {mat: "é£Ÿäººå¦–ä¹‹è¡€", count: 10} },
        acc_troll_3: { id: 'acc_troll_3', name: "å¤è€åœ–é¨°", type: 'accessory', rarity: 'epic', price: 7000, icon: "ğŸŸ ", desc: "æ”»æ“ŠåŠ› +35", recipe: {mat: "é£Ÿäººå¦–åœ–é¨°", count: 5} },
        
        // --- é›™è¶³é£›é¾ç³»åˆ— ---
        acc_wyv_1: { id: 'acc_wyv_1', name: "é¾é±—ç‰‡", type: 'accessory', rarity: 'common', price: 1000, icon: "âšª", desc: "é¦–é ˜å‚·å®³ +5%", recipe: {mat: "é¾é±—", count: 10} },
        acc_wyv_2: { id: 'acc_wyv_2', name: "é¾æ·šå¢œé£¾", type: 'accessory', rarity: 'rare', price: 4000, icon: "ğŸ”µ", desc: "é¦–é ˜å‚·å®³ +8%", recipe: {mat: "é¾ä¹‹æ·š", count: 10} },
        acc_wyv_3: { id: 'acc_wyv_3', name: "çœŸé¾ä¹‹å¿ƒ", type: 'accessory', rarity: 'epic', price: 8000, icon: "ğŸŸ ", desc: "é¦–é ˜å‚·å®³ +20%", recipe: {mat: "é¾å¿ƒ", count: 5} },
        
        // --- é­”ç‹ç³»åˆ— ---
        acc_demon_1: { id: 'acc_demon_1', name: "é»‘æš—ç¢ç‰‡", type: 'accessory', rarity: 'rare', price: 2000, icon: "âšª", desc: "æ”»+10 HP+10 æš´+2%", recipe: {mat: "é»‘æš—ç‰©è³ª", count: 10} },
        acc_demon_2: { id: 'acc_demon_2', name: "é­”å›å¾½ç« ", type: 'accessory', rarity: 'epic', price: 5000, icon: "ğŸ”µ", desc: "æ”»+20 HP+20 æš´+5%", recipe: {mat: "é­”ç‹å°è¨˜", count: 10} },
        acc_demon_3: { id: 'acc_demon_3', name: "æ··æ²Œé­”çœ¼", type: 'accessory', rarity: 'legendary', price: 10000, icon: "ğŸŸ ", desc: "æ”»+40 HP+40 æš´+20%", recipe: {mat: "é­”ç¥ä¹‹çœ¼", count: 5} }
    },
    // æ›´æ–° Loot Table (æ•´åˆå½ˆå¼“èˆ‡é‰¤å­)
    lootData: {
        "å²èŠå§†é»æ¶²": { price: 10, rarity: "common", icon: "ğŸ’§" },
        "å²èŠå§†ç²¾è¯": { price: 50, rarity: "uncommon", icon: "âœ¨" },
        "å²èŠå§†ç‹å† ": { price: 200, rarity: "rare", icon: "ğŸ‘‘" },
        "ç ´å¸ƒ": { price: 15, rarity: "common", icon: "ğŸ§¶" },
        "å“¥å¸ƒæ—è€³ç’°": { price: 60, rarity: "uncommon", icon: "ğŸ’" },
        "å“¥å¸ƒæ—é‡‘ç‰™": { price: 250, rarity: "rare", icon: "ğŸ¦·" },
        "ç‹¼çš®": { price: 20, rarity: "common", icon: "ğŸ§µ" },
        "ç‹¼ç‰™": { price: 80, rarity: "uncommon", icon: "ğŸ¦´" },
        "ç‹¼ç‹æŠ«é¢¨": { price: 300, rarity: "rare", icon: "ğŸ§£" },
        "éª¨é ­": { price: 25, rarity: "common", icon: "ğŸ¦´" },
        "éˆé­‚ç¢ç‰‡": { price: 100, rarity: "uncommon", icon: "ğŸ‘»" },
        "æ­»éˆé ­éª¨": { price: 350, rarity: "rare", icon: "ğŸ’€" },
        "æ–·åŠ": { price: 30, rarity: "common", icon: "ğŸ—¡ï¸" },
        "åŠç¸äººè­·ç¬¦": { price: 120, rarity: "uncommon", icon: "ğŸ§¿" },
        "æˆ°çˆ­è™Ÿè§’": { price: 400, rarity: "rare", icon: "ğŸ“¯" },
        "éˆè³ª": { price: 35, rarity: "common", icon: "ğŸŒ«ï¸" },
        "æ€¨å¿µé›†åˆé«”": { price: 150, rarity: "uncommon", icon: "ğŸ‘¿" },
        "å¹½éˆæç‡ˆ": { price: 450, rarity: "rare", icon: "ğŸ®" },
        "çŸ³å¡Š": { price: 50, rarity: "common", icon: "ğŸª¨" },
        "é­”åŠ›æ ¸å¿ƒ": { price: 200, rarity: "rare", icon: "ğŸ”®" },
        "å¤§åœ°ä¹‹å¿ƒ": { price: 600, rarity: "epic", icon: "ğŸ’" },
        "å·¨æ£’": { price: 60, rarity: "common", icon: "ğŸªµ" },
        "é£Ÿäººå¦–ä¹‹è¡€": { price: 250, rarity: "rare", icon: "ğŸ©¸" },
        "é£Ÿäººå¦–åœ–é¨°": { price: 700, rarity: "epic", icon: "ğŸ—¿" },
        "é¾é±—": { price: 100, rarity: "uncommon", icon: "ğŸ›¡ï¸" },
        "é¾ä¹‹æ·š": { price: 400, rarity: "rare", icon: "ğŸ’§" },
        "é¾å¿ƒ": { price: 800, rarity: "epic", icon: "â¤ï¸" },
        "é»‘æš—ç‰©è³ª": { price: 200, rarity: "rare", icon: "âš«" },
        "é­”ç‹å°è¨˜": { price: 500, rarity: "epic", icon: "ğŸ”¯" },
        "é­”ç¥ä¹‹çœ¼": { price: 1000, rarity: "legendary", icon: "ğŸ‘ï¸" },
        "çœŸå¯¦ä¹‹å¿ƒ": { price: 5000, rarity: "mythic", icon: "ğŸ’–" },
        // ç…‰ç„ç´ æ
        "æš—å½±å‡è† ": { price: 1000, rarity: "mythic", icon: "âš«" },
        "è™›ç©ºä¹‹å¡µ": { price: 1200, rarity: "mythic", icon: "ğŸŒ«ï¸" },
        "ç†”å²©æ ¸å¿ƒ": { price: 1500, rarity: "mythic", icon: "ğŸ”¥" },
        "å¤¢é­˜ä¹‹è§’": { price: 1800, rarity: "mythic", icon: "ğŸ¦„" },
        "è…æœ½é§ç”²": { price: 3000, rarity: "mythic", icon: "ğŸ›¡ï¸" },
        "æ··æ²Œç¥ç¶“": { price: 3500, rarity: "mythic", icon: "ğŸ§ " },
        "é®®è¡€ç²¾è¯": { price: 5000, rarity: "mythic", icon: "ğŸ©¸" },
        "å‘½åŒ£ç¢ç‰‡": { price: 6000, rarity: "mythic", icon: "ğŸ’€" },
        "é­”é¾é€†é±—": { price: 10000, rarity: "mythic", icon: "ğŸ²" },
        "ä¸å¯åç‹€ä¹‹ç‰©": { price: 50000, rarity: "ultra", icon: "ğŸ™" },
        // æ–°å¢é“å…·
        "å½ˆå¼“": { price: 0, rarity: "rare", icon: "ğŸªƒ", desc: "é­é‡å“ˆæ¯”æ™‚å¿…å®šæ“Šé€€å“ˆæ¯”ï¼Œç™¼å‹•å¾Œæ¶ˆå¤±ï¼Œç„¡æ³•å‡ºå”®" },
        "é‰¤å­": { price: 0, rarity: "rare", icon: "ğŸª", desc: "é­é‡è·Œå€’äº‹ä»¶æ™‚å¯ä»¥èº²é¿ä¸€æ¬¡ä¸¦ç²å¾—ç‰©å“ï¼Œç™¼å‹•å¾Œæ¶ˆå¤±ï¼Œç„¡æ³•å‡ºå”®" }
    },
    buffs: {
        angel_song: { id: 'angel_song', name: 'ğŸ‘¼ å¤©ä½¿çš„æ­Œé Œ', type: 'angel', desc: 'æ¯æ¬¡äº‹ä»¶æ¢å¾© 5 HP' },
        angel_protection: { id: 'angel_protection', name: 'ğŸ›¡ï¸ å¤©ä½¿çš„åŠ è­·', type: 'angel', desc: 'æ€ªç‰©é€ æˆçš„å‚·å®³æ¸›å°‘ 30%' },
        angel_courage: { id: 'angel_courage', name: 'âš”ï¸ å¤©ä½¿çš„å‹‡æ°£', type: 'angel', desc: 'è‡´å‘½ä¸€æ“Šæ©Ÿç‡æå‡è‡³ 20%' },
        angel_wings: { id: 'angel_wings', name: 'ğŸ•Šï¸ å¤©ä½¿çš„ç¿…è†€', type: 'angel', desc: 'é€ƒè·‘æˆåŠŸç‡æå‡è‡³ 60%' },
        demon_wealth: { id: 'demon_wealth', name: 'ğŸ’° æƒ¡é­”çš„è²¡å¯Œ', type: 'demon', desc: 'æ”»æ“Šå¾—5é‡‘å¹£ï¼Œä½†é€ƒè·‘å¤±æ•—è¢«æ”»æ“Šæ™‚æ‰£5é‡‘å¹£' },
        demon_destruction: { id: 'demon_destruction', name: 'ğŸ’€ æƒ¡é­”çš„ç ´å£', type: 'demon', desc: '10%æ©Ÿç‡ç§’æ®ºæ€ªç‰©ï¼Œè§¸ç™¼å¾Œæ‰£é™¤ç•¶å‰è¡€é‡90%' },
        demon_enhance: { id: 'demon_enhance', name: 'ğŸ”¥ æƒ¡é­”çš„å¼·åŒ–', type: 'demon', desc: 'é›™æ–¹è‡´å‘½ä¸€æ“Šæ©Ÿç‡è®Šç‚º 50%' },
        demon_wager: { id: 'demon_wager', name: 'ğŸ² æƒ¡é­”çš„è³­ç´„', type: 'demon', desc: 'é€ƒè·‘ç‡80%ï¼Œä½†æ¯æ¬¡é€ƒè·‘æœ‰1%æ©Ÿç‡ç›´æ¥æ­»äº¡' }
    },
    monsters: [
        { name: "å²èŠå§†", weight: 13.5, baseGold: 1, icon: "ğŸ¦ ", hp: 20, atk: 3, drop: "å²èŠå§†é»æ¶²", eliteDrop: "å²èŠå§†ç²¾è¯", bossDrop: "å²èŠå§†ç‹å† " },
        { name: "å“¥å¸ƒæ—", weight: 13.5, baseGold: 2, icon: "ğŸ‘º", hp: 35, atk: 5, drop: "ç ´å¸ƒ", eliteDrop: "å“¥å¸ƒæ—è€³ç’°", bossDrop: "å“¥å¸ƒæ—é‡‘ç‰™" },
        { name: "ç‹‚ç‹¼", weight: 13.5, baseGold: 3, icon: "ğŸº", hp: 50, atk: 8, drop: "ç‹¼çš®", eliteDrop: "ç‹¼ç‰™", bossDrop: "ç‹¼ç‹æŠ«é¢¨" },
        { name: "éª·é«å…µ", weight: 13.5, baseGold: 4, icon: "ğŸ’€", hp: 60, atk: 10, drop: "éª¨é ­", eliteDrop: "éˆé­‚ç¢ç‰‡", bossDrop: "æ­»éˆé ­éª¨" },
        { name: "åŠç¸äºº", weight: 13.5, baseGold: 8, icon: "ğŸ‘¹", hp: 90, atk: 12, drop: "æ–·åŠ", eliteDrop: "åŠç¸äººè­·ç¬¦", bossDrop: "æˆ°çˆ­è™Ÿè§’" },
        { name: "å¹½éˆ", weight: 13.5, baseGold: 10, icon: "ğŸ‘»", hp: 70, atk: 15, drop: "éˆè³ª", eliteDrop: "æ€¨å¿µé›†åˆé«”", bossDrop: "å¹½éˆæç‡ˆ" },
        { name: "çŸ³å·¨äºº", weight: 9, baseGold: 15, icon: "ğŸ—¿", hp: 150, atk: 20, drop: "çŸ³å¡Š", eliteDrop: "é­”åŠ›æ ¸å¿ƒ", bossDrop: "å¤§åœ°ä¹‹å¿ƒ" },
        
        // 2. é£Ÿäººå¦–ï¼šç”± 5 èª¿é™è‡³ 4 (å¹³è¡¡ç”¨)
        { name: "é£Ÿäººå¦–", weight: 4, baseGold: 25, icon: "ğŸ§Ÿ", hp: 200, atk: 25, drop: "å·¨æ£’", eliteDrop: "é£Ÿäººå¦–ä¹‹è¡€", bossDrop: "é£Ÿäººå¦–åœ–é¨°" },
        
        // 3. é›™è¶³é£›é¾ï¼šç”± 3 èª¿å‡è‡³ 4 (+1%)
        { name: "é›™è¶³é£›é¾", weight: 4, baseGold: 40, icon: "ğŸ‰", hp: 300, atk: 35, drop: "é¾é±—", eliteDrop: "é¾ä¹‹æ·š", bossDrop: "é¾å¿ƒ" },
        
        // 4. é­”ç‹ï¼šç”± 1 èª¿å‡è‡³ 2 (+1%)
        { name: "é­”ç‹", weight: 2, baseGold: 50, icon: "ğŸ‘¿", hp: 500, atk: 50, drop: "é»‘æš—ç‰©è³ª", eliteDrop: "é­”ç‹å°è¨˜", bossDrop: "é­”ç¥ä¹‹çœ¼" }
    ],
    itemPool: [
        { name: "ç”Ÿé½åŒ•é¦–", type: "weapon", val: 3, rarity: "common", price: 15, icon: "ğŸ—¡ï¸" },
        { name: "æœ¨æ£’", type: "weapon", val: 4, rarity: "common", price: 20, icon: "ğŸªµ" },
        { name: "å¸ƒè¡£", type: "armor", val: 10, rarity: "common", price: 15, icon: "ğŸ‘•" },
        { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" },
        { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" },
        { name: "é–å­ç”²", type: "armor", val: 40, rarity: "uncommon", price: 80, icon: "ğŸ›¡ï¸" },
        { name: "å¼·åŠ›è—¥æ°´", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "æ¢å¾©80é»ç”Ÿå‘½" },
        { name: "ç§˜éŠ€åŠ", type: "weapon", val: 30, rarity: "rare", price: 250, icon: "âš”ï¸" },
        { name: "æ¿ç”²", type: "armor", val: 100, rarity: "rare", price: 250, icon: "ğŸ›¡ï¸" },
        { name: "é¨å£«ç›¾", type: "shield", val: 2, rarity: "rare", price: 300, icon: "ğŸ›¡ï¸" },
        { name: "ç²¾éˆè—¥åŠ‘", type: "consumable", val: 200, rarity: "rare", price: 150, icon: "ğŸ§‰", desc: "æ¢å¾©200é»ç”Ÿå‘½" },
        { name: "å± é¾åŠ", type: "weapon", val: 60, rarity: "epic", price: 800, icon: "ğŸ‰" },
        { name: "é¾é±—é§ç”²", type: "armor", val: 250, rarity: "epic", price: 800, icon: "ğŸ¥‹" },
        { name: "å¡”ç›¾", type: "shield", val: 5, rarity: "epic", price: 500, icon: "ğŸ§±" },
        { name: "è–åŠ Excalibur", type: "weapon", val: 150, rarity: "legendary", price: 2500, icon: "ğŸŒŸ" },
        { name: "ç¥ä¹‹å…‰è¼", type: "armor", val: 400, rarity: "legendary", price: 2000, icon: "ğŸŒ" },
        { name: "åŸƒç™¸æ–¯ä¹‹ç›¾", type: "shield", val: 8, rarity: "legendary", price: 900, icon: "ğŸ”±" },
{ name: "æ”œå¸¶å¼å·¥ä½œæª¯", type: "consumable", rarity: "rare", price: 1500, icon: "ğŸ§°", desc: "éš¨æ™‚éš¨åœ°é–‹å•Ÿè£½ä½œè¦–çª— (æ¶ˆè€—å“)" }
    ],
    phoenixFeather: {
        id: "phoenix_feather",
        name: "ä¸æ­»é³¥çš„ç¾½æ¯›",
        type: "revive",
        rarity: "legendary",
        icon: "ğŸª¶",
        price: 0,
        desc: "æ­»äº¡æ™‚ä»¥50%ç”Ÿå‘½å¾©æ´»ï¼Œç„¡æ³•å‡ºå”®"
    },
    bible: {
        id: "inferno_bible",
        name: "ç…‰ç„è–ç¶“",
        type: "special",
        rarity: "mythic",
        icon: "ğŸ“•",
        desc: "é–‹å•Ÿé€šå¾€ç…‰ç„çš„å¤§é–€",
        recipe: {mat: "çœŸå¯¦ä¹‹å¿ƒ", count: 2}
    },
achievements: [
        // --- ğŸŒŒ æ·±æ·µæ¢ç´¢ (é€²åº¦) ---
        { id: "abyss_50", name: "æ·±æ·µçš„å‘¼å–š", cond: "åˆæ¬¡è¸å…¥å±éšªé ˜åŸŸ (é€šéç¬¬ 50 å±¤)", rarity: "common", check: (p) => p.depth >= 50 },
        { id: "abyss_100", name: "ç™¾å±¤çš„è©¦ç…‰", cond: "è­‰æ˜ä½ æœ‰ç”Ÿå­˜çš„è³‡æ ¼ (é€šéç¬¬ 100 å±¤)", rarity: "rare", check: (p) => p.depth >= 100 },
        { id: "abyss_500", name: "æ°¸å¤œçš„è¡Œè€…", cond: "ç¿’æ…£äº†é»‘æš—èˆ‡å­¤ç¨ (é€šéç¬¬ 500 å±¤)", rarity: "epic", check: (p) => p.depth >= 500 },
        { id: "abyss_1000", name: "åƒå±¤çš„åŸ·å¿µ", cond: "å‡¡äººé›£ä»¥æŠµé”çš„å¢ƒç•Œ (é€šéç¬¬ 1000 å±¤)", rarity: "legendary", check: (p) => p.depth >= 1000 },
        { id: "abyss_10000", name: "æ·±æ·µçš„ç›¡é ­", cond: "è¦‹è­‰ç„¡ç›¡å‚³èªªçš„èª•ç”Ÿ (é€šéç¬¬ 10000 å±¤)", rarity: "ultra", check: (p) => p.depth >= 10000, hidden: true },
        
        // --- âš”ï¸ æˆ°é¬¥èˆ‡æ”¶é›† (åŸºç¤) ---
        { id: "hero_kill", name: "è™›å½çš„çµ‚ç„‰", cond: "æ“Šæ•—è¡¨å±¤ä¸–ç•Œçš„é­”ç‹ (1000å±¤é¦–é ˜)", rarity: "legendary", check: (p) => p.kill1000Boss },
        { id: "phoenix", name: "æ¶…æ§ƒçš„é¤˜ç‡¼", cond: "å–å¾—ã€Œä¸æ­»é³¥çš„ç¾½æ¯›ã€", rarity: "legendary", check: (p) => p.history.items.has("ä¸æ­»é³¥çš„ç¾½æ¯›") },
        { id: "collector", name: "è¡Œå›Šæ»¿è¼‰", cond: "æ”¶é›† 20 ç¨®ä¸åŒçš„ç‰©å“", rarity: "common", check: (p) => Game.getCollectedItemsCount() >= 20 },
        { id: "researcher", name: "é­”ç‰©åšå­¸è€…", cond: "å–å¾—æ‰€æœ‰ä¸€èˆ¬èˆ‡èè‹±æ€ªç‰©çš„æ‰è½ç‰©", rarity: "epic", check: (p) => Game.checkDrops('researcher') },
        { id: "prospector", name: "è¬ç‰©æ´å¯Ÿè€…", cond: "å–å¾—è¡¨å±¤ä¸–ç•Œæ‰€æœ‰æ€ªç‰©çš„æ‰è½ç‰© (å«é¦–é ˜)", rarity: "legendary", check: (p) => Game.checkDrops('prospector') },
        { id: "hero_true", name: "çœŸå¯¦çš„å‹‡æ°£", cond: "ç²å¾—ã€ŒçœŸå¯¦ä¹‹å¿ƒã€ï¼Œçœ‹æ¸…ä¸–ç•Œçš„çœŸç›¸", rarity: "mythic", hidden: true, check: (p) => p.history.items.has("çœŸå¯¦ä¹‹å¿ƒ") },

        // --- ğŸ”¥ ç…‰ç„èˆ‡ç¥è©± (é€²éš) ---
        { id: "inferno_enter", name: "åœ°ç„é‚Šå¢ƒ", cond: "ä½¿ç”¨ç…‰ç„è–ç¶“ï¼Œå¢®å…¥ç…‰ç„ä¸–ç•Œ", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.inInferno },
        { id: "mythic_smith", name: "é»‘æ›œçŸ³çš„éŒ˜éŸ³", cond: "åœ¨ã€Œç…‰ç„çˆç«ã€è¦ªæ‰‹æ‰“é€ ä¸€ä»¶ç¥è©±è£å‚™", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has('æš—å½±æ›¿èº«') || p.history.items.has('è™›ç©ºä¹‹é¡') || p.history.items.has('åœ°å¿ƒç†”çˆé§') || p.history.items.has('å¤¢é­˜ç©¿åˆºè€…') || p.history.items.has('äº¡è€…é …éŠ') || p.history.items.has('ç†æ™ºé­ç¬') || p.history.items.has('è¡€ä¹‹å¥‘ç´„æ›¸') || p.history.items.has('æ°¸ç”Ÿè­·ç¬¦') || p.history.items.has('é€†é±—é¾è£') || p.history.items.has('æ»…ä¸–ä¹‹æ§') },
        { id: "old_one_end", name: "ä¸å¯åç‹€çš„ææ‡¼", cond: "æ“Šæ•—ç…‰ç„æ·±è™•çš„ã€ŒèˆŠæ—¥æ”¯é…è€…ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("ä¸å¯åç‹€ä¹‹ç‰©") },
        { id: "minotaur_rage", name: "é¬¥ç‰›å£«çš„æ¦®è€€", cond: "åŒæ™‚æŒæœ‰ã€Œç´…å¸ƒã€èˆ‡ã€Œç‰›é ­äººæˆ°æ–§ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("ç´…å¸ƒ") && p.history.items.has("ç‰›é ­äººæˆ°æ–§") },
        
        // --- ğŸ˜ˆ ä¸ƒå®—ç½ªè©¦ç…‰ (æŒ‘æˆ°) ---
        { id: "sin_pride", name: "å¾æœå‚²æ…¢", cond: "ç²å¾—ã€Œå‚²æ…¢ä¹‹çœ¼ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("å‚²æ…¢ä¹‹çœ¼") },
        { id: "sin_envy", name: "å¾æœå«‰å¦’", cond: "ç²å¾—ã€Œå«‰å¦’é­”ç›’ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("å«‰å¦’é­”ç›’") },
        { id: "sin_wrath", name: "å¾æœæš´æ€’", cond: "ç²å¾—ã€Œæš´æ€’æŒ‡è™ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("æš´æ€’æŒ‡è™") },
        { id: "sin_sloth", name: "å¾æœæ€ æƒ°", cond: "ç²å¾—ã€Œçœ æˆ’ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("çœ æˆ’") },
        { id: "sin_greed", name: "å¾æœè²ªå©ª", cond: "ç²å¾—ã€Œé‡‘è‰²è–åƒã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("é‡‘è‰²è–åƒ") },
        { id: "sin_gluttony", name: "å¾æœæš´é£Ÿ", cond: "ç²å¾—ã€Œæš´é£Ÿä¹‹ç‰™ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("æš´é£Ÿä¹‹ç‰™") },
        { id: "sin_lust", name: "å¾æœè‰²æ…¾", cond: "ç²å¾—ã€Œé­…é­”é¦™æ°´ã€", rarity: "mythic", hidden: true, category: "inferno", check: (p) => p.history.items.has("é­…é­”é¦™æ°´") },
        
        // --- ğŸ”’ éš±è—èˆ‡çµ‚æ¥µ (å‚³èªª) ---
        { id: "max_train", name: "ç™»å³°é€ æ¥µ", cond: "å°‡ç²¾éˆèˆ‡å²èŠå§†é•·è€çš„å¼·åŒ–å…¨éƒ¨ä¿®ç·´è‡³æ»¿ç´š (å„5æ¬¡)", rarity: "mythic", hidden: true, check: (p) => p.fairyEnhanceCount >= 5 && p.elderEnhanceCount >= 5 },
        { id: "sin_crown", name: "åŸç½ªçš„èƒŒè² è€…", cond: "é›†é½Šä¸ƒä»¶ç½ªæƒ¡é£¾å“ï¼Œç²å¾—ã€ŒåŸç½ªä¹‹å† ã€", rarity: "ultra", hidden: true, category: "inferno", check: (p) => p.history.items.has("åŸç½ªä¹‹å† ") },
        { id: "god_killer", name: "é€†å¤©æ”¹å‘½", cond: "æ“Šæ•—ç¥ä¹‹ä»£è¡Œè€…ï¼Œç²å¾—ã€Œè¼ªè¿´æ²™æ¼ã€", rarity: "ultra", hidden: true, check: (p) => p.history.items.has("è¼ªè¿´æ²™æ¼") },
        { id: "rebirth_used", name: "è¼ªè¿´çš„èµ·é»", cond: "ä½¿ç”¨æ²™æ¼ç©¿è¶Šæ™‚ç©ºï¼Œä¸¦ä¿ç•™äº†è¨˜æ†¶", rarity: "ultra", hidden: true, check: (p) => p.history.items.has("è¼ªè¿´å¾Œçš„è¨˜æ†¶") },
        { id: "hero_all_items", name: "å…¨çŸ¥çš„å¢ƒç•Œ", cond: "ç²å¾—åœ–é‘‘ä¸­æ‰€æœ‰çš„ç‰©å“", rarity: "ultra", hidden: true, check: (p) => Game.checkAllItems() },
        
        // --- ğŸ’— è‰è‰çµ²çš„ç¾ˆçµ† (åŠ‡æƒ…) ---
        { id: "lilith_note", name: "å°‘å¥³çš„ç§˜å¯†", cond: "å¾å®³ç¾çš„é­…é­”æ‰‹ä¸­ç²å¾—ã€Œç´™æ¢ã€", rarity: "epic", hidden: true, check: (p) => p.history.items.has("ç´™æ¢") },
        { id: "lilith_sword", name: "å®ˆè­·çš„æ±ºæ„", cond: "æŒæœ‰ç´™æ¢é€²å…¥ç…‰ç„ï¼Œç²å¾—ã€Œç¥è–å…‰åŠã€", rarity: "epic", hidden: true, check: (p) => p.history.items.has("ç¥è–å…‰åŠ") },
        { id: "lilith_pass", name: "æº«æŸ”çš„é€šè¡Œè­‰", cond: "å‡ºç¤ºç´™æ¢é€šéè‰²æ…¾è©¦ç…‰ï¼Œç²å¾—ã€Œé­…é­”çš„å¿ƒæ„ã€", rarity: "epic", hidden: true, check: (p) => p.history.items.has("é­…é­”çš„å¿ƒæ„") },
        { id: "lilith_bless", name: "è·¨è¶Šç¨®æ—çš„ç¾ˆçµ†", cond: "åœ¨èˆ‡ç¥ä¹‹ä»£è¡Œè€…æ±ºæˆ°æ™‚ï¼Œè‰è‰çµ²æŒºèº«è€Œå‡º", rarity: "mythic", hidden: true, check: (p) => p.lilithBlessing && !p.lilithSacrificed },
        { id: "lilith_sacrifice", name: "å‡‹é›¶çš„ç²‰è‰²", cond: "ç‚ºäº†å®ˆè­·ä½ ï¼Œè‰è‰çµ²åœ¨ç¥æˆ°ä¸­çŠ§ç‰² (Bad End)", rarity: "mythic", hidden: true, check: (p) => p.lilithSacrificed && Player.history.items.has("è¼ªè¿´æ²™æ¼") }, 
        { id: "lilith_love", name: "æ°¸æ†çš„èª“è¨€", cond: "æˆ°å‹ç¥ä¹‹ä»£è¡Œè€…ï¼Œä¸”è‰è‰çµ²å­˜æ´» (True End)", rarity: "ultra", hidden: true, check: (p) => p.lilithBlessing && Player.history.items.has("è¼ªè¿´æ²™æ¼") },
    ]
};
const Player = {
    hp: 100,
    maxHp: 100,
baseMaxHp: 100,
    baseAtk: 5,
    gold: 100,
    depth: 0,
    class: null,

permanentCritBonus: 0,
lilithBlessing: false,      // æ˜¯å¦ç²å¾—ç¥ç¦ (åœ¨å ´è­‰æ˜ - è‰è‰çµ²ç”Ÿå­˜/çœŸæ„›çµå±€ç”¨)
    lilithSacrificed: false,    // [NEW] è‰è‰çµ²æ˜¯å¦å·²çŠ§ç‰² (é˜²æ­¢é‡è¤‡è§¸ç™¼/å‹åˆ©çµå±€ç”¨)
    lastInspirationTurns: 0,    // æœ€å¾Œçš„é¼“èˆå‰©é¤˜å›åˆ
chaosRoll: 1,
    transcendenceRoll: 1, // [æ–°å¢] ç”¨æ–¼å„²å­˜è¶…è¶Šé­”æ–¹çš„å€ç‡
fairyEnhanceCount: 0,   // ç²¾éˆå¼·åŒ–æ¬¡æ•¸ (ä¸€èˆ¬ä¸–ç•Œ)
    elderEnhanceCount: 0,   // é•·è€å¼·åŒ–æ¬¡æ•¸ (ç…‰ç„ä¸–ç•Œ)
// [NEW] æ–°å¢ï¼šæ°¸ä¹…ç”Ÿå‘½åŠ æˆ (æœ«ä¸–ä¹‹é§ç”¨)
    permanentHpBonus: 0,
    equipment: { weapon: null, armor: null, shield: null, accessories: [null, null, null] },
    inventory: { 
        equipment: [], 
        consumable: [
            { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" }
        ], 
        material: [],
        accessory: []
    },
    buff: null,
debuff: null,
    achievements: new Set(),
    history: { items: new Set() },
    kill1000Boss: false,
    inInferno: false,
    chaosRoll: 1,
    
    // [FIX] è®Šæ•¸å¿…é ˆæ”¾åœ¨é€™è£¡ï¼Œç¨‹å¼æ‰è®€å¾—åˆ°
    souls: 0,             
    ghostTurns: 0,        
    bloodContractAtk: 0,  

    // [NEW] æ–°å¢ä¸ƒå®—ç½ªç‹€æ…‹è¿½è¹¤
    sinState: {
        slothCount: 0,     // æ‡¶æƒ°è©›å’’å‰©é¤˜å ´æ¬¡
        wrathRevive: 0,    // ç‹‚æˆ°å£«å¾©æ´»æ¬¡æ•¸
        lustActive: false, // æ˜¯å¦æœ‰åªšæ°£ç’°ç¹
        greedActive: false // æ˜¯å¦æœ‰é»ƒé‡‘æ·é–
    },
    succubusStage: 0, // [NEW] 0=åˆé‡, 1=èªè­˜, 2=å®³ç¾, 3=å®Œæˆ
	
	// [NEW] è‡ªå‹•ç•¥éç¥ˆç¦±è–åƒ
    autoSkipStatue: false
};

const GameState = {
    phase: "select_class",
forgeUsed: false,     // [NEW] è¿½è¹¤çˆç«æ˜¯å¦å·²ä½¿ç”¨
merchantRefreshed: false,
    combatTurn: 0,        // [NEW] è¿½è¹¤æˆ°é¬¥å›åˆæ•¸
    enemyDominated: false, // [NEW] èˆŠæ—¥æ”¯é…è€…æ•ˆæœ
    currentEnemy: null,
    merchantStock: [],
    craftingCount: 0,
    log: [],
    isLoading: false,
    compendiumTab: 'items',
    currentSinType: null // [NEW] ç´€éŒ„ç•¶å‰ç½ªæƒ¡é¡å‹ï¼Œç”¨æ–¼æˆ°é¬¥é–å®š
};
const Game = {
    init() {
        if (localStorage.getItem('fantasy_adventure_save_v2')) {
            this.loadGame();
        } else {
            // ä¿®æ­£ï¼šæ–°éŠæˆ²æ™‚å¼·åˆ¶é¡¯ç¤ºè·æ¥­é¸æ“‡
            document.getElementById('class-modal').style.display = 'flex';
            this.updateUI();
        }
    },

    saveGame() {
        if (Player.hp <= 0) {
            localStorage.removeItem('fantasy_adventure_save_v2');
            return;
        }
        if (!Player.class) return;

        try {
            const saveData = {
                player: {
                    ...Player,
                    achievements: Array.from(Player.achievements),
                    history: { items: Array.from(Player.history.items) }
                },
                gameState: GameState,
                timestamp: new Date().toLocaleString()
            };
            localStorage.setItem('fantasy_adventure_save_v2', JSON.stringify(saveData));
        } catch (e) {
            console.error("Auto-save failed", e);
        }
    },

    loadGame() {
        const json = localStorage.getItem('fantasy_adventure_save_v2');
        if (!json) return;

        GameState.isLoading = true;

        try {
            const data = JSON.parse(json);

            // Merge Player Data deeply
            Object.assign(Player, data.player);
            // Compatibility checks
            if(!Player.equipment.accessories) Player.equipment.accessories = [null, null, null];
            if(!Player.inventory.accessory) Player.inventory.accessory = [];
            if(Player.inInferno === undefined) Player.inInferno = false;
            // [NEW] å…¼å®¹èˆŠå­˜æª”çš„ä¸ƒå®—ç½ªç‹€æ…‹
            if(!Player.sinState) Player.sinState = { slothCount: 0, wrathRevive: 0, lustActive: false, greedActive: false };
            if (typeof Player.lilithBlessing === 'undefined') Player.lilithBlessing = false;
            if (typeof Player.lilithSacrificed === 'undefined') Player.lilithSacrificed = false;
            if (typeof Player.autoSkipStatue === 'undefined') Player.autoSkipStatue = false;
			

            Player.achievements = new Set(data.player.achievements);
            Player.history.items = new Set(data.player.history.items);

            Object.assign(GameState, data.gameState);

if (GameState.merchantRefreshed === undefined) GameState.merchantRefreshed = false;

            // Apply Inferno Visuals
            if (!Player.sinState) Player.sinState = {};
            if (typeof Player.sinState.slothCount !== 'number') Player.sinState.slothCount = 0;
            if (typeof Player.sinState.wrathRevive !== 'number') Player.sinState.wrathRevive = 0;

            // --- [FIX] é€™è£¡åŠ å…¥ä¿®å¾©ä»£ç¢¼ï¼šæ¢å¾©ç…‰ç„èƒŒæ™¯ ---
            if (Player.inInferno) {
                document.body.classList.add('inferno-mode');
            } else {
                document.body.classList.remove('inferno-mode');
            }

            this.updateUI();
            
            document.getElementById('class-modal').style.display = 'none';
            const badgeMap = { 
                'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†è²©', 'thief': 'ğŸ—¡ï¸ ç›œè³Š', 
                'cultist': 'ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’', 'scarecrow': 'ğŸŒ¾ ç¨»è‰äºº', 'ape': 'ğŸ¦ äººçŒ¿'
            };
            document.getElementById('class-badge').innerText = badgeMap[Player.class] || "";

            this.restoreScreenState();
            this.showFloatingText("è‡ªå‹•è¼‰å…¥é€²åº¦", "#2196f3");

        } catch (e) {
            console.error(e);
            alert("å­˜æª”ææ¯€ï¼Œé–‹å§‹æ–°éŠæˆ²ã€‚");
            localStorage.removeItem('fantasy_adventure_save_v2');
            // è¼‰å…¥å¤±æ•—ä¹Ÿé¡¯ç¤ºè·æ¥­é¸æ“‡
            document.getElementById('class-modal').style.display = 'flex';
        } finally {
            GameState.isLoading = false;
        }
    },

	    
    toggleAutoSkipStatue(on) {
	// [NEW] é¸é …ï¼šåˆ‡æ›è‡ªå‹•ç•¥éç¥ˆç¦±è–åƒ
        Player.autoSkipStatue = !!on;
        this.saveGame();  // è®“é¸é …å¯«é€²å­˜æª”

        // å°æç¤ºæ–‡å­—ï¼Œå¯æœ‰å¯ç„¡
        this.showFloatingText(
            on ? "å·²é–‹å•Ÿï¼šè‡ªå‹•ç•¥éç¥ˆç¦±è–åƒ" : "å·²é—œé–‰ï¼šè‡ªå‹•ç•¥éç¥ˆç¦±è–åƒ",
            "#cccccc"
        );
    },


    restoreScreenState() {
        if (GameState.phase === 'combat' && GameState.currentEnemy) {
            const enemy = GameState.currentEnemy;
            let iconClass = "monster-icon";
            if(enemy.tier === "elite") iconClass += " monster-elite glow-blue";
            if(enemy.tier === "boss") iconClass += " monster-boss glow-red";
            if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
            if(Player.inInferno) iconClass += " glow-inferno";

            this.renderEvent(`âš”ï¸ é­é‡ ${enemy.name} (æ¢å¾©)`, 
                `HP: ${enemy.hp} | æ”»æ“Š: ${enemy.atk}`, 
                "æˆ°é¬¥ç¹¼çºŒï¼", enemy.icon);
            document.getElementById('event-icon').className = iconClass;
            // 1. å®šç¾©å¯é€ƒè·‘çš„ BOSS åå–® (éœ€èˆ‡ triggerCombatWithEnemy ä¿æŒä¸€è‡´)
            const escapableBosses = ['é®®è¡€ä¼¯çˆµ', 'å·«å¦–ç‹', 'æ·±æ·µé­”é¾'];
            const isEscapable = escapableBosses.some(name => enemy.name.includes(name));

            // 2. åˆ¤æ–·æ˜¯å¦å¼·åˆ¶ç¦æ­¢é€ƒè·‘ï¼š
            // æ¢ä»¶ï¼šæ˜¯ç¥ OR æ˜¯ä¸ƒå®—ç½ª OR æ˜¯èˆŠæ—¥æ”¯é…è€… OR (æ˜¯BOSS ä¸” ä¸åœ¨å¯é€ƒè·‘åå–®å…§)
            // ä¾‹å¤–ï¼šèŠ±åœ’å‹‡è€… (isGardenBoss) ç¸½æ˜¯å¯é€ƒè·‘
            const forceNoFlee = (
                enemy.isGod || 
                enemy.isSin || 
                enemy.isOldOne || 
                (enemy.tier === 'boss' && !isEscapable)
            ) && !enemy.isGardenBoss;

            this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", forceNoFlee);
        } 
        else if (GameState.phase === 'sin_event') {
    // ä¿®æ­£ï¼šé‡æ–°è§¸ç™¼è©²ç½ªæƒ¡äº‹ä»¶ï¼Œè€Œä¸æ˜¯è·³é
    const sin = GameState.currentSinType;
    if (sin) {
        this.log(`>>> æ¢å¾©ä¸ƒå®—ç½ªäº‹ä»¶: ${sin}`);
        switch(sin) {
            case 'pride': this.handlePrideEvent(); break;
            case 'envy': this.handleEnvyEvent(); break;
            case 'wrath': this.handleWrathEvent(); break;
            case 'sloth': this.handleSlothEvent(); break;
            case 'greed': this.handleGreedEvent(); break;
            case 'gluttony': this.handleGluttonyEvent(); break;
            case 'lust': this.handleLustEvent(); break;
            default: this.nextEvent(); // é˜²å‘†
        }
    } else {
        this.nextEvent();
    }
}
        else if (GameState.phase === 'merchant' || GameState.phase === 'demon_merchant') {
            this.triggerAnim('event-icon', 'anim-spawn');
            const title = GameState.phase === 'merchant' ? "ğŸ’° ç¥ç§˜å•†äºº" : "ğŸ˜ˆ æƒ¡é­”å•†äºº";
            this.renderEvent(title, "æ­¡è¿å›ä¾†ï¼Œè¦ç¹¼çºŒäº¤æ˜“å—ï¼Ÿ", "é»æ“Šå•†å“å¯æŸ¥çœ‹è©³æƒ…èˆ‡è³¼è²·", "ğŸ‘³");
            this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
            this.renderMerchantShop();
        }
        else if (GameState.phase === 'crafting') {
            this.triggerAnim('event-icon', 'anim-spawn');
            this.renderEvent("ğŸ”¨ è£½ä½œå°", "ä½ ç™¼ç¾äº†ä¸€å€‹å»¢æ£„çš„è£½ä½œå°ã€‚", `å‰©é¤˜è£½ä½œæ¬¡æ•¸: ${2 - GameState.craftingCount}`, "âš’ï¸");
            this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
            this.renderCraftingUI();
        }
        else {
            GameState.phase = "event_end";
            this.renderEvent("ğŸ“‚ è®€å–æˆåŠŸ", `æ­¡è¿å›åˆ°ç¬¬ ${Player.depth} å±¤`, "è«‹é»æ“ŠæŒ‰éˆ•ç¹¼çºŒå†’éšªã€‚", "ğŸ’¾");
            document.getElementById('event-icon').className = "monster-icon";
            document.getElementById('merchant-area').classList.add('hidden');
            document.getElementById('crafting-area').classList.add('hidden');
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        }
    },

    manualRestart() {
        if (confirm("âš  ç¢ºå®šè¦é‡æ–°é–‹å§‹éŠæˆ²å—ï¼Ÿ\n\næŒ‰ä¸‹ç¢ºå®šå¾Œï¼Œç¾æœ‰çš„é€²åº¦å°‡æœƒè¢«åˆªé™¤ä¸”ç„¡æ³•å¾©åŸï¼")) {
            localStorage.removeItem('fantasy_adventure_save_v2');
            location.reload();
        }
    },

    
    // --- Compendium ---
    switchCompendiumTab(tab) {
        GameState.compendiumTab = tab;
        const btns = document.querySelectorAll('.tab-btn');
        btns.forEach(b => b.classList.remove('active'));
        if(tab === 'items') btns[0].classList.add('active');
        else if(tab === 'accessories') btns[1].classList.add('active');
        else btns[2].classList.add('active');
        this.showCompendium(true);
    },

showCredits() {
        document.getElementById('credits-modal').style.display = 'flex';
    },

    getAllItems(tab) {
        let items = [];
        if (tab === 'items') {
            items.push(...CONFIG.itemPool);
            for (let [name, data] of Object.entries(CONFIG.lootData)) {
                if(data.rarity !== 'mythic' && data.rarity !== 'ultra') items.push({ ...data, name: name, type: 'material' });
            }
            items.push(CONFIG.phoenixFeather);
            items.push(CONFIG.bible);
            items.push(CONFIG.specialItems.chocolate);
        } else if (tab === 'accessories') {
            items.push(...Object.values(CONFIG.accessories));
        } else if (tab === 'inferno') {
            items.push(...CONFIG.infernoItems);
            items.push(...CONFIG.sinItems); // [NEW] Include Sin items in inferno tab
            items.push(...CONFIG.forgeItems);
            items.push(CONFIG.specialItems.hourglass); // è¼ªè¿´æ²™æ¼
            items.push(CONFIG.specialItems.holy_sword); // ç¥è–å…‰åŠ
            items.push(CONFIG.specialItems.note); // ç´™æ¢
            // [NEW] è™›æ“¬æˆå°±ç‰©å“
            items.push({ name: "é­…é­”çš„å¿ƒæ„", type: "special", rarity: "epic", icon: "â¤ï¸", desc: "é­…é­”æ”¾è¡Œçš„è­‰æ˜ (æˆå°±è¿½è¹¤ç”¨)" });
            items.push({ name: "è¼ªè¿´å¾Œçš„è¨˜æ†¶", type: "special", rarity: "ultra", icon: "ğŸ§ ", desc: "ç™¼å‹•è¼ªè¿´æ²™æ¼å¾Œçš„æ®˜ç•™è¨˜æ†¶ (æˆå°±è¿½è¹¤ç”¨)" });


            for (let [name, data] of Object.entries(CONFIG.lootData)) {
                if(data.rarity === 'mythic' || data.rarity === 'ultra') items.push({ ...data, name: name, type: 'material' });
            }
        }
        return items.sort((a, b) => {
            const rA = CONFIG.rarityDisplay[a.rarity].val;
            const rB = CONFIG.rarityDisplay[b.rarity].val;
            if (rA !== rB) return rA - rB;
            return a.name.localeCompare(b.name);
        });
    },

    showCompendium(isSwitch = false) {
        const modal = document.getElementById('compendium-modal');
        if(!isSwitch) modal.style.display = 'flex';
        
        const list = document.getElementById('compendium-content');
        const stats = document.getElementById('compendium-stats');
        list.innerHTML = "";

        const allItems = this.getAllItems(GameState.compendiumTab).filter(i => i.name !== "é­…é­”çš„å¿ƒæ„" && i.name !== "è¼ªè¿´å¾Œçš„è¨˜æ†¶"); // æ’é™¤è™›æ“¬æˆå°±ç‰©å“
        const unlockedCount = allItems.filter(i => Player.history.items.has(i.name)).length;
        
        stats.innerText = `æ”¶é›†é€²åº¦: ${unlockedCount} / ${allItems.length}`;

        allItems.forEach(item => {
            const unlocked = Player.history.items.has(item.name);
            const div = document.createElement('div');
            
            if (!unlocked && (item.name === "çœŸå¯¦ä¹‹å¿ƒ" || item.rarity === "ultra" || item.rarity === "mythic")) {
                div.className = 'c-item secret-hidden';
                div.title = "?????";
            } 
            else if (unlocked) {
                div.className = `c-item unlocked ${CONFIG.rarityDisplay[item.rarity].color}`;
                if(item.rarity === 'mythic') div.className += ' rarity-mythic';
                if(item.rarity === 'ultra') div.className += ' rarity-ultra';
                
                let tooltip = this.getItemDesc(item);
                if(item.type === 'accessory' && item.recipe) {
                    tooltip += `\n[é…æ–¹: ${item.recipe.mat} x${item.recipe.count}]`;
                } else {
                    tooltip += `\n(åƒ¹å€¼: ${item.price || 0}G)`;
                }
                div.title = tooltip;
                div.style.cursor = 'pointer';
                div.onclick = () => alert(`ã€${item.name}ã€‘\n\n${tooltip}`);

                div.innerHTML = `<div class="c-icon">${item.icon || 'ğŸ“¦'}</div><div class="c-name">${item.name}</div>`;
            } 
            else {
                div.className = 'c-item unknown';
                div.title = "å°šæœªç²å¾—";
                div.innerHTML = `<div class="c-icon">â“</div><div class="c-name">???</div>`;
            }
            list.appendChild(div);
        });
    },

    // --- [NEW] ä¸ƒå®—ç½ªäº‹ä»¶éˆé‚è¼¯ ---
    triggerSinEvent() {
        const sins = ['pride', 'envy', 'wrath', 'sloth', 'greed', 'gluttony', 'lust'];
        const sin = sins[Math.floor(Math.random() * sins.length)];
        // const sin = 'pride'; // Debug
        
        GameState.phase = "sin_event";
        GameState.currentSinType = sin; // [NEW] ç´€éŒ„ç•¶å‰ç½ªæƒ¡é¡å‹ï¼Œç”¨æ–¼åˆ¤æ–·æ˜¯å¦é–è£å‚™
        this.log(`>>> è§¸ç™¼ä¸ƒå®—ç½ªäº‹ä»¶: ${sin}`);


        switch(sin) {
            case 'pride': this.handlePrideEvent(); break;
            case 'envy': this.handleEnvyEvent(); break;
            case 'wrath': this.handleWrathEvent(); break;
            case 'sloth': this.handleSlothEvent(); break;
            case 'greed': this.handleGreedEvent(); break;
            case 'gluttony': this.handleGluttonyEvent(); break;
            case 'lust': this.handleLustEvent(); break;
        }
    },
// [NEW] äº¡è€…çš„é›•åƒäº‹ä»¶
    triggerDeadStatue() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ—¿ äº¡è€…çš„é›•åƒ", "ä¸€åº§æ•£ç™¼è‘—ç¥è–èˆ‡æ¯€æ»…æ°£æ¯çš„é›•åƒã€‚", "å®ƒä¼¼ä¹åœ¨ç­‰å¾…è‘—é‚£é ‚çš‡å† ã€‚", "ğŸ—½");
        
        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªä¹‹å† ");
        if (hasCrown) {
            this.setButtons("æ”¾ä¸ŠåŸç½ªä¹‹å† ", "triggerGodAgent", "é›¢é–‹", "nextEvent", false);
        } else {
            this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        }
    },

    // [NEW] è§¸ç™¼æœ€çµ‚ BOSS (ä¿®æ­£ç‰ˆ)
    triggerGodAgent() {
        // 1. ç§»é™¤åŸç½ªä¹‹å† 
        const idx = Player.inventory.material.findIndex(i => i.name === "åŸç½ªä¹‹å† ");
        if(idx > -1) {
            Player.inventory.material.splice(idx, 1);
            // [FIX] é‡è¦ï¼šç«‹å³æ›´æ–° UIï¼Œè®“èƒŒåŒ…è£¡çš„ç‹å† é¦¬ä¸Šæ¶ˆå¤±
            this.updateUI(); 
        }

        // 2. è¨­å®š BOSS æ•¸å€¼
        const enemy = {
            name: "ç†¾å¤©ä½¿ãƒ»ç¥ä¹‹ä»£è¡Œè€…", 
            icon: "âšœï¸", 
            hp: 666666, 
            maxHp: 666666,
            atk: 6666, 
            tier: "boss", 
            isGod: true // æ¨™è¨˜ç‚ºç¥ï¼Œç”¨æ–¼ç‰¹æ®Šæ©Ÿåˆ¶åˆ¤å®š
        };
        
        // 3. é–‹å§‹æˆ°é¬¥
        this.triggerCombatWithEnemy(enemy, false); // false = ç„¡æ³•é€ƒè·‘
        this.showFloatingText("âš ï¸ è­¦å‘Šï¼šç¥è‡¨ âš ï¸", "red");
    },

    // 1. å‚²æ…¢
    handlePrideEvent() {
        this.renderEvent("ğŸ¦ å‚²æ…¢ä¹‹é–€", "ã€Œå”¯æœ‰å¸ä¸‹é˜²å‚™ï¼Œæ–¹é¡¯å¼·è€…æœ¬è‰²ã€‚ã€", "é¢å°èˆ‡ä½ ä¸€æ¨¡ä¸€æ¨£çš„é‡‘è‰²é¡åƒã€‚\n(å¸ä¸‹é˜²å…·æˆ°é¬¥ï¼Œç„¡æ³•é€ƒè·‘)", "ğŸª");
        this.setButtons("æ¥å—æŒ‘æˆ°", "resolvePrideFight", "æ‹’çµ• (é›¢é–‹)", "nextEvent", false);
    },
    resolvePrideFight() {
       // [FIX] æ”¹ç‚ºæ‰‹å‹•å¸ä¸‹é˜²å…· (ç¹é unequip å‡½æ•¸çš„é˜²ä½œå¼Šé–å®š)
        if (Player.equipment.armor) {
            this.addItemToInventory(Player.equipment.armor, false); // æ”¾å›èƒŒåŒ…
            Player.equipment.armor = null; // æ¸…ç©ºæ¬„ä½
        }
        if (Player.equipment.shield) {
            this.addItemToInventory(Player.equipment.shield, false); // æ”¾å›èƒŒåŒ…
            Player.equipment.shield = null; // æ¸…ç©ºæ¬„ä½
        }
        
        this.recalcStats(); // é‡æ–°è¨ˆç®—æ•¸å€¼ (HPä¸Šé™æœƒä¸‹é™)
        this.updateUI();    // ç«‹å³æ›´æ–°ä»‹é¢
        
        // ç›´æ¥è®€å–ç•¶å‰æ”»æ“ŠåŠ›
        const pAtk = this.getAtk();

        // --- [å¹³è¡¡æ€§èª¿æ•´] ---
        // æ”»æ“ŠåŠ›: ç©å®¶çš„ 50% (è®“æ²’ç©¿é˜²å…·çš„ç©å®¶èƒ½æ’ 2~3 ä¸‹)
        // è¡€é‡: ç©å®¶æ”»æ“ŠåŠ›çš„ 4 å€ (ç©å®¶éœ€æ”»æ“Šç´„ 4 æ¬¡ç²å‹)
        
        const mirrorAtk = Math.max(1, Math.floor(pAtk * 0.5)); 
        const mirrorHp = Math.min(333333, pAtk * 4);

        const enemy = {
            name: "å‚²æ…¢é¡åƒ", icon: "ğŸ‘¤",
            hp: mirrorHp, 
            maxHp: mirrorHp,
            atk: mirrorAtk, 
            tier: "boss", isSin: true, sinType: 'pride'
        };
        this.triggerCombatWithEnemy(enemy, false); 
    },

    // 2. å«‰å¦’
    handleEnvyEvent() {
        this.renderEvent("ğŸ¦Š å«‰å¦’é­”ç²¾", "ã€Œå¥½æ¼‚äº®...å¥½å¼·å¤§...è·Ÿæˆ‘æ›...ã€", "é­”ç²¾ç›¯è‘—ä½ çš„è£å‚™æµå£æ°´ã€‚", "ğŸ‘º");
        this.setButtons("äº¤æ› (å¤±å»2ä»¶ç¨€æœ‰è£å‚™)", "resolveEnvyTrade", "æ‹’çµ•", "nextEvent", false);
    },

forceRemoveItem(targetItem) {
    // 1. æª¢æŸ¥æ˜¯å¦åœ¨ã€è£å‚™æ¬„ã€‘
    if (Player.equipment.weapon === targetItem) { Player.equipment.weapon = null; this.recalcStats(); return; }
    if (Player.equipment.armor === targetItem) { Player.equipment.armor = null; this.recalcStats(); return; }
    if (Player.equipment.shield === targetItem) { Player.equipment.shield = null; this.recalcStats(); return; }
    
    // æª¢æŸ¥é£¾å“æ¬„
    for (let i = 0; i < 3; i++) {
        if (Player.equipment.accessories[i] === targetItem) {
            Player.equipment.accessories[i] = null;
            this.recalcStats();
            return;
        }
    }

    // 2. æª¢æŸ¥æ˜¯å¦åœ¨ã€èƒŒåŒ…ã€‘(ä½¿ç”¨åŸæœ¬çš„é‚è¼¯)
    this.removeItemFromInventory(targetItem);
},

    resolveEnvyTrade() {
    // 1. æ”¶é›†æ‰€æœ‰ç‰©å“ (åŒ…å«å·²è£å‚™çš„)
    let allCandidates = [];
    
    // åŠ å…¥èƒŒåŒ…ç‰©å“
    allCandidates.push(...Player.inventory.equipment);
    allCandidates.push(...Player.inventory.accessory);
    
    // [FIX] åŠ å…¥èº«ä¸Šè£å‚™ (é˜²æ­¢ç©å®¶è—è£å‚™)
    if (Player.equipment.weapon) allCandidates.push(Player.equipment.weapon);
    if (Player.equipment.armor) allCandidates.push(Player.equipment.armor);
    if (Player.equipment.shield) allCandidates.push(Player.equipment.shield);
    Player.equipment.accessories.forEach(acc => {
        if (acc) allCandidates.push(acc);
    });

    // 2. æ’åº (ç¨€æœ‰åº¦é«˜ -> ä½)
    allCandidates.sort((a, b) => CONFIG.rarityDisplay[b.rarity].val - CONFIG.rarityDisplay[a.rarity].val);
    
    // 3. æª¢æŸ¥æ•¸é‡
    if (allCandidates.length < 2) {
        this.renderEvent("ğŸ¦Š å«‰å¦’çš„å˜²ç¬‘", "ã€Œä½ å…¨èº«åŠ èµ·ä¾†é€£å…©ä»¶åƒæ¨£çš„æ±è¥¿éƒ½æ²’æœ‰ï¼æ»¾ï¼ã€", "é­”ç²¾å°ä½ ä¸å±‘ä¸€é¡§ã€‚", "ğŸ’¨");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        return;
    }

    // 4. é–å®šè¦ç§»é™¤çš„å…©å€‹æœ€é«˜ç´šç‰©å“
    const removed1 = allCandidates[0];
    const removed2 = allCandidates[1];

    // [FIX] ä½¿ç”¨æ–°çš„å¼·åˆ¶ç§»é™¤å‡½æ•¸ (è™•ç†èº«ä¸Šè£å‚™çš„å¸é™¤)
    this.forceRemoveItem(removed1);
    this.forceRemoveItem(removed2);

    // 5. çµ¦äºˆçå‹µ
    const reward = CONFIG.sinItems.find(i => i.id === 'acc_envy');
    this.addItemToInventory({...reward});
    
    // æ›´æ–°ä»‹é¢ (å› ç‚ºå¯èƒ½è„«æ‰äº†è£å‚™ï¼Œéœ€è¦åˆ·æ–°æ•¸å€¼é¡¯ç¤º)
    this.updateUI();

    this.renderEvent("ğŸ¦Š äº¤æ˜“å®Œæˆ", 
        `å«‰å¦’é­”ç²¾å¥ªèµ°äº†ä½ çš„ <span style="color:red">${removed1.name}</span> èˆ‡ <span style="color:red">${removed2.name}</span>...`, 
        `ä½œç‚ºäº¤æ›ï¼Œä½ ç²å¾—äº† <span class="rarity-mythic">${reward.name}</span>ï¼`, "ğŸ");
    this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
},

    // 3. æš´æ€’
    handleWrathEvent() {
        this.renderEvent("ğŸ˜¡ æš´æ€’å›šç± ", "ç‹‚æˆ°å£«å’†å“®è‘—ï¼šã€Œé‡‹æ”¾æˆ‘ï¼è®“æˆ‘å€‘å»æ®ºè‡³æ­»ï¼ã€", "ç„¡ç›¡çš„æ­»é¬¥ï¼Œæ•µäººå¯èƒ½æœƒå¾©æ´»ã€‚", "â›“ï¸");
        this.setButtons("é‡‹æ”¾ä¸¦æˆ°é¬¥", "resolveWrathFight", "ç„¡è¦– (-50 HP)", "resolveWrathIgnore", false);
    },
    resolveWrathFight() {
        Player.sinState.wrathRevive = 0;
        const enemy = { ...CONFIG.sinMonsters[1], isSin: true, sinType: 'wrath' }; 
        this.triggerCombatWithEnemy(enemy, false);
    },
    resolveWrathIgnore() {
        Player.hp = Math.max(1, Player.hp - 50);
        this.renderEvent("ğŸ˜¡ æ€’ç«éœ‡æ‡¾", "ä½ æ„Ÿåˆ°èƒŒå¾Œä¸€é™£æ®ºæ„...", "HP -50", "ğŸ¤•");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
    },

    // 4. æ€ æƒ°
    handleSlothEvent() {
        this.renderEvent("ğŸ» å®‰æ¯æ²¼æ¾¤", "çœ¼çš®ç„¡æ¯”æ²ˆé‡ï¼Œåœ°ä¸Šæœ‰æŸ”è»Ÿçš„åºŠé‹ª...", "ã€Œå†’éšªå¤ªç´¯äº†...ä¼‘æ¯ä¸€ä¸‹å§...ã€", "ğŸ’¤");
        this.setButtons("å°ç¡ (å›æ»¿+è©›å’’)", "resolveSlothSleep", "å¼·è¡Œé€šé (-30% HP)", "resolveSlothPass", false);
    },
    resolveSlothSleep() {
        Player.hp = Player.maxHp;
        Player.debuff = CONFIG.sinBuffs.sloth_curse; // [FIX] æ”¹ç‚º debuff
        Player.sinState.slothCount = 10;
        this.renderEvent("ğŸ’¤ æ²‰ç¡ä¹‹å¾Œ", "é«”åŠ›å®Œå…¨æ¢å¾©äº†ï¼Œä½†èº«é«”è®Šå¾—é²éˆã€‚", "ç²å¾—ç‹€æ…‹ï¼šæ‡¶æƒ°çš„è©›å’’ (æŒçºŒ10å ´æˆ°é¬¥)", "ğŸ›Œ");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    resolveSlothPass() {
        const dmg = Math.floor(Player.hp * 0.3);
        Player.hp = Math.floor(Player.hp * 0.7);
        Player.gold += 2000;
        this.renderEvent("ğŸ» æ„å¿—åŠ›", "ä½ æˆ°å‹äº†ç¡æ„ï¼Œåœ¨è·¯é‚Šç™¼ç¾äº†éŒ¢è¢‹ã€‚", `HP -${dmg}, ç²å¾— 2000 G`, "ğŸ’ª");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    // 5. è²ªå©ª
    handleGreedEvent() {
        this.renderEvent("ğŸ· é»ƒé‡‘ç‹åº§", "å²èŠå§†ç‹åº§å †æ»¿äº†å¯¶çŸ³ã€‚", "ã€Œæ‹¿å»å§ï¼Œåªè¦ä½ èƒ½æ‰¿å—...ã€", "ğŸ‘‘");
        this.setButtons("æ‹¿å–å¤§é‡ (5è¬G+è©›å’’)", "resolveGreedTake", "å…¨éƒ¨éƒ½è¦ (BOSSæˆ°)", "resolveGreedFight", false);
    },
    resolveGreedTake() {
        Player.gold += 50000;
        Player.sinState.greedActive = true;
        Player.debuff = CONFIG.sinBuffs.greed_shackle; // [FIX] æ”¹ç‚º debuff
        this.renderEvent("ğŸ· è²ªå©ªçš„ä»£åƒ¹", "ä½ æ‹¿èµ°äº† 50,000 Gï¼Œä½†èº«é«”è®Šå¾—æ²‰é‡ã€‚", "ç²å¾—ç‹€æ…‹ï¼šé»ƒé‡‘æ·é– (å—å‚·+20%)", "ğŸ’°");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    resolveGreedFight() {
        const hp = Math.min(333333, Math.max(1000, Player.gold)); 
        const enemy = { 
            ...CONFIG.sinMonsters[2], 
            hp: hp, maxHp: hp, 
            isSin: true, sinType: 'greed' 
        };
        this.triggerCombatWithEnemy(enemy, false);
    },

    // 6. æš´é£Ÿ
    handleGluttonyEvent() {
        this.renderEvent("ğŸ² æœ€å¾Œçš„æ™šé¤", "é•·æ¡Œä¸Šæ“ºæ»¿äº†è…çˆ›ä½†èª˜äººçš„é£Ÿç‰©ã€‚", "é£¢é¤“æ„Ÿçˆ†ç™¼ï¼Œä½ æƒ³åå™¬ä¸€åˆ‡ã€‚", "ğŸ–");
        this.setButtons("å¤§å¿«æœµé ¤ (æ¶ˆè€—å“å…¨ç©º)", "resolveGluttonyEat", "ç»ç¥­è£å‚™ (80%åå™¬)", "resolveGluttonySacrifice", false);
    },
    resolveGluttonyEat() {
        // [FIX] æ”¹ç‚ºå¢åŠ æ°¸ä¹…ç”Ÿå‘½åŠ æˆï¼Œé¿å…è¢« recalcStats é‡ç½®
        Player.permanentHpBonus = (Player.permanentHpBonus || 0) + 50;
        
        // ç‚ºäº†è®“ UI ç«‹å³åæ‡‰ï¼Œæ‰‹å‹•æ›´æ–°ä¸€ä¸‹ maxHp (æˆ–å‘¼å« recalcStats ä¹Ÿå¯ä»¥)
        Player.maxHp += 50; 
        Player.hp = Player.maxHp;
        if (Player.inventory.consumable.length > 0) {
            Player.inventory.consumable = [];
            this.renderEvent("ğŸ² æš´é£²æš´é£Ÿ", "ä½ åƒå…‰äº†èƒŒåŒ…è£¡æ‰€æœ‰è—¥æ°´ï¼", "MaxHP +50ï¼Œæ¶ˆè€—å“æ¸…ç©ºã€‚", "ğŸ˜‹");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.5);
            this.renderEvent("ğŸ² é£¢ä¸æ“‡é£Ÿ", "èƒŒåŒ…è£¡æ²’æœ‰é£Ÿç‰©ï¼Œä½ å•ƒé£Ÿäº†è‡ªå·±çš„æ‰‹è‡‚...", "MaxHP +50ï¼ŒHP æ¸›åŠã€‚", "ğŸ©¸");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    resolveGluttonySacrifice() {
        if (Math.random() < 0.8) {
             let allEq = [...Player.inventory.equipment];
             if (allEq.length > 0) {
                 const ate = allEq[Math.floor(Math.random() * allEq.length)];
                 this.removeItemFromInventory(ate);
                 const reward = CONFIG.sinItems.find(i => i.id === 'acc_gluttony');
                 this.addItemToInventory({...reward});
                 this.renderEvent("ğŸ² æš´é£Ÿçš„è³è³œ", `æ¡Œå­åå™¬äº† ${ate.name}ï¼Œåå‡ºäº†å¯¶ç‰©ã€‚`, `ç²å¾— <span class='rarity-mythic'>${reward.name}</span>`, "ğŸ");
             } else {
                 this.renderEvent("ğŸ² ä»€éº¼éƒ½æ²’ç™¼ç”Ÿ", "ä½ æ²’æœ‰è£å‚™å¯ä»¥ç»ç¥­ã€‚", "", "ğŸ•¸ï¸");
             }
        } else {
            this.renderEvent("ğŸ² æš´é£Ÿçš„æ†¤æ€’", "æ¡Œå­å°ä½ çš„ç¥­å“ä¸æ»¿æ„ã€‚", "ä»€éº¼ä¹Ÿæ²’ç™¼ç”Ÿã€‚", "ğŸ’¨");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    // 7. è‰²æ…¾
    handleLustEvent() {
        this.renderEvent("ğŸ‘™ é­…é­”çš„äº¤æ˜“", "ã€Œæƒ³è¦åŠ›é‡å—ï¼Ÿåªè¦ä¸€é»é»ä½ çš„ç²¾æ°£...ã€", "ç»å‡ºç²¾æ°£ç²å¾—åŠ›é‡ï¼Œæˆ–æ‹’çµ•èª˜æƒ‘ã€‚", "ğŸ’‹");
        
        // [NEW] æª¢æŸ¥æ˜¯å¦æœ‰ç´™æ¢
        const hasNote = Player.inventory.material.some(i => i.name === "ç´™æ¢");
        if (hasNote) {
             this.setButtons("å‡ºç¤ºç´™æ¢", "resolveLustNote", "ç»å‡ºç²¾æ°£", "resolveLustAccept", false);
        } else {
             this.setButtons("ç»å‡ºç²¾æ°£ (MaxHPæ‰£æ¸›)", "resolveLustAccept", "æ‹’çµ•èª˜æƒ‘ (-50 HP)", "resolveLustDeny", false);
        }
    },
// [NEW] ç´™æ¢é€šé—œé‚è¼¯
    resolveLustNote() {
        // [NEW] æ¨™è¨˜ï¼šé­…é­”çš„å–„è‰¯æˆå°± (è™›æ“¬ç‰©å“)
        Player.history.items.add("é­…é­”çš„å¿ƒæ„"); 
        this.checkAchievements();
        
        const perfume = CONFIG.sinItems.find(i => i.id === 'acc_lust');
        this.addItemToInventory({...perfume});
        this.renderEvent("ğŸ‘™ è‰è‰çµ²çš„æ”¾è¡Œ", "ã€ŒåŸä¾†æ˜¯ä½ ...æ—¢ç„¶æœ‰é€™å€‹ï¼Œå°±è®“ä½ é€šéå§ã€‚ã€", `ç²å¾— <span class='rarity-mythic'>${perfume.name}</span>ã€‚`, "ğŸ«");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    resolveLustAccept() {
        Player.sinState.lustActive = true;
        Player.debuff = CONFIG.sinBuffs.lust_charm; // [FIX] æ”¹ç‚º debuff
        const reward = CONFIG.sinItems.find(i => i.id === 'acc_lust');
        this.addItemToInventory({...reward});
        this.renderEvent("ğŸ‘™ è‡´å‘½çš„æ­¡æ„‰", "ä½ æ„Ÿåˆ°èº«é«”è¢«æç©ºï¼Œä½†ç²å¾—äº†ç¥ç§˜é¦™æ°´ã€‚", `ç²å¾— <span class='rarity-mythic'>${reward.name}</span>ï¼Œç²å¾—æ°¸ä¹…Debuffã€‚`, "ğŸ’„");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    resolveLustDeny() {
        Player.hp = Math.max(1, Player.hp - 50);
        this.renderEvent("ğŸ‘™ é­…é­”çš„ç¾æ€’", "ã€Œä¸è­˜å¥½æ­¹ï¼ã€", "HP -50", "ğŸ’¢");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    // è¼”åŠ©ï¼šç§»é™¤ç‰©å“
    removeItemFromInventory(item) {
        ['equipment', 'accessory', 'consumable', 'material'].forEach(cat => {
            const idx = Player.inventory[cat].indexOf(item);
            if(idx > -1) Player.inventory[cat].splice(idx, 1);
        });
    },

    // è¼”åŠ©ï¼šè§¸ç™¼ç‰¹å®šæˆ°é¬¥
triggerCombatWithEnemy(enemyData, canFlee) {
        GameState.phase = "combat";
        GameState.combatTurn = 0;
        GameState.enemyDominated = false;

        // --- [NEW] ç…‰ç„æ€ªç‰©ç‹€æ…‹åˆå§‹åŒ– ---
        enemyData.undyingTriggered = false; // å¢®è½é¨å£«ï¼šä¸æ­»æ„å¿—æ˜¯å¦å·²è§¸ç™¼
        enemyData.rageStack = 0;            // èˆŠæ—¥æ”¯é…è€…ï¼šç²¾ç¥å´©å£å±¤æ•¸

        // --- [NEW] è‰è‰çµ²åŠ©æˆ°åˆ¤å®š ---
        if (enemyData.isGod && Player.inventory.material.some(i => i.name === "ç´™æ¢") && !Player.lilithBlessing && !Player.lilithSacrificed) {
            Player.lilithBlessing = true;
            Player.maxHp += 10000;
            Player.hp = Player.maxHp;
            
            this.showFloatingText("ğŸ’— è‰è‰çµ²åƒæˆ°!", "#ff69b4");
            setTimeout(() => {
                alert("ğŸ’— è‰è‰çµ²å‡ºç¾äº†ï¼\n\nã€Œæˆ‘å°±é™ªä½ ç˜‹é€™ä¸€æ¬¡å§ã€‚ã€\n\n(ç²å¾—ç‹€æ…‹ï¼šè‰è‰çµ²çš„ç¥ç¦ï¼Œç”Ÿå‘½ +10000)");
                this.checkAchievements();
            }, 100);
        }

        // --- [FIX] åŸç½ªä¹‹å† å¼·åŒ–é‚è¼¯ä¿®æ­£ ---
        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªä¹‹å† ");
        if (hasCrown && !enemyData.isGod && !enemyData.isTrueForm && !enemyData.name.includes("åŸåˆ") && !enemyData.isSin && !enemyData.isGardenBoss) { 
            enemyData.name = "åŸåˆ " + enemyData.name;
            enemyData.hp *= 2;
            enemyData.atk *= 2;
            enemyData.maxHp = enemyData.hp; 
            this.showFloatingText("ä¸–ç•Œæ­£åœ¨å´©å¡Œ...", "#ff0000");
        }
        
        enemyData.maxHp = enemyData.maxHp || enemyData.hp;
        GameState.currentEnemy = enemyData;
        
        let iconClass = "monster-icon glow-inferno";
        if (enemyData.tier === 'boss') iconClass += " monster-boss glow-red";
        if (enemyData.isGod) iconClass = "monster-icon glow-void"; 
        
        if (Player.lilithBlessing) document.body.style.boxShadow = "inset 0 0 50px #ff69b4";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');

        this.renderEvent(`âš”ï¸ ${enemyData.name}`, 
            `HP: ${enemyData.hp} | æ”»æ“Š: ${enemyData.atk}`, 
            "ç‰¹æ®Šæˆ°é¬¥é–‹å§‹ï¼", enemyData.icon);

        const iconEl = document.getElementById('event-icon');
        iconEl.onclick = () => Game.inspectEnemy(); 
        iconEl.style.cursor = "help"; 
        
        // --- [FIX] ä¿®æ”¹é€ƒè·‘é‚è¼¯ï¼šæ’é™¤ç‰¹å®šçš„ç…‰ç„ BOSS ---
        // å®šç¾©å¯ä»¥é€ƒè·‘çš„ BOSS åç¨±é—œéµå­—
        const escapableBosses = ['é®®è¡€ä¼¯çˆµ', 'å·«å¦–ç‹', 'æ·±æ·µé­”é¾'];
        const isEscapable = escapableBosses.some(name => enemyData.name.includes(name));

        // åˆ¤æ–·æ˜¯å¦å¼·åˆ¶ç¦æ­¢é€ƒè·‘ï¼š
        // 1. æ˜¯ç¥ã€ä¸ƒå®—ç½ªã€èˆŠæ—¥æ”¯é…è€… -> ç¦æ­¢
        // 2. æ˜¯ BOSS éšç´š ä¸” åå­—ä¸åœ¨å¯é€ƒè·‘åå–®å…§ -> ç¦æ­¢
        const forceNoFlee = (
            enemyData.isGod || 
            enemyData.isSin || 
            enemyData.isOldOne || 
            (enemyData.tier === 'boss' && !isEscapable)
        ) && !enemyData.isGardenBoss;
        // ------------------------------------------------

        this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", forceNoFlee);

        // æ‡¶æƒ°è©›å’’é‚è¼¯
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main'); 
            const btnSub = document.getElementById('btn-sub');   
            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ‡¶æƒ° (ç„¡æ³•æ”»æ“Š)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";
            btnSub.disabled = false;
            btnSub.innerText = "é€ƒè·‘";
        } else {
            document.getElementById('btn-main').disabled = false;
            document.getElementById('btn-main').style.opacity = "1";
            document.getElementById('btn-main').style.cursor = "pointer";
        }
    },

checkSinCollection() {
        // å°‡ w_wrath æ”¹ç‚º acc_wrath
        const required = ['acc_pride', 'acc_envy', 'acc_wrath', 'acc_sloth', 'acc_greed', 'acc_gluttony', 'acc_lust'];
        const hasAll = required.every(id => {
            const itemDef = CONFIG.sinItems.find(i => i.id === id);
            // é€™è£¡éœ€è¦ç”¨ itemDef.name ä¾†æª¢æŸ¥æ­·å²ç´€éŒ„
            return Player.history.items.has(itemDef.name);
        });
        if (hasAll && !Player.history.items.has("åŸç½ªä¹‹å† ")) {
            const crown = CONFIG.sinItems.find(i => i.id === 'm_crown_sin');
            this.addItemToInventory({...crown});
            this.checkAchievements(); // æª¢æŸ¥ç½ªæƒ¡ä¹‹äººæˆå°±
            alert("ğŸ‘‘ ã€åŸç½ªä¹‹å† ã€‘ é™è‡¨ï¼\n\nä½ é›†é½Šäº†ä¸ƒå®—ç½ªï¼Œç²å¾—äº†æŒ‘æˆ°çœŸç¥çš„è³‡æ ¼ã€‚");
        }
    },
    // --- Stats Calculation ---
    getAtk() {
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_chaos') {
            let dmg = Math.floor(Math.random() * 4501) + 500; // 500 ~ 5000
            // åŠ ä¸Šè¡€ä¹‹å¥‘ç´„çš„åŠ æˆ
            dmg += Player.bloodContractAtk;
            // å‚²æ…¢åŠ æˆ
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_pride')) dmg = Math.floor(dmg * 1.5);
            return dmg;
        }

        let atk = Player.baseAtk;
        if (Player.equipment.weapon) atk += Player.equipment.weapon.val;
        
        // [NEW] è¡€ä¹‹å¥‘ç´„åŠ æˆ
        atk += Player.bloodContractAtk;

        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id.includes('troll')) {
                if(acc.id === 'acc_troll_1') atk += 10;
                if(acc.id === 'acc_troll_2') atk += 20;
                if(acc.id === 'acc_troll_3') atk += 35;
            }
            if(acc.id.includes('demon')) {
                if(acc.id === 'acc_demon_1') atk += 10;
                if(acc.id === 'acc_demon_2') atk += 20;
                if(acc.id === 'acc_demon_3') atk += 40;
            }
            if(acc.id === 'acc_chaos') {
                atk = Math.floor(atk * Player.chaosRoll);
            }
            // [æ–°å¢] è¶…è¶Šé­”æ–¹å€ç‡
            if(acc.id === 'acc_transcendence') {
                atk = Math.floor(atk * Player.transcendenceRoll);
            }

            if(acc.id === 'acc_wrath') atk += 1000;
            // [NEW] å‚²æ…¢ä¹‹çœ¼ï¼šæ”»æ“ŠåŠ› +50%
            if(acc.id === 'acc_pride') atk = Math.floor(atk * 2.0);
        });

        // [NEW] äº¡è€…é …éŠ (éˆé­‚å‹æ…‹æ”»æ“Šç¿»å€)
        if (Player.ghostTurns > 0) atk *= 2;

        // [NEW] å¤¢é­˜ç©¿åˆºè€… (é¦–å›åˆåŠ å€)
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_nightmare' && GameState.combatTurn === 1) {
            atk *= 2;
        }
// [NEW] åŸåˆä¹‹åŠï¼šç¸½æ”»æ“ŠåŠ› 1.5 å€
    if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_primordial') {
        atk = Math.floor(atk * 1.5);
    }
        return atk;
    },

    getCritRate(returnRaw = false) {
        // [MODIFIED] åŸºç¤ 5% + æ°¸ä¹…ç´¯ç©çš„æš´æ“Šç‡ (ç‰›é ­äººæˆ°æ–§)
        let rate = 0.05 + (Player.permanentCritBonus || 0);

        // è™•ç† Buff åŠ æˆ
        if (Player.buff) {
            if (Player.buff.id === 'angel_courage') rate += 0.20; // æ”¹ç‚º += ç´¯åŠ 
            if (Player.buff.id === 'demon_enhance') rate = 0.50;  // å›ºå®šå€¼
        }

        // è™•ç†é£¾å“åŠ æˆ
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            // èˆŠæœ‰é£¾å“
            if(acc.id === 'acc_wolf_1') rate += 0.01;
            if(acc.id === 'acc_wolf_2') rate += 0.03;
            if(acc.id === 'acc_wolf_3') rate += 0.08;
            if(acc.id === 'acc_demon_1') rate += 0.02;
            if(acc.id === 'acc_demon_2') rate += 0.05;
            if(acc.id === 'acc_demon_3') rate += 0.20;
            
            // [NEW] ç´…å¸ƒæ•ˆæœ
            if(acc.id === 'acc_red_cloth') rate += 0.10; 

            // å‘½é‹ä¹‹è¼ª (è‹¥éå›å‚³åŸå§‹å€¼ï¼Œå‰‡æš´æ“Šç‡æ­¸é›¶è½‰ç‚ºå‚·å®³)
            if(acc.id === 'acc_wheel' && !returnRaw) rate = 0; 
        });
        
        let percent = Math.round(rate * 100);
        return percent > 100 ? 100 : percent;
    },

    recalcStats() {
        const currentRatio = Player.maxHp > 0 ? Player.hp / Player.maxHp : 1; 
        let bonusHp = Player.equipment.armor ? Player.equipment.armor.val : 0;
        
        // ... (é£¾å“åŠ æˆçœç•¥ - ä¿æŒåŸæœ¬çš„ accessory è¿´åœˆ) ...
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id.includes('golem')) {
                if(acc.id === 'acc_golem_1') bonusHp += 30;
                if(acc.id === 'acc_golem_2') bonusHp += 100;
                if(acc.id === 'acc_golem_3') bonusHp += 200;
            }
            if(acc.id.includes('demon')) {
                if(acc.id === 'acc_demon_1') bonusHp += 10;
                if(acc.id === 'acc_demon_2') bonusHp += 20;
                if(acc.id === 'acc_demon_3') bonusHp += 40;
            }
        });
        
        // [FIX] ä¿®æ­£ï¼šåŸºç¤å€¼ + è£å‚™ + æ°¸ä¹…åŠ æˆ + è‰è‰çµ²åŠ æˆ
        let newMaxHp = Player.baseMaxHp + bonusHp + (Player.permanentHpBonus || 0);
        
        // [NEW] åŠ ä¸Šè‰è‰çµ²çš„ç¥ç¦ (+10000)
        if (Player.lilithBlessing || Player.lilithSacrificed) {
            newMaxHp += 10000;
        }

        // [NEW] åŠ ä¸Šæœ€å¾Œçš„é¼“èˆ (+6666)
        if (Player.lastInspirationTurns > 0) {
            newMaxHp += 6666;
        }
        
        // [NEW] è¡€ä¹‹å¥‘ç´„æ›¸é‚è¼¯ (MaxHP æ¸›åŠï¼Œè½‰ç‚º Atk)
        Player.bloodContractAtk = 0;
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_blood')) {
            let removedHp = Math.floor(newMaxHp * 0.5);
            newMaxHp -= removedHp;
            Player.bloodContractAtk = removedHp;
        }

        Player.maxHp = newMaxHp;
        
        // ä¿æŒç•¶å‰è¡€é‡æ¯”ä¾‹
        let newHp = Math.round(currentRatio * Player.maxHp);
        Player.hp = Math.min(newHp, Player.maxHp);
        if (Player.hp <= 0 && Player.ghostTurns === 0) Player.hp = 0; 
        
        this.updateStatsUI();
    },

   // --- Core Logic ---
    nextEvent() {
        if (Player.hp <= 0) {
            this.restart();
            return;
        }

        // --- [FIX] æ··æ²Œé­”æ–¹é‚è¼¯ç§»è‡³æœ€ä¸Šæ–¹ ---
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_chaos')) {
            Player.chaosRoll = (Math.random() * 2.5 + 0.5).toFixed(2); // 0.5 - 3.0
            this.showFloatingText(`ğŸ² æ··æ²Œ: x${Player.chaosRoll}`, "#ff00ff");
        } else {
            Player.chaosRoll = 1;
        }

if (Player.equipment.accessories.some(a => a && a.id === 'acc_transcendence')) {
            Player.transcendenceRoll = (Math.random() * 4.0 + 1.0).toFixed(2);
            // å»¶é²ä¸€é»é¡¯ç¤ºï¼Œé¿å…æ–‡å­—é‡ç–Š
            setTimeout(() => Game.showFloatingText(`ğŸ§Š è¶…è¶Š: x${Player.transcendenceRoll}`, "#00ffff"), 300);
        } else {
            Player.transcendenceRoll = 1;
        }
        // ----------------------------------

                // 2. è‰²æ…¾æ‰£è¡€
        if (Player.sinState.lustActive) {
            const drain = Math.floor(Player.maxHp * 0.10);
            Player.hp = Math.max(1, Player.hp - drain);
            this.showFloatingText(`åªšæ°£ -${drain} HP`, "#ff00ff");
        }

        Player.depth++;
        this.checkAchievements();
        // [NEW] æª¢æŸ¥åŸç½ªæ”¶é›†
        this.checkSinCollection();
        
        // --- ç…‰ç„ä¹‹é–€è§¸ç™¼é‚è¼¯ ---
        const hasBibleInBag = Player.inventory.material.some(i => i.name === "ç…‰ç„è–ç¶“");
        
        if (!Player.inInferno && hasBibleInBag) {
            this.triggerInfernoGate();
            return;
        }

        // --- é€²å…¥ç…‰ç„ä¸–ç•Œé‚è¼¯ ---
        if (Player.inInferno) {
if (Player.depth === 1) {
                const hasNote = Player.inventory.material.some(i => i.name === "ç´™æ¢");
                const hasSword = Player.inventory.equipment.some(i => i.name === "ç¥è–å…‰åŠ") || Player.equipment.weapon?.name === "ç¥è–å…‰åŠ";
                
                if (hasNote && !hasSword) {
                    GameState.phase = "event_end";
                    const sword = {...CONFIG.specialItems.holy_sword};
                    this.addItemToInventory(sword);
                    this.renderEvent("âš”ï¸ è‰è‰çµ²çš„é¤½è´ˆ", "ã€Œæ‹¿è‘—é€™å€‹ï¼Œåœ¨é€™è£¡æ´»ä¸‹å»ã€‚ã€", `å› ç‚ºæŒæœ‰ç´™æ¢ï¼Œä½ ç²å¾—äº† <span class='rarity-mythic'>${sword.name}</span>ï¼`, "ğŸ");
                    // æŒ‰ä¸‹ç¹¼çºŒå¾Œï¼Œç‚ºäº†ä¸æµªè²»ç¬¬ä¸€å±¤ï¼Œæˆ‘å€‘å¼·åˆ¶å‘¼å« processInfernoEvent
                    this.setButtons("ç¹¼çºŒ", "processInfernoEvent", "ç„¡", null, true); 
                    return;
                }
            }
            this.log(`>>> ğŸ”¥ [ç…‰ç„] ç¬¬ ${Player.depth} å±¤`);
            this.processInfernoEvent();
            return;
        }

        // --- èˆŠä¸–ç•Œé‚è¼¯ ---
        this.log(`>>> é€²å…¥ç¬¬ ${Player.depth} å±¤æ¢ç´¢...`);
        this.processNormalEvent();
    },

    processNormalEvent() {
        // Regen Logic
        let regen = 0;
        if (Player.buff && Player.buff.id === 'angel_song') regen += 5;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_slime_2') regen += 2;
            if(acc.id === 'acc_slime_3') regen += 10;
        });
        if (regen > 0 && Player.hp < Player.maxHp) {
            Player.hp = Math.min(Player.maxHp, Player.hp + regen);
            this.showFloatingText(`+${regen} HP`, "#69f0ae");
        }
if (Math.random() < 0.01) {
            this.triggerFairyEvent();
            this.updateUI();
            return;
        }
        // Event Tree
        if (Player.depth >= 1000 && (Player.depth - 1000) % 500 === 0) {
            this.triggerCombat(true, true); 
            this.updateUI();
            return;
        }
        if (Player.depth === 500) {
            this.triggerCombat(true, false); 
            this.updateUI();
            return;
        }
        if (Player.depth === 501) alert("è­¦å‘Šï¼šä½ å·²é€²å…¥æ·±å±¤é ˜åŸŸï¼");

        if (Player.depth > 100 && Math.random() < 0.005) {
            this.triggerTrip();
            this.updateUI();
            return;
        }

if (Math.random() < 0.005) {
            this.triggerSuccubusEvent();
            this.updateUI();
            return;
        }

        if (Player.depth > 200 && Math.random() < 0.005) {
            this.triggerHarpy();
            this.updateUI();
            return;
        }

        const rand = Math.random();
        if (rand < 0.03) this.triggerCraftingTable();
        else if (rand < 0.08) this.triggerHeal();
        else if (rand < 0.13) this.triggerStatue();
        else if (rand < 0.16) this.triggerClassEvent();
        else if (rand < 0.33) this.triggerMerchant();
        else if (rand < 0.43) this.triggerChest();
        else this.triggerCombat(false, false);
        
        this.updateUI();
    },

   processInfernoEvent() {
        // [NEW] å¯§éœçš„èŠ±åœ’ (0.05% æ©Ÿç‡) - ä¿æŒåœ¨æœ€å„ªå…ˆï¼Œå› ç‚ºæ˜¯æ¥µç¨€æœ‰äº‹ä»¶
        if (Math.random() < 0.0005) {
            this.triggerGardenEvent();
            return;
        }

        // --- [NEW] B. ç¬¬ 10 å±¤ä¿åº•è§¸ç™¼å²èŠå§†é•·è€ ---
        if (Player.depth === 10) {
            this.log(">>> ç¬¬ 10 å±¤ä¿åº•è§¸ç™¼: å²èŠå§†é•·è€");
            this.triggerSlimeElderEvent();
            return;
        }
        // ---------------------------------------

        const rand = Math.random();
        // [NEW] 1% æ©Ÿç‡è§¸ç™¼å²èŠå§†é•·è€ (ç¨ç«‹åˆ¤å®šï¼Œä¸å ç”¨ rand åºåˆ—)
        if (Math.random() < 0.01) { 
            this.triggerSlimeElderEvent(); 
            return; 
        }

        if (Math.random() < 0.005) { 
            this.triggerInfernoHarpy(); 
            return; 
        }

        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªä¹‹å† ");
        if (hasCrown && Math.random() < 0.05) {
             this.triggerDeadStatue(); 
             return; 
        }
        
        // 1. ä¸ƒå®—ç½ª (1%)
        if (rand < 0.01) { this.triggerSinEvent(); return; }

        // 2. ç…‰ç„çˆç« (5%) -> 0.01 + 0.05 = 0.06
        if (rand < 0.06) { this.triggerInfernoForge(); return; }

        // 3. ç±³è«¾æ¿¤è«¾æ–¯çš„è¿·å®® (3%) -> 0.06 + 0.03 = 0.09
        if (rand < 0.09) { this.triggerMinotaurMaze(); return; }

        // å¾ŒçºŒæ©Ÿç‡é †å»¶
        // 4. æƒ¡é­”å•†äºº (10%) -> 0.19
        if (rand < 0.19) { this.triggerDemonMerchant(); } 
        // 5. è™›ç©ºè£‚éš™ (10%) -> 0.29
        else if (rand < 0.29) { this.triggerVoidRift(); } 
        // 6. é®®è¡€ç¥­å£‡ (10%) -> 0.39
        else if (rand < 0.39) { this.triggerBloodAltar(); }
        // 7. ç‰›é ­äººäº‚å…¥ (æ”¹ç‚º 3%) -> 0.39 + 0.03 = 0.42
        else if (rand < 0.42) { this.triggerMinotaur(); }
        // 8. ç…‰ç„æ­»é¬¥ (å‰©é¤˜)
        else { this.triggerInfernoCombat(); }
        
        this.updateUI();
    },

showLilith() {
        const iconEl = document.getElementById('event-icon');
        iconEl.innerHTML = LILITH_HTML;
        // [MODIFIED] åŠ ä¸Šé­…é­”ç™¼å…‰ç‰¹æ•ˆ
        iconEl.className = 'lilith-glow'; 
        iconEl.style.overflow = 'visible'; 
    },

    // [MODIFIED] é­…é­”äº‹ä»¶éˆ (ä½¿ç”¨ CSS Art)
    triggerSuccubusEvent() {
        GameState.phase = "event_end";
        // ç§»é™¤ç”Ÿæˆå‹•ç•«ï¼Œå› ç‚ºæˆ‘å€‘è¦ç›´æ¥æ¸²æŸ“è¤‡é›œ HTML
        // this.triggerAnim('event-icon', 'anim-spawn'); 
        
        const hasChocolate = Player.inventory.material.some(i => i.name === "å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›");
        const stage = Player.succubusStage;

        // Stage A (0): åˆé‡
        if (stage === 0) {
            this.renderEvent("?? å€’ä¸‹çš„å¥³å­©", "æœ‰å€‹å¥³å­©æ˜å€’åœ¨è·¯é‚Š...", "å¥¹çœ‹èµ·ä¾†è‡‰è‰²è’¼ç™½ã€‚", null);
            this.showLilith(); // <--- æ›¿æ› Emoji
            
            if (hasChocolate) {
                this.setButtons("å«é†’ (çµ¦å·§å…‹åŠ›)", "resolveSuccubusA_Give", "ç„¡è¦–", "nextEvent", false);
            } else {
                this.setButtons("å«é†’ (-20HP)", "resolveSuccubusA_Wake", "ç„¡è¦–", "nextEvent", false);
            }
        }
        // Stage B (1): èªè­˜
        else if (stage === 1) {
            this.renderEvent("ğŸ‘© å†æ¬¡ç›¸é‡", "é­…é­”å°ä½ ä¸Šæ¬¡çš„æ•‘åŠ©è¡¨é”äº†æ„Ÿè¬ã€‚", "å¥¹çœ‹èµ·ä¾†ç²¾ç¥å¥½å¤šäº†ã€‚", null);
            this.showLilith(); // <--- æ›¿æ› Emoji

            if (hasChocolate) {
                this.setButtons("çµ¦äºˆå·§å…‹åŠ›", "resolveSuccubusB_Give", "è¡¨ç¤ºåªæ˜¯èˆ‰æ‰‹ä¹‹å‹", "resolveSuccubusHeal", false);
            } else {
                this.setButtons("è¡¨ç¤ºåªæ˜¯èˆ‰æ‰‹ä¹‹å‹", "resolveSuccubusHeal", "ç„¡", null, true);
            }
        }
        // Stage C (2): å®³ç¾
        else if (stage === 2) {
            this.renderEvent("ğŸ˜³ å®³ç¾çš„é­…é­”", "é­…é­”çœ‹è¦‹ä½ ï¼Œè‡‰é °æ³›èµ·ç´…æšˆã€‚", "å¥¹ä¼¼ä¹æœ‰è©±æƒ³èªª...", null);
            this.showLilith(); // <--- æ›¿æ› Emoji

            if (hasChocolate) {
                this.setButtons("çµ¦äºˆå·§å…‹åŠ›", "resolveSuccubusC_Give", "èŠèŠå¤©", "resolveSuccubusHeal", false); 
            } else {
                this.setButtons("èŠèŠå¤©", "resolveSuccubusHeal", "ç„¡", null, true);
            }
        }
        // Stage 3: å®Œæˆ (å›è¡€)
        else {
            this.renderEvent("â¤ï¸ é­…é­”è‰è‰çµ²", "ã€Œå†’éšªè¾›è‹¦äº†ï¼Œè®“æˆ‘å¹«ä½ æ²»ç™‚å§ã€‚ã€", "HP å®Œå…¨æ¢å¾©ã€‚", null);
            this.showLilith(); // <--- æ›¿æ› Emoji
            Player.hp = Player.maxHp;
            this.setButtons("è¬è¬", "nextEvent", "ç„¡", null, true);
        }
    },

// [NEW] å²èŠå§†é•·è€äº‹ä»¶ (ç…‰ç„ä¸–ç•Œ)
    // [NEW] å²èŠå§†é•·è€äº‹ä»¶ (ç…‰ç„ä¸–ç•Œ)
    triggerSlimeElderEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        // æª¢æŸ¥å¼·åŒ–æ¬¡æ•¸ä¸Šé™ (5æ¬¡)
        if (Player.elderEnhanceCount >= 5) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent("ğŸ‘‘ å²èŠå§†é•·è€", "é•·è€é©šè¨åœ°çœ‹è‘—ä½ ã€‚", "ã€Œä½ æ•£ç™¼è‘—ä¸å¯æ€è­°çš„å…‰èŠ’...é€™æ ¹ç¾½æ¯›é€çµ¦ä½ ã€‚ã€<br>ç²å¾— <span class='rarity-legendary'>ä¸æ­»é³¥çš„ç¾½æ¯›</span>", "ğŸ‘´");
            this.setButtons("è¬è¬é•·è€", "nextEvent", "ç„¡", null, true);
            return;
        }

        this.renderEvent("ğŸ‘‘ å²èŠå§†é•·è€", "ä¸€éš»æˆ´è‘—çš‡å† çš„å·¨å¤§å²èŠå§†æ“‹ä½äº†è·¯ã€‚", `ã€Œå¹´è¼•äººï¼Œè‹¥ä½ é¡˜æ„æ¨æ£„èº«å¤–ä¹‹ç‰© (${Player.gold} G)ï¼Œè€å¤«å¯ä»¥å‚³æˆä½ ç…‰ç„çš„ç”Ÿå­˜ä¹‹é“ã€‚ã€<br>(ç›®å‰å¼·åŒ–: ${Player.elderEnhanceCount}/5)`, "ğŸ‘´");
        
        if (Player.gold <= 0) {
            this.setButtons("èº«ç„¡åˆ†æ–‡...", "nextEvent", "ç„¡", null, true);
        } else {
            // [ä¿®æ”¹] æŒ‰éˆ•æ–‡å­—æ”¹ç‚º HP+600/æ”»+600
            this.setButtons("å‚¾å®¶è•©ç”¢ (HP+600/æ”»+600)", "resolveElderEnhance", "æ‹’çµ•", "nextEvent", false);
        }
    },

    resolveElderEnhance() {
        // [FIX] å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœå·²ç¶“æ»¿äº†ï¼Œç›´æ¥ä¸­æ–·
        if (Player.elderEnhanceCount >= 5) {
            alert("ä½ çš„ç…‰ç„ä¹‹åŠ›å·²é”æ¥µé™ï¼");
            this.nextEvent();
            return;
        }

        // åŸæœ¬çš„é‚è¼¯...
        Player.gold = 0;
        Player.elderEnhanceCount++;
        
        // [ä¿®æ”¹] æ•¸å€¼æ”¹ç‚º +600
        Player.baseMaxHp += 600;
        Player.maxHp += 600;
        Player.hp += 600;
        Player.baseAtk += 600;
        
        this.showFloatingText("ç…‰ç„ä¹‹åŠ›è¦ºé†’!", "#ff0000");
        // [ä¿®æ”¹] äº‹ä»¶æè¿°æ–‡å­—æ”¹ç‚º +600
        this.renderEvent("ğŸ‘‘ é•·è€çš„å‚³æ‰¿", "ä½ çš„é‡‘å¹£è¢«é•·è€åå™¬ï¼ŒåŒ–ç‚ºç´”ç²¹çš„åŠ›é‡ï¼", `æœ€å¤§ç”Ÿå‘½ +600 / åŸºç¤æ”»æ“Š +600<br>(å·²å¼·åŒ– ${Player.elderEnhanceCount}/5 æ¬¡)`, "ğŸ’ª");
        this.setButtons("æ„Ÿè¬æŒ‡é»", "nextEvent", "ç„¡", null, true);
        this.updateUI();
        this.checkAchievements(); 
    },
    
    // å­äº‹ä»¶ä¹Ÿè¦è¨˜å¾—åŠ ä¸Š this.showLilith()ï¼Œä¸ç„¶ç•«é¢æ›´æ–°æ™‚åœ–æ¡ˆæœƒæ¶ˆå¤±
    resolveSuccubusA_Wake() {
        Player.hp = Math.max(1, Player.hp - 20);
        this.renderEvent("ğŸ˜µ è¢«å¸å–ç²¾æ°£", "ä½ è©¦åœ–å«é†’å¥¹ï¼Œå»æ„Ÿè¦ºé«”åŠ›æµå¤±...", "HP -20", null);
        this.showLilith();
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    resolveSuccubusA_Give() {
        this.removeSpecificItem("å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›");
        Player.succubusStage = 1;
        this.renderEvent("ğŸ« æ¢å¾©ç²¾ç¥", "å¥¹åƒä¸‹å·§å…‹åŠ›å¾Œï¼Œè‡‰è‰²ç´…æ½¤äº†èµ·ä¾†ã€‚", "é›–ç„¶æ²’æœ‰èªªè©±ï¼Œä½†å¥¹æ„Ÿæ¿€åœ°çœ‹äº†ä½ ä¸€çœ¼å¾Œé›¢é–‹äº†ã€‚", null);
        this.showLilith();
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    resolveSuccubusB_Give() {
        this.removeSpecificItem("å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›");
        Player.succubusStage = 2;
        Player.hp = Player.maxHp;
        this.renderEvent("ğŸ« é–‹å¿ƒçš„é­…é­”", "å¥¹é–‹å¿ƒåœ°æ”¶ä¸‹äº†å·§å…‹åŠ›ï¼", "é­…é­”å¹«ä½ æ¢å¾©äº†æ‰€æœ‰ HPã€‚", null);
        this.showLilith();
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    resolveSuccubusC_Give() {
        this.removeSpecificItem("å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›");
        Player.succubusStage = 3;
        Player.hp = Math.max(1, Player.hp - 10);
        this.addItemToInventory({...CONFIG.specialItems.note});
        this.renderEvent("ğŸ¥° é­…é­”çš„çœŸå", "å¥¹å®³ç¾åœ°æŠ±äº†ä½ ä¸€ä¸‹ (HP -10)ï¼Œä¸¦å¡çµ¦ä½ ä¸€å¼µç´™æ¢ã€‚", "ç²å¾—ã€ç´™æ¢ã€‘ã€‚", null);
        this.showLilith();
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    resolveSuccubusHeal() {
        Player.hp = Player.maxHp;
        this.renderEvent("âœ¨ é­…é­”çš„å ±æ©", "ã€Œé€™æ˜¯æˆ‘çš„è¬ç¦®ã€‚ã€", "HP å®Œå…¨æ¢å¾©ã€‚", null);
        this.showLilith();
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

removeSpecificItem(name) {
        const idx = Player.inventory.material.findIndex(i => i.name === name);
        if(idx > -1) Player.inventory.material.splice(idx, 1);
    },


triggerFairyEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        // æª¢æŸ¥å¼·åŒ–æ¬¡æ•¸ä¸Šé™ (5æ¬¡)
        if (Player.fairyEnhanceCount >= 5) {
            Player.hp = Player.maxHp;
            this.renderEvent("ğŸ§š ç²¾éˆçš„ç¥ç¦", "ç²¾éˆå¾®ç¬‘è‘—çœ‹è‘—ä½ ã€‚", "ã€Œä½ çš„éˆé­‚å·²ç¶“è¶³å¤ å¼·å¤§äº†ã€‚ã€<br>(ç”Ÿå‘½å®Œå…¨æ¢å¾©)", "âœ¨");
            this.setButtons("è¬è¬", "nextEvent", "ç„¡", null, true);
            return;
        }

        this.renderEvent("ğŸ§š æ¹–ä¸­ç²¾éˆ", "ä¸€ä½ç™¼å…‰çš„ç²¾éˆæµ®å‡ºæ°´é¢ã€‚", `ã€Œç»ä¸Šä½ æ‰€æœ‰çš„è²¡å¯Œ (${Player.gold} G)ï¼Œæˆ‘å¯ä»¥å¼·åŒ–ä½ çš„æœ¬è³ªã€‚ã€<br>(ç›®å‰å¼·åŒ–: ${Player.fairyEnhanceCount}/5)`, "ğŸ’§");
        
        // å¦‚æœæ²’éŒ¢ï¼Œåªèƒ½é›¢é–‹
        if (Player.gold <= 0) {
            this.setButtons("æˆ‘æ²’éŒ¢...", "nextEvent", "ç„¡", null, true);
        } else {
            this.setButtons("ç»ä¸Šé‡‘å¹£ (HP+100/æ”»+100)", "resolveFairyEnhance", "æ‹’çµ•", "nextEvent", false);
        }
    },

    resolveFairyEnhance() {
    // [FIX] å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœå·²ç¶“æ»¿äº†ï¼Œç›´æ¥ä¸­æ–·
    if (Player.fairyEnhanceCount >= 5) {
        alert("ä½ çš„éˆé­‚å·²é”æ¥µé™ï¼Œç„¡æ³•å†å¼·åŒ–ï¼");
        this.nextEvent();
        return;
    }

    // åŸæœ¬çš„é‚è¼¯...
    Player.gold = 0; 
    Player.fairyEnhanceCount++;
    
    Player.baseMaxHp += 100; 
    Player.maxHp += 100;     
    Player.hp += 100;        
    Player.baseAtk += 100;
    
    this.showFloatingText("åŸºç¤èƒ½åŠ›å¤§å¹…æå‡!", "#00ffcc");
    this.renderEvent("ğŸ§š ç²¾éˆçš„é­”æ³•", "é‡‘å¹£åŒ–ç‚ºå…‰ç²‰èå…¥ä½ çš„èº«é«”ã€‚", `æœ€å¤§ç”Ÿå‘½ +100 / åŸºç¤æ”»æ“Š +100<br>(å·²å¼·åŒ– ${Player.fairyEnhanceCount}/5 æ¬¡)`, "âœ¨");
    this.setButtons("è¬è¬", "nextEvent", "ç„¡", null, true);
    this.updateUI();
    this.checkAchievements();
},

    // --- Events (Standard) ---
    triggerTrip() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-damage');
        const hookIndex = Player.inventory.material.findIndex(i => i.name === 'é‰¤å­');
        let useHook = false;
        if (hookIndex !== -1) {
            Player.inventory.material.splice(hookIndex, 1);
            useHook = true;
        }
        const isApe = Player.class === 'ape';
        const isGoodOutcome = useHook || isApe || (Math.random() < 0.3);

        if (isGoodOutcome) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            let msg = "";
            if (useHook) msg = `ä½ æ»‘å€’äº†ï¼Œä½†<span class='rarity-rare'>é‰¤å­</span>å‹¾ä½äº†å²©å£ï¼(é‰¤å­å·²æå£)<br>ä½ åœ¨å²©å£ä¸Šç™¼ç¾äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>ï¼`;
            else if (isApe) msg = `ä½ æ»‘å€’äº†ï¼Œä½†æ†‘è—‰<span class='block-text'>äººçŒ¿çš„æ•æ·</span>è¼•é¬†æŠ“ä½äº†å²©å£ï¼<br>æ„å¤–ç™¼ç¾äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>ï¼`;
            else msg = `ä½ æ»‘å€’äº†ï¼Œåœ¨åƒéˆä¸€é«®ä¹‹éš›æŠ“ä½äº†å²©å£ï¼<br>æ„å¤–ç™¼ç¾äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>ï¼`;
            this.renderEvent("ğŸ’« æ„å¤–ä¹‹å–œ", "é›–ç„¶è·Œå€’äº†...", msg, "ğŸª");
        } else {
            let lostItemName = null;
            const equippedTypes = [];
            if (Player.equipment.weapon) equippedTypes.push('weapon');
            if (Player.equipment.armor) equippedTypes.push('armor');
            if (Player.equipment.shield) equippedTypes.push('shield');

            if (equippedTypes.length > 0) {
                const lostType = equippedTypes[Math.floor(Math.random() * equippedTypes.length)];
                const item = Player.equipment[lostType];
                lostItemName = item.name;
                Player.equipment[lostType] = null;
                this.recalcStats();
                this.renderEvent("ğŸ’« è·Œå€’äº†ï¼", "åœ°é¢çªç„¶å´©å¡Œï¼Œä½ æ‘”äº†ä¸€è·¤...", `ä½ ä¸å°å¿ƒå¼„ä¸Ÿäº† <span class='damage-text'>${lostItemName}</span>ï¼`, "ğŸ¦¶");
            } else {
                const dmg = 10;
                Player.hp = Math.max(1, Player.hp - dmg);
                this.renderEvent("ğŸ’« è·Œå€’äº†ï¼", "åœ°é¢çªç„¶å´©å¡Œï¼Œä½ æ‘”äº†ä¸€è·¤...", `å¹¸å¥½èº«ä¸Šæ²’è£å‚™ï¼Œä½†æ‘”å¾—ä¸è¼• (HP -${dmg})ã€‚`, "ğŸ¦¶");
            }
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    // ... (Inferno Specifics) ...

triggerInfernoForge() {
        GameState.phase = "forge";
        GameState.forgeUsed = false;
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ”¥ ç…‰ç„çˆç«", "æ»¾ç‡™çš„å²©æ¼¿ä¸­è³ç«‹è‘—ä¸€åº§é»‘æ›œçŸ³éµç §ã€‚", "ä½ å¯ä»¥åˆ©ç”¨å®ƒæ‰“é€ ä¸€æ¬¡ç¥è©±è£å‚™ã€‚", "ğŸŒ‹");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderForgeUI();
    },

    renderForgeUI() {
        const area = document.getElementById('crafting-area');
        area.innerHTML = "";
        area.classList.remove('hidden');

        if (GameState.forgeUsed) {
            this.renderEvent("ğŸ”¥ ç†„æ»…çš„çˆç«", "çˆç«å·²ç¶“åŒ–ç‚ºä¸€æ”¤æ™®é€šçš„å²©æ¼¿ã€‚", "ç„¡æ³•å†é€²è¡Œé›é€ ã€‚", "ğŸŒ«ï¸");
            return;
        }

        let html = "<h4>ğŸ”¥ ç…‰ç„é›é€  (é™ä¸€æ¬¡)</h4><div class='craft-grid'>";
        
        CONFIG.forgeItems.forEach(item => {
            const recipe = item.recipe;
            // æª¢æŸ¥ç´ ææ˜¯å¦è¶³å¤ 
            const ownedItems = Player.inventory.material.filter(m => m.name === recipe.mat);
            const owned = ownedItems.length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';

            html += `<div class="craft-item" onclick="Game.craftForgeItem('${item.id}')">
                <div class="m-top">
                    <span>${item.icon} ${item.name}</span>
                </div>
                <div class="craft-req ${statusClass}">
                    éœ€: ${recipe.mat} (${owned}/${recipe.count})
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    craftForgeItem(itemId) {
        if (GameState.phase !== "forge" || GameState.forgeUsed) return;

        const itemTemplate = CONFIG.forgeItems.find(i => i.id === itemId);
        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æä¸è¶³ï¼");
            return;
        }

        // æ‰£é™¤ç´ æ
        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        // çµ¦äºˆè£å‚™
        this.addItemToInventory(Object.assign({}, itemTemplate));
        GameState.forgeUsed = true;
        
        this.showFloatingText("é›é€ æˆåŠŸ!", "#ff3300");
        this.renderForgeUI(); // æ›´æ–°ä»‹é¢é¡¯ç¤ºç†„æ»…ç‹€æ…‹
        this.updateUI();
        this.checkAchievements(); // æª¢æŸ¥ç¥è©±é›é€ å¸«æˆå°±
    },

    triggerInfernoGate() {
        Player.inInferno = true;
        Player.depth = 0; 
        document.body.classList.add('inferno-mode');
        GameState.phase = "event_end";
        this.triggerAnim('game-container', 'anim-screen-shake');
        this.renderEvent("ğŸ”¥ ç…‰ç„ä¹‹é–€é–‹å•Ÿ", "ç…‰ç„è–ç¶“ç‡ƒç‡’æ®†ç›¡ï¼Œå‘¨åœçš„ä¸–ç•Œå´©å¡Œé‡çµ„...", "ä½ å·²å¢®å…¥ç…‰ç„ã€‚èˆŠä¸–ç•Œçš„è¦å‰‡ä¸å†é©ç”¨ã€‚", "â›©ï¸");
        const idx = Player.inventory.material.findIndex(i => i.name === "ç…‰ç„è–ç¶“");
        if(idx > -1) Player.inventory.material.splice(idx, 1);
        this.setButtons("é¢å°ææ‡¼", "nextEvent", "ç„¡", null, true);
        this.checkAchievements(); // æª¢æŸ¥è¸å…¥åœ°ç„æˆå°±
    },
    triggerVoidRift() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸŒŒ è™›ç©ºè£‚éš™", "ç©ºé–“æ’•è£‚å‡ºä¸€é“æ¥µåº¦å±éšªçš„ç´«è‰²è£‚ç¸«ã€‚", "é«˜é¢¨éšªé«˜å›å ±ï¼š50% æ©Ÿç‡ç²å¾—ç¥è©±å¯¶ç‰©ï¼Œ50% æ©Ÿç‡é­å—é‡å‰µã€‚", "ğŸŒ€");
        this.setButtons("è§¸æ‘¸ (50%æ©Ÿç‡å—å‚·)", "resolveVoidRift", "é›¢é–‹", "nextEvent", false);
    },

    resolveVoidRift() {
        // 50% æˆåŠŸï¼Œ50% å¤±æ•—
        if (Math.random() < 0.5) {
            // --- æˆåŠŸ ---
            const roll = Math.random(); // 0.0 ~ 1.0

            if (roll < 0.01) { 
                // 1% æ©Ÿç‡ï¼šè™›ç©ºç ´æ»…åŠ
                const sword = CONFIG.infernoItems.find(i => i.id === 'w_void_breaker');
                this.addItemToInventory({...sword});
                this.renderEvent("ğŸŒŒ è™›ç©ºå¥‡è¹Ÿ", "ä½ åœ¨è£‚éš™æ·±è™•çœ‹è¦‹äº†æ¯€æ»…çš„å…‰èŠ’...", `é‹æ°£çˆ†ç™¼ï¼ç²å¾— <span class='rarity-mythic'>${sword.name}</span>`, "ğŸŒŒ");
            } 
            else if (roll < 0.50) { 
                // 49% æ©Ÿç‡ (0.01 ~ 0.50)ï¼šå¤§é‡é‡‘å¹£
                const gold = 5000 + Player.depth * 10;
                Player.gold += gold;
                this.renderEvent("ğŸŒŒ è™›ç©ºè²¡å¯Œ", "å¤§é‡çš„ç…‰ç„é‡‘å¹£å¾è£‚éš™æ¹§å‡ºï¼", `ç²å¾— <span class='gold-text'>${gold} G</span>`, "ğŸ’°");
            } 
            else { 
                // 50% æ©Ÿç‡ (0.50 ~ 1.0)ï¼šç¥è©±ç´ æ
                // å¾ lootData ä¸­ç¯©é¸ mythic ç­‰ç´š
                const mats = Object.entries(CONFIG.lootData)
                    .filter(([k, v]) => v.rarity === 'mythic')
                    .map(([k, v]) => ({...v, name: k, type: 'material'}));
                
                const mat = mats[Math.floor(Math.random() * mats.length)];
                this.addItemToInventory(mat);
                this.renderEvent("ğŸŒŒ è™›ç©ºé¤½è´ˆ", "è™›ç©ºåå‡ºäº†ä¸€å€‹æ•£ç™¼è‘—å¼·å¤§æ°£æ¯çš„ç‰©è³ªã€‚", `ç²å¾— <span class='rarity-mythic'>${mat.name}</span>`, "ğŸ’");
            }
        } else {
            // --- å¤±æ•— ---
            // 50% MaxHP çœŸå¯¦å‚·å®³
            const dmg = Math.floor(Player.maxHp * 0.5);
            
            // æª¢æŸ¥è‡´æ­»æ€§
            if (Player.hp <= dmg) {
                Player.hp = 0;
                this.checkDeath("è¢«è™›ç©ºåå™¬");
                return;
            } else {
                Player.hp -= dmg;
                this.showFloatingText(`-${dmg} HP (çœŸå¯¦å‚·å®³)`, "#ff00ff");
                this.renderEvent("ğŸŒŒ è™›ç©ºåå™¬", "è™›ç©ºè©¦åœ–å°‡ä½ çš„éˆé­‚æ’•ç¢ï¼", `å—åˆ° <span class='damage-text'>${dmg} (50% MaxHP)</span> é»çœŸå¯¦å‚·å®³ã€‚`, "ğŸ’€");
            }
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    triggerBloodAltar() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ©¸ é®®è¡€ç¥­å£‡", "ã€Œä»¥è¡€æ›è¡€ï¼Œç­‰åƒ¹äº¤æ›ã€‚ã€", `ç»ç¥­ 50% ç•¶å‰ç”Ÿå‘½ (${Math.floor(Player.hp * 0.5)})ï¼Œæ›å–ç…‰ç„ç¥å™¨ï¼Ÿ(æˆåŠŸç‡ 20%)`, "ğŸ§›");
        this.setButtons("ç»ç¥­ç”Ÿå‘½", "resolveBloodAltar", "é›¢é–‹", "nextEvent", false);
    },

    resolveBloodAltar() {
        const cost = Math.floor(Player.hp * 0.5);
        Player.hp -= cost;
        this.showFloatingText(`-${cost} HP`, "red");
        
        // æˆåŠŸæ©Ÿç‡ 20%
        if (Math.random() < 0.20) {
            
            // åœ¨æˆåŠŸçš„æƒ…æ³ä¸‹ï¼Œåˆ¤å®šæ‰è½ç‰©
            // 1% æ©Ÿç‡æ‰è½è¶…è¶Šé­”æ–¹ (é€™è£¡æŒ‡æˆåŠŸåˆ¤å®šå…§çš„ 1%ï¼Œéå¸¸ç¨€æœ‰)
            // è‹¥è¦å®Œå…¨ä¾ç…§ã€Œç¸½æ©Ÿç‡1%ã€ï¼Œå‰‡æ­¤è™•æ‡‰è¨­ç‚º 0.05 (å› ç‚º 0.2 * 0.05 = 0.01)ã€‚
            // æ ¹æ“šæè¿° "è¶…è¶Šé­”æ–¹(é£¾å“)(1%æ‰è½)" é€šå¸¸æŒ‡åœ¨è©²æ± ä¸­çš„æ¬Šé‡ï¼Œæˆ‘å€‘è¨­ç‚º 5% (å³ç¸½æ©Ÿç‡1%)
            
            if (Math.random() < 0.05) {
                const cube = CONFIG.infernoItems.find(i => i.id === 'acc_transcendence');
                this.addItemToInventory({...cube});
                this.renderEvent("ğŸ©¸ ç¥­å£‡çš„å¥‡è¹Ÿ", "è¡€æ¶²æ²¸é¨°ï¼Œå‡èšæˆäº†ä¸å¯æ€è­°çš„å½¢ç‹€ï¼", `ç²å¾— <span class='rarity-mythic'>${cube.name}</span>`, "ğŸ§Š");
            } else {
                // å…¶ä»–ç¥è©±è£å‚™
                const poolIds = ['w_ragnarok', 'w_soulreaver', 'a_voidwalker', 'acc_wheel', 'acc_chaos'];
                const targetId = poolIds[Math.floor(Math.random() * poolIds.length)];
                const item = CONFIG.infernoItems.find(i => i.id === targetId);
                
                const newItem = Object.assign({}, item);
                this.addItemToInventory(newItem);
                this.renderEvent("ğŸ©¸ ç¥­å£‡çš„å›æ‡‰", "è¡€éœ§ä¸­æµ®ç¾å‡ºä¸€ä»¶ç¥å™¨...", `ç²å¾— <span class='rarity-mythic'>${newItem.name}</span>`, "ğŸ");
            }
        } else {
            // 80% å¤±æ•—
            this.renderEvent("ğŸ©¸ ç¥­å£‡çš„æ²‰é»˜", "è¡€æ¶²ä¹¾æ¶¸äº†ï¼Œä»€éº¼ä¹Ÿæ²’ç™¼ç”Ÿã€‚", "ä½ çš„çŠ§ç‰²ç™½è²»äº†...", "ğŸ•¸ï¸");
        }
        
        // æª¢æŸ¥æ˜¯å¦å› ç‚ºç»ç¥­è€Œæ­» (ç†è«–ä¸Šæ¸›åŠä¸æœƒæ­»ï¼Œé™¤éå‰©1)
        if (Player.hp <= 0) { this.checkDeath("æ­»æ–¼ç»ç¥­"); return; }
        
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    triggerMinotaur() {
        GameState.phase = "event_end";
const hasRedCloth = Player.equipment.accessories.some(a => a && a.id === 'acc_red_cloth');

        if (hasRedCloth) {
            this.triggerAnim('event-icon', 'anim-lunge'); // æ’­æ”¾æ”»æ“Šå‹•ç•«
            this.renderEvent("ğŸ® ç‰›é ­äººè¡æ’ï¼", "ç‰›é ­äººç˜‹ç‹‚åœ°å‘ä½ è¡ä¾†ï¼", "ä½†ä½ æ®èˆè‘—<span class='rarity-mythic'>ç´…å¸ƒ</span>ï¼Œå„ªé›…åœ°é–ƒéäº†æ”»æ“Šï¼(å…ç–«å‚·å®³èˆ‡æ‰è½)", "ğŸ§£");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return; // ç›´æ¥çµæŸäº‹ä»¶
        }
        const equippedAccs = Player.equipment.accessories.map((a, i) => ({item: a, idx: i})).filter(x => x.item !== null);
        if (equippedAccs.length > 0) {
            const target = equippedAccs[Math.floor(Math.random() * equippedAccs.length)];
            Player.equipment.accessories[target.idx] = null;
            this.recalcStats();
            this.renderEvent("ğŸ® ç‰›é ­äººè¡æ’ï¼", "ä¸€éš»ç˜‹ç‹‚çš„ç‰›é ­äººæ’é£›äº†ä½ ï¼", `ä½ çš„ <span class='damage-text'>${target.item.name}</span> è¢«æ’é£›éºå¤±äº†ï¼`, "ğŸ’¨");
        } else {
            const dmg = 300;
            Player.hp -= dmg;
            this.renderEvent("ğŸ® ç‰›é ­äººè¡æ’ï¼", "ä¸€éš»ç˜‹ç‹‚çš„ç‰›é ­äººæ’é£›äº†ä½ ï¼", `ä½ æ²’æœ‰é£¾å“å¯æ‰ï¼Œå—åˆ° ${dmg} å‚·å®³ï¼`, "ğŸ¤•");
        }
        if (Player.hp <= 0) { this.checkDeath("è¢«ç‰›é ­äººæ’æ­»"); return; }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },


triggerMinotaurMaze() {
        GameState.phase = "event_end";
        this.renderEvent("ğŸ•¸ï¸ é™°æ£®çš„è¿·å®®", "ä½ èª¤å…¥äº†ä¸€åº§å……æ»¿è¡€è…¥å‘³çš„è¿·å®®...", "å¿…é ˆæ‰¾åˆ°å‡ºå£æ‰èƒ½é›¢é–‹ã€‚", "ğŸ§±");
        
        // å› ç‚ºæœ‰å¤šç¨®çµæœï¼Œæˆ‘å€‘é»æ“ŠæŒ‰éˆ•å¾Œç›´æ¥çµç®—
        this.setButtons("æ¢ç´¢è¿·å®®", "resolveMinotaurMaze", "ç„¡", null, true);
    },

    resolveMinotaurMaze() {
        const rand = Math.random();
        
        // çµæœ 1: ç´…å¸ƒ (20%)
        if (rand < 0.20) {
            const item = CONFIG.infernoItems.find(i => i.id === 'acc_red_cloth');
            this.addItemToInventory({...item});
            this.renderEvent("ğŸ§£ è¿·å®®çš„è§’è½", "ä½ åœ¨è§’è½ç™¼ç¾äº†ä¸€å¡Šé®®è±”çš„å¸ƒã€‚", `ç²å¾— <span class="rarity-mythic">${item.name}</span>ï¼`, "ğŸ§£");
        }
        // çµæœ 2: æˆ°æ–§ (20%) -> 0.20 + 0.20 = 0.40
        else if (rand < 0.40) {
            const item = CONFIG.infernoItems.find(i => i.id === 'w_minotaur');
            this.addItemToInventory({...item});
            this.renderEvent("ğŸª“ è¿·å®®çš„éºç”¢", "ä½ åœ¨ç‰†é‚Šç™¼ç¾äº†ä¸€æŠŠå·¨å¤§çš„æ–§é ­ã€‚", `ç²å¾— <span class="rarity-mythic">${item.name}</span>ï¼`, "ğŸª“");
        }
        // çµæœ 3: ç©ºç©ºå¦‚ä¹Ÿ (30%) -> 0.40 + 0.30 = 0.70
        else if (rand < 0.70) {
            this.renderEvent("ğŸ§± è¿·å®®å‡ºå£", "ä½ åœ¨è¿·å®®è£¡ç¹äº†å¾ˆä¹…...", "ä»€éº¼ä¹Ÿæ²’ç™¼ç¾ï¼Œä½†å¹³å®‰æ‰¾åˆ°äº†å‡ºå£ã€‚", "ğŸ’¨");
        }
        // çµæœ 4: ç‰›é ­äººè¡æ’ (30%) -> å‰©é¤˜
        else {
            // ç›´æ¥å‘¼å«è¡æ’äº‹ä»¶
            this.triggerMinotaur();
            return; // triggerMinotaur æœƒè™•ç† UIï¼Œé€™è£¡ç›´æ¥ return
        }
        
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },


    triggerDemonMerchant() {
        GameState.phase = "demon_merchant";
GameState.merchantRefreshed = false;
        this.generateDemonStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ˜ˆ æƒ¡é­”å•†äºº", "ã€Œå‡¡äººçš„è²¨å¹£åœ¨é€™è£¡æ¯«ç„¡åƒ¹å€¼...ä½†æˆ‘æ”¶ç…‰ç„é‡‘å¹£ã€‚ã€", "è²©è³£ç¥è©±è£å‚™", "ğŸ§›");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderMerchantShop();
    },
generateDemonStock() {
        GameState.merchantStock = [];
        
        // ä¸€èˆ¬å•†å“æ±  (ä¸å«é­”ç¥ä¹‹å£)
        const normalPool = ['w_doom', 'a_apocalypse', 'c_harpy_blood', 'c_pure_blood'];
        
        // [ä¿®æ”¹ 1] å‰©é¤˜è¦ç”Ÿæˆçš„å•†å“æ•¸é‡ï¼šæ”¹ç‚º 4
        let slots = 4;
// --- [æ–°å¢] 3% æ©Ÿç‡è²©å”®ç…‰ç„çˆå·è»¸ ---
        if (Math.random() < 0.03) { 
            const scroll = CONFIG.infernoItems.find(i => i.id === 'c_inferno_scroll');
            if (scroll) {
                GameState.merchantStock.push(Object.assign({}, scroll));
                slots--; // ä½”ç”¨ä¸€æ ¼
            }
        }
        // --- [æ–°å¢] 1% æ©Ÿç‡è²©å”®ä¸æ­»é³¥çš„ç¾½æ¯› ---
        if (Math.random() < 0.01) { 
            // è¤‡è£½ç¾½æ¯›ç‰©ä»¶
            let feather = Object.assign({}, CONFIG.phoenixFeather);
            // å› ç‚ºåŸå§‹è¨­å®šæ˜¯ä¸å¯å‡ºå”®(0å…ƒ)ï¼Œé€™è£¡å¿…é ˆè³¦äºˆå®ƒè³¼è²·åƒ¹æ ¼
            feather.price = 20000; 
            feather.desc = "æ­»äº¡æ™‚ä»¥50%ç”Ÿå‘½å¾©æ´» (è³¼è²·ç²å¾—)"; 
            
            GameState.merchantStock.push(feather);
            slots--; // ä½”ç”¨ä¸€æ ¼
        }

        // --- [é­”ç¥ä¹‹å£] 10% æ©Ÿç‡å‡ºç¾åˆ¤å®š ---
        // ç¢ºä¿é‚„æœ‰æ ¼å­æ‰åˆ¤å®š
        if (slots > 0 && Math.random() < 0.1) { 
            const wall = CONFIG.infernoItems.find(i => i.id === 's_demon_wall');
            if (wall) {
                GameState.merchantStock.push(Object.assign({}, wall));
                slots--; // ä½”ç”¨ä¸€æ ¼
            }
        }

        // å¡«æ»¿å‰©ä¸‹çš„æ ¼å­ (å¾ä¸€èˆ¬æ± éš¨æ©ŸæŠ½)
        for(let i=0; i < slots; i++) {
            const targetId = normalPool[Math.floor(Math.random() * normalPool.length)];
            const item = CONFIG.infernoItems.find(i => i.id === targetId);
            if(item) {
                GameState.merchantStock.push(Object.assign({}, item));
            }
        }
    },

// [NEW] å¯§éœçš„èŠ±åœ’äº‹ä»¶
    triggerGardenEvent() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸŒ¸ å¯§éœçš„èŠ±åœ’", "ç…‰ç„ä¸­ç«Ÿç„¶å­˜åœ¨è‘—é€™æ¨£ä¸€ç‰‡æ·¨åœŸ...", "èŠ±åœ’ä¸­é–“æœ‰ä¸€ç¸·æ•£ç™¼è‘—å¼·å¤§æ°£å ´çš„é­‚é­„ã€‚<br>(é è¿‘å¯èƒ½è§¸ç™¼æ¥µåº¦å±éšªçš„æˆ°é¬¥)", "ğŸ‘»");
        this.setButtons("é è¿‘", "resolveGardenFight", "é›¢é–‹", "nextEvent", false);
    },

    // [NEW] å‹‡è€…æ®˜é­‚æˆ°é¬¥è¨­å®š
    resolveGardenFight() {
        const enemy = {
            name: "å‹‡è€…æ®˜é­‚",
            icon: "ğŸ‘»",
            hp: 333333,
            maxHp: 333333,
            atk: 111111,
            tier: "boss",
            isGardenBoss: true // ç‰¹æ®Šæ¨™è¨˜
        };
        // ç¬¬äºŒå€‹åƒæ•¸ true ä»£è¡¨å…è¨±é€ƒè·‘
        this.triggerCombatWithEnemy(enemy, true); 
        this.showFloatingText("å¼·è€…...", "#fff");
    },

    triggerInfernoCombat() {
        GameState.phase = "combat";
        let monsterPool = CONFIG.infernoMonsters;
        let totalW = monsterPool.reduce((a, b) => a + b.weight, 0);
        let r = Math.random() * totalW;
        let enemyTemplate = monsterPool[0];
        for(let m of monsterPool) {
            if (r < m.weight) { enemyTemplate = m; break; }
            r -= m.weight;
        }

        // --- [NEW] A. æ–°æ‰‹ä¿è­·æ©Ÿåˆ¶ (1-50å±¤) ---
        let statModifier = 1.0;
        let namePrefix = "";
        
        if (Player.depth <= 10) {
            statModifier = 0.3; // å‰Šå¼± 70%ï¼Œåªä¿ç•™ 30% æ•¸å€¼
            namePrefix = "(è™›å¼±) ";
        }

        let enemy = {
            ...enemyTemplate,
            name: namePrefix + enemyTemplate.name,
            maxHp: Math.floor(enemyTemplate.hp * statModifier),
            hp: Math.floor(enemyTemplate.hp * statModifier),
            atk: Math.floor(enemyTemplate.atk * statModifier),
            tier: enemyTemplate.tier || "normal",
            isOldOne: enemyTemplate.isOldOne || false
        };

        // å¦‚æœè§¸ç™¼äº†æ–°æ‰‹ä¿è­·ï¼Œé¡¯ç¤ºæç¤º
        if (Player.depth <= 30) {
            this.showFloatingText("æ–°æ‰‹ä¿è­·: æ€ªç‰©å¼±åŒ– 70%", "#4caf50");
        }

        this.triggerCombatWithEnemy(enemy, true);
    },

    // --- Combat Logic ---
combatRound() {
        if (GameState.phase !== "combat") return;
        GameState.combatTurn++; 
        const enemy = GameState.currentEnemy;
        let logHtml = "";

        // æª¢æŸ¥æœ€å¾Œçš„é¼“èˆ
        const hasInspiration = Player.lastInspirationTurns > 0;
        if (hasInspiration) {
            logHtml += `<span style='color:#ff69b4'>ğŸ’— æœ€å¾Œçš„é¼“èˆï¼šç„¡è¦–ç¥ä¹‹æ¬Šèƒ½ (å‰©é¤˜ ${Player.lastInspirationTurns} å›åˆ)</span><br>`;
        }

        // --- [ç…‰ç„ç”Ÿæ…‹ç³»] ç’°å¢ƒèˆ‡è¢«å‹•æŠ€èƒ½ ---
        
        // 1. ğŸŒ‹ ç†”å²©é­”åƒ - éç†±å…‰ç’°
        if (enemy.name.includes("ç†”å²©é­”åƒ")) {
            const burn = Math.floor(Player.maxHp * 0.05);
            Player.hp -= burn;
            logHtml += `<span style='color:orange'>ğŸŒ‹ ã€éç†±å…‰ç’°ã€‘ ç©ºæ°£ç¼ç‡’è‘—ä½ çš„è‚ºéƒ¨ï¼(HP -${burn})</span><br>`;
        }

        // 2. ğŸ™ èˆŠæ—¥æ”¯é…è€… - ä¸å¯åç‹€çš„ä½èª (å †ç–ŠçœŸå¯¦å‚·å®³)
        if (enemy.isOldOne) {
            enemy.rageStack = (enemy.rageStack || 0) + 1;
            const madnessDmg = 50 * enemy.rageStack;
            Player.hp -= madnessDmg;
            logHtml += `<span style='color:purple'>ğŸ™ ã€ç²¾ç¥å´©å£ã€‘ è…¦æµ·ä¸­çš„ä½èªè¶Šä¾†è¶Šå¤§è²... (HP -${madnessDmg})</span><br>`;
        }

        // 3. ğŸ‘ï¸ å¯©åˆ¤ä¹‹çœ¼ (ç¥ä¹‹ä»£è¡Œè€…)
        if (enemy.isGod && GameState.combatTurn % 3 === 0 && !hasInspiration) {
            Player.hp = 1;
            logHtml += "<span style='color:red; font-weight:bold; font-size:1.2em;'>ğŸ‘ï¸ ã€å¯©åˆ¤ä¹‹çœ¼ã€‘ å¤©ç½°é™è‡¨ï¼ä½ çš„ç”Ÿå‘½æ­¸ 1ï¼</span><br>";
            this.triggerAnim('game-container', 'anim-screen-shake');
        }

        // --- æª¢æŸ¥è¢«å‹•æ‰£è¡€å¾Œçš„æ­»äº¡ ---
        if (Player.hp <= 0) { this.checkDeath(enemy.name); return; }

        // --- [ç…‰ç„ç”Ÿæ…‹ç³»] ç©å®¶ç•°å¸¸ç‹€æ…‹æª¢æŸ¥ ---
        // ğŸ¦‘ æ··æ²Œè§¸æ‰‹ - æ€ç¶­æ±¡æŸ“ (ç©å®¶æ··äº‚)
        if (Player.isConfused) {
            Player.isConfused = false; // æ¶ˆè€—æ‰æ··äº‚
            logHtml += "<span style='color:violet'>ğŸ§  ã€æ€ç¶­æ±¡æŸ“ã€‘ ä½ å› ç‚ºæ··äº‚è€Œç„¡æ³•è¡Œå‹•ï¼</span><br>";
            this.renderEvent(`âš”ï¸ æˆ°é¬¥ - ${enemy.name}`, `HP: ${enemy.hp}`, logHtml, enemy.icon);
            this.enemyAttackPhase(enemy, logHtml); // è·³éç©å®¶æ”»æ“Šï¼Œç›´æ¥è¼ªåˆ°æ•µäºº
            if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
            return;
        }

        // --- å¤¢é­˜ç©¿åˆºè€… (æšˆçœ©åˆ¤å®š) ---
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_nightmare' && GameState.combatTurn === 2) {
             logHtml += "<span style='color:purple'>ğŸ¦„ å¤¢é­˜åå™¬ï¼ä½ å› è¡é‹’åŠ›ç«­è€Œæšˆçœ©ä¸€å›åˆï¼</span><br>";
             this.renderEvent(`âš”ï¸ æˆ°é¬¥ - ${enemy.name}`, `HP: ${enemy.hp}`, logHtml, enemy.icon);
             this.enemyAttackPhase(enemy, logHtml);
             if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
             return;
        }

        // --- è£å‚™æ•ˆæœï¼šåœ°å¿ƒç†”çˆé§ (é›™æ–¹æ‰£è¡€) ---
        if (Player.equipment.armor && Player.equipment.armor.id === 'armor_magma') {
            let selfBurn = Math.floor(Player.maxHp * 0.05);
            let enemyBurn = Math.floor(enemy.hp * 0.05);
            Player.hp = Math.max(1, Player.hp - selfBurn); 
            enemy.hp -= enemyBurn;
            logHtml += `<span style='color:orange'>ğŸŒ‹ éç†±åæ‡‰ï¼šæ•µæˆ‘ä¿±ç„š (ä½ -${selfBurn}, æ•µ-${enemyBurn})</span><br>`;
        }
        
        // --- è£å‚™æ•ˆæœï¼šèˆŠæ—¥æ”¯é…è€… (DoT) ---
        if (GameState.enemyDominated) {
            enemy.hp -= 20;
            logHtml += `<span style='color:purple'>ğŸ™ æ”¯é…è€…ä¾µè•ï¼šæ•µäºº HP -20</span><br>`;
        }

        if (enemy.hp <= 0) { this.combatWin(); return; }

        // --- ç©å®¶æ”»æ“Šéšæ®µ ---
        
        let skipPlayerTurn = false;
        if (Player.debuff && Player.debuff.id === 'sloth_curse' && enemy.hp === enemy.maxHp) { 
            skipPlayerTurn = true;
            logHtml += "<span style='color:grey'>ğŸ’¤ å› æ‡¶æƒ°è€Œç„¡æ³•è¡Œå‹•...</span><br>";
        }

        if (!skipPlayerTurn) {
            // [é£¾å“æ•ˆæœå€å¡Šçœç•¥ï¼Œä¿æŒåŸæ¨£...]
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_envy') && Math.random() < 0.10) {
                 Player.hp = Player.maxHp;
                 logHtml += `<span style='color:#4caf50;'>ğŸ¦Š å«‰å¦’ç™¼å‹•ï¼šå®Œå…¨æ¢å¾©ç”Ÿå‘½ï¼</span><br>`;
            }
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_gluttony')) {
                const healAmt = Math.floor(Player.maxHp * 0.10);
                Player.hp = Math.min(Player.maxHp, Player.hp + healAmt);
            }
            if (Player.buff && Player.buff.id === 'demon_destruction') {
                if (Math.random() < 0.1 && !enemy.isGod && !enemy.isOldOne) { 
                    enemy.hp = 0;
                    Player.hp -= Math.floor(Player.hp * 0.9);
                    logHtml += `<span style='color:red;'>ğŸ’€ æƒ¡é­”çš„ç ´å£ï¼è§¸ç™¼ç§’æ®ºï¼</span><br>`;
                    this.combatWin();
                    return;
                }
            }

            let pDmg = this.getAtk();
if (enemy.tier === 'boss' || enemy.tier === 'elite' || enemy.isGod || enemy.isOldOne) {
    Player.equipment.accessories.forEach(acc => {
        if (!acc) return;
        if (acc.id === 'acc_wyv_1') pDmg = Math.floor(pDmg * 1.05); // é¾é±—ç‰‡ +5%
        if (acc.id === 'acc_wyv_2') pDmg = Math.floor(pDmg * 1.08); // é¾æ·šå¢œé£¾ +8%
        if (acc.id === 'acc_wyv_3') pDmg = Math.floor(pDmg * 1.20); // çœŸé¾ä¹‹å¿ƒ +20%
    });
}

            let rawCrit = this.getCritRate(); 
            
            // ç¥çš„å¨å£“
            if (enemy.isGod && !hasInspiration) {
                rawCrit = 0; 
                logHtml += "<span style='color:gray'>âš ï¸ ã€å¨å£“ã€‘ ä½ çš„æš´æ“Šè¢«å°å°äº†ã€‚</span><br>";
            }
            
            // è‰²æ…¾é¦™æ°´
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_lust') && GameState.combatTurn === 1) rawCrit = 100;

            let isCrit = Math.random() * 100 < rawCrit;
            
            // å‘½é‹ä¹‹è¼ª
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_wheel')) {
                let trueRate = this.getCritRate(true);
                let multiplier = 1 + (trueRate / 20); 
                pDmg = Math.floor(pDmg * multiplier);
            } else if (isCrit) {
                pDmg *= (Player.class === 'knight') ? 3 : 2;
            }

            if (Player.equipment.accessories.some(a => a && a.id === 'acc_wrath') && Math.random() < 0.1) {
                pDmg *= 2;
                logHtml += "<span style='color:#d32f2f;'>ğŸ˜¡ æš´æ€’é€£æ“Šï¼</span><br>";
            }

            // --- [ç…‰ç„ç”Ÿæ…‹ç³»] æ€ªç‰©é˜²ç¦¦æŠ€èƒ½ ---

            // 1. ğŸŒ‘ æš—å½±å²èŠå§† - æµé«”é–ƒé¿
            if (enemy.name.includes("æš—å½±å²èŠå§†") && Math.random() < 0.15) {
                pDmg = 0;
                let counter = Math.floor(Player.maxHp * 0.05);
                Player.hp -= counter;
                logHtml += `<span style='color:gray'>ğŸŒ‘ ã€æµé«”é–ƒé¿ã€‘ æ”»æ“Šç©¿éäº†å²èŠå§†ï¼ä½ å—åˆ°åå™¬ ${counter} é»ã€‚</span><br>`;
            }

            // 2. ğŸ‘ï¸ è™›ç©ºé­”çœ¼ - è¦–ç·šæŠ˜å°„
            else if (enemy.name.includes("è™›ç©ºé­”çœ¼")) {
                let reflect = Math.floor(pDmg * 0.1); // 10% åå‚·
                pDmg = Math.floor(pDmg * 0.9);        // å¯¦éš›å‚·å®³å‰© 90%
                
                // [æ–°å¢ä¿®æ­£] é åˆ¤æ­»äº¡ï¼šå¦‚æœé€™ä¸€æ“Šèƒ½æ‰“æ­»æ€ªç‰©ï¼Œå‰‡ä¸è§¸ç™¼åå‚·
                if (enemy.hp - pDmg <= 0) {
                    logHtml += `<span style='color:#00bcd4'>ğŸ‘ï¸ ã€è¦–ç·šæŠ˜å°„ã€‘ è‡´å‘½ä¸€æ“Šï¼é­”çœ¼ç ´ç¢å‰ç„¡æ³•åå‚·ï¼</span><br>`;
                } else {
                    // æ€ªç‰©æ²’æ­»ï¼Œæ‰åŸ·è¡ŒåŸæœ¬çš„ç›¾ç‰Œåˆ¤å®šèˆ‡åå‚·
                    
                    // --- ç›¾ç‰Œæ ¼æ“‹åˆ¤å®š ---
                    let s = Player.equipment.shield;
                    if (s && s.val > 0) {
                        s.val--; 
                        logHtml += `<span style='color:#2196f3'>ğŸ›¡ï¸ ä½ çš„ ${s.name} æ“‹ä½äº†è¦–ç·šæŠ˜å°„ï¼(æŠµæ¶ˆ ${reflect} åå‚·)</span><br>`;
                        reflect = 0; 
                        
                        if (s.val <= 0) {
                            Player.equipment.shield = null;
                            logHtml += `<span class='damage-text'>ğŸ’” ç›¾ç‰Œåœ¨å¼·å…‰ä¸­ç¢è£‚äº†ï¼</span><br>`;
                            this.recalcStats();
                        }
                    } else {
                        Player.hp -= reflect;
                        // æ–‡å­—æ•˜è¿°åŒæ­¥æ›´æ–°ç‚º 10%
                        logHtml += `<span style='color:#00bcd4'>ğŸ‘ï¸ ã€è¦–ç·šæŠ˜å°„ã€‘ 10% å‚·å®³åå°„å›ä½ èº«ä¸Šï¼(-${reflect} HP)</span><br>`;
                    }
                }
            }

            // 3. ğŸ’€ å·«å¦–ç‹ - å‘½åŒ£è­·ç›¾ (æ¯3å›åˆç„¡æ•µ)
            else if (enemy.name.includes("å·«å¦–ç‹") && GameState.combatTurn % 3 === 0) {
                pDmg = 0;
                logHtml += `<span style='color:#9c27b0'>ğŸ’€ ã€å‘½åŒ£è­·ç›¾ã€‘ å·«å¦–ç‹è¢«éˆé­‚è­·ç›¾åŒ…åœï¼Œå‚·å®³ç„¡æ•ˆï¼</span><br>`;
            }

                        // 4. ğŸ² æ·±æ·µé­”é¾ - é€†é±—ä¹‹æ€’ (æš´æ“Šåæ“Š)
        if (enemy.name.includes("æ·±æ·µé­”é¾") && isCrit) {
            let wrathDmg = Math.floor(enemy.atk * 1.5);
            
            // --- [ä¿®æ”¹é–‹å§‹] åŠ å…¥ç›¾ç‰Œæ ¼æ“‹é‚è¼¯ ---
            let s = Player.equipment.shield;
            let isBlocked = false;

            if (s && s.val > 0) {
                isBlocked = true; // æ¨™è¨˜ç‚ºå·²æ ¼æ“‹

                // ç‰¹æ®Šè™•ç†ï¼šè™›ç©ºä¹‹é¡ (70% æ©Ÿç‡ä¸æ¶ˆè€—è€ä¹… + åå½ˆ)
                if (s.id === 'shield_void') {
                     let consume = Math.random() < 0.3; // 30% æ©Ÿç‡æ¶ˆè€—
                     if (consume) s.val--;
                     
                     // è™›ç©ºä¹‹é¡åå½ˆ 50% å‚·å®³çµ¦é­”é¾
                     let reflect = Math.floor(wrathDmg * 0.5);
                     enemy.hp -= reflect;

                     let durText = consume ? "æ¶ˆè€—è€ä¹…" : "è€ä¹…ç¶­æŒ";
                     logHtml += `<span class='block-text'>ğŸª è™›ç©ºä¹‹é¡æŠ˜å°„äº†é€†é±—ï¼(${durText} / åå½ˆ ${reflect})</span><br>`;
                } 
                // ä¸€èˆ¬ç›¾ç‰Œ (æ¶ˆè€— 1 è€ä¹…)
                else {
                    s.val--;
                    logHtml += `<span class='block-text'>ğŸ›¡ï¸ ä½ çš„ ${s.name} åŠæ™‚æ“‹ä½äº†é€†é±—ä¹‹æ€’ï¼(å‰©é¤˜è€ä¹… ${s.val})</span><br>`;
                }

                // æª¢æŸ¥ç›¾ç‰Œæ˜¯å¦ç¢è£‚
                if (s.val <= 0) {
                    Player.equipment.shield = null;
                    logHtml += `<span class='damage-text'>ğŸ’” ç›¾ç‰Œåœ¨å·¨å¤§çš„è¡æ“Šä¸­ç¢è£‚äº†ï¼</span><br>`;
                    this.recalcStats(); // é‡æ–°è¨ˆç®—æ•¸å€¼(æ‰£é™¤ç›¾ç‰ŒåŠ æˆ)
                }
            } 
            
            // å¦‚æœæ²’æœ‰æ ¼æ“‹æˆåŠŸ (æ²’è£ç›¾ç‰Œ æˆ– è€ä¹…æ­¸é›¶)ï¼Œæ‰åŸ·è¡Œæ‰£è¡€
            if (!isBlocked) {
                Player.hp -= wrathDmg;
                logHtml += `<span style='color:red; font-weight:bold;'>ğŸ² ã€é€†é±—ä¹‹æ€’ã€‘ é­”é¾è¢«æš´æ“Šæ¿€æ€’ï¼Œç¬é–“åå’¬ä¸€å£ï¼(-${wrathDmg} HP)</span><br>`;
            }
 }

            // çµç®—ç©å®¶æ”»æ“Š
            if (pDmg > 0) {
                // è–æ½”åŠ›å ´ (ç¥)
                const hasPrimordial = Player.equipment.weapon && Player.equipment.weapon.id === 'w_primordial';
                if (enemy.isGod && pDmg > 111111 && !hasInspiration && !hasPrimordial) { 
                    pDmg = 111111;
                    logHtml += "<span style='color:gold'>ğŸ›¡ï¸ ã€è–æ½”åŠ›å ´ã€‘ å‚·å®³è¢«é™åˆ¶åœ¨ 111111ï¼</span><br>";
                } else if (enemy.isGod && pDmg > 111111 && hasPrimordial) {
                    logHtml += "<span style='color:#00ffcc;'>âš”ï¸ ã€åŸåˆä¹‹åŠ›ã€‘ ä½ çš„åŠé‹’è²«ç©¿äº†è–æ½”åŠ›å ´ï¼</span><br>";
                }

                // è«¸ç¥é»ƒæ˜
                if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_ragnarok' && Math.random() < 0.05 && !enemy.isGod && !enemy.isOldOne) {
                    enemy.hp = 0;
                    logHtml += `<span style='color:red; font-weight:bold;'>â˜„ï¸ ã€è«¸ç¥é»ƒæ˜ã€‘ è§¸ç™¼ï¼æŠ¹æ®ºï¼</span><br>`;
                    this.combatWin();
                    return;
                }

                enemy.hp -= pDmg;
                this.triggerAnim('event-icon', 'anim-damage');
                this.showFloatingText(pDmg, isCrit ? "red" : "white");
                logHtml += `ä½ é€ æˆ ${isCrit ? "<span class='crit-text'>çˆ†æ“Š " : ""}${pDmg}${isCrit ? "</span>" : ""} å‚·å®³ã€‚<br>`;

if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_soulreaver') {
                    const heal = Math.floor(pDmg * 0.05); // å¸è¡€ 10%
                    if (heal > 0) {
                        Player.hp = Math.min(Player.maxHp, Player.hp + heal);
                        // é¡¯ç¤ºç¶ è‰²å›å¾©æ–‡å­—
                        logHtml += `<span style='color:#69f0ae'>â˜ ï¸ å™¬é­‚é®åˆ€ï¼šå¸å– ${heal} HP</span><br>`;
                    }
                }


if (Player.buff && Player.buff.id === 'demon_wealth') {
                    Player.gold += 5;
                    this.showFloatingText("+5 G", "gold");
                    // logHtml += " <span class='gold-text'>(è²¡å¯Œ+5G)</span>"; // å¦‚æœæƒ³è¦æ–‡å­—ç´€éŒ„é¡¯ç¤ºä¹Ÿå¯åŠ ä¸Šé€™è¡Œ
                }

            }

            // æª¢æŸ¥åå‚·è‡´æ­»
            if (Player.hp <= 0) { this.checkDeath(enemy.name); return; }

            // æª¢æŸ¥æ€ªç‰©æ­»äº¡
            if (enemy.hp <= 0) {
                // 5. ğŸ¤º å¢®è½é¨å£« - äº¡è€…æ„å¿— (é–è¡€ä¸€æ¬¡)
                if (enemy.name.includes("å¢®è½é¨å£«") && !enemy.undyingTriggered) {
                    enemy.hp = 1;
                    enemy.undyingTriggered = true;
                    logHtml += `<span style='color:darkred; font-weight:bold; font-size:1.2em;'>ğŸ¤º ã€äº¡è€…æ„å¿—ã€‘ é¨å£«æ‹’çµ•å€’ä¸‹ï¼(é–è¡€1å›åˆ)</span><br>`;
                } else {
                    this.combatWin();
                    return;
                }
            }
            
            // ç†æ™ºé­ç¬ (æ··äº‚æ•µäºº)
            if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_chaos' && Math.random() < 0.1) {
                let selfDmg = enemy.atk;
                enemy.hp -= selfDmg;
                logHtml += `<span style='color:violet'>ğŸ¦‘ æ··äº‚çš„æ•µäººæ”»æ“Šäº†è‡ªå·±ï¼Œé€ æˆ ${selfDmg} å‚·å®³ï¼</span><br>`;
                if (enemy.hp <= 0) { this.combatWin(); return; }
                this.renderEvent(`âš”ï¸ æˆ°é¬¥ - ${enemy.name}`, `æ•µæ–¹ HP: ${enemy.hp}`, logHtml, enemy.icon);
                this.updateUI();
                if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;
                return; // è·³éæ•µäººæ”»æ“Š
            }
            
            // æ»…ä¸–ä¹‹æ§ (æ”¯é…)
            if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_oldone' && Math.random() < 0.5) {
                GameState.enemyDominated = true;
                logHtml += "<span style='color:darkred'>ğŸ”± æ•µäººå·²è¢«æ”¯é…ï¼</span><br>";
            }
        }

        // --- 3. æ•µäººæ”»æ“Š ---
        this.enemyAttackPhase(enemy, logHtml);

        if (Player.lastInspirationTurns > 0) Player.lastInspirationTurns--;

if (Player.ghostTurns > 0) {
            Player.ghostTurns--;
            if (Player.ghostTurns <= 0) {
                // å›åˆçµæŸï¼Œå¼·åˆ¶æ­»äº¡
                Player.hp = 0; 
                this.renderEvent("ğŸ‘» éˆé­‚æ¶ˆæ•£", "ä½ çš„åŸ·å¿µå·²è€—ç›¡...", "å¡µæ­¸å¡µï¼ŒåœŸæ­¸åœŸã€‚", "ğŸ’€");
                this.checkDeath("éˆé­‚å‹æ…‹çµæŸ");
                return;
            }
        }

    },

    enemyAttackPhase(enemy, logHtml) {
        const ignoreGodPower = Player.lastInspirationTurns > 0;

        // ç¥ï¼šé‡ç”Ÿç ´å£
        if (enemy.isGod && !ignoreGodPower) {
            const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
            if (featherIdx !== -1 && Math.random() < 0.3) {
                Player.inventory.material.splice(featherIdx, 1);
                logHtml += "<span style='color:darkred; font-weight:bold;'>ğŸ”¥ ã€é‡ç”Ÿç ´å£ã€‘ ç¥ä¹‹ç«ç‡’æ¯€äº†ä¸€æ ¹ä¸æ­»é³¥ç¾½æ¯›ï¼</span><br>";
            }
        }
        
        // æš—å½±æ›¿èº« (ç„¡æ•ˆåŒ– + åæ“Š)
        const hasShadow = Player.equipment.accessories.some(a => a && a.id === 'acc_shadow');
        if (hasShadow && Math.random() < 0.1) {
            let defenseVal = Player.equipment.armor ? Player.equipment.armor.val : 0;
            let reflectDmg = Math.floor(defenseVal * 0.1);
            enemy.hp -= reflectDmg;
            logHtml += `<span style='color:#ccc'>ğŸ‘¤ æš—å½±æ›¿èº«ç„¡æ•ˆåŒ–äº†æ”»æ“Šï¼åå½ˆ ${reflectDmg} å‚·å®³ã€‚</span><br>`;
            if (enemy.hp <= 0) { this.combatWin(); return; }
        } else {
            // åŸºç¤å‚·å®³
            let mDmg = enemy.atk;

            // --- [ç…‰ç„ç”Ÿæ…‹ç³»] æ€ªç‰©æ”»æ“ŠæŠ€èƒ½ ---

            // 1. ğŸ¦„ å¤¢é­˜æˆ°é¦¬ - ææ‡¼è¡é‹’ (é¦–å›åˆé›™å€)
            if (enemy.name.includes("å¤¢é­˜æˆ°é¦¬") && GameState.combatTurn === 1) {
                mDmg *= 2;
                logHtml += `<span style='color:purple; font-weight:bold;'>ğŸ¦„ ã€ææ‡¼è¡é‹’ã€‘ æˆ°é¦¬ç™¼èµ·äº†æ¯€æ»…æ€§çš„è¡æ“Šï¼(å‚·å®³x2)</span><br>`;
            }

            // 2. ğŸ¤º å¢®è½é¨å£« - ç€•æ­»çˆ†ç™¼ (è§¸ç™¼äº¡è€…æ„å¿—å¾Œæ”»æ“Šå¤§å¢)
            if (enemy.undyingTriggered) {
                mDmg = Math.floor(mDmg * 1.5);
                logHtml += `<span style='color:darkred;'>ğŸ¤º ã€è¿´å…‰è¿”ç…§ã€‘ é¨å£«ç‡ƒç‡’äº†æœ€å¾Œçš„éˆé­‚ï¼(æ”»æ“Šx1.5)</span><br>`;
            }

            // 3. ğŸ¦‘ æ··æ²Œè§¸æ‰‹ - æ€ç¶­æ±¡æŸ“ (é€ æˆç©å®¶æ··äº‚)
            if (enemy.name.includes("æ··æ²Œè§¸æ‰‹") && Math.random() < 0.15) {
                Player.isConfused = true;
                logHtml += `<span style='color:violet; font-weight:bold;'>ğŸ¦‘ ã€æ€ç¶­æ±¡æŸ“ã€‘ ä½ çš„æ„è­˜è®Šå¾—æ¨¡ç³Š... (ä¸‹å›åˆç„¡æ³•è¡Œå‹•)</span><br>`;
            }

            // 4. ğŸ§› é®®è¡€ä¼¯çˆµ - ç”Ÿå‘½æ±²å–
            if (enemy.name.includes("é®®è¡€ä¼¯çˆµ")) {
                // é€™è£¡åªé¡¯ç¤ºï¼Œå¯¦éš›è£œè¡€åœ¨æ‰£é™¤å‚·å®³å¾Œè¨ˆç®—
                logHtml += `<span style='color:red;'>ğŸ§› ã€ç”Ÿå‘½æ±²å–ã€‘ ä¼¯çˆµå¸å–äº†ä½ çš„è¡€æ¶²...</span><br>`;
            }

            // --- æ¸›å‚·è¨ˆç®— ---
            if (Player.equipment.armor && Player.equipment.armor.id === 'armor_magma') {
                mDmg = Math.floor(mDmg * 0.8);
            }
            Player.equipment.accessories.forEach(acc => {
                if (!acc) return;
                if (acc.id === 'acc_skel_1') mDmg = Math.floor(mDmg * 0.95);
                if (acc.id === 'acc_skel_2') mDmg = Math.floor(mDmg * 0.90);
                if (acc.id === 'acc_skel_3') mDmg = Math.floor(mDmg * 0.85);
            });
            if (Player.buff && Player.buff.id === 'angel_protection') mDmg = Math.floor(mDmg * 0.7);
            if (Player.sinState.greedActive) mDmg = Math.floor(mDmg * 1.2);
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_pride')) mDmg = Math.floor(mDmg * 1.5);

            // --- ç›¾ç‰Œæ ¼æ“‹é‚è¼¯ ---
            let s = Player.equipment.shield;
            let applyDamage = true;
            
            // ç¥çš„è¦å‰‡ç ´å£
            if (enemy.isGod && s && Math.random() < 0.2 && !ignoreGodPower) {
                Player.equipment.shield = null; 
                this.recalcStats(); 
                logHtml += `<span style='color:red; font-weight:bold;'>ğŸ”¨ ã€è¦å‰‡ç ´å£ã€‘ ä½ çš„ ${s.name} è¢«ä¸€æ“Šç²‰ç¢ï¼(æŠµæ¶ˆæœ¬æ¬¡å‚·å®³)</span><br>`;
                s = null; 
                applyDamage = false; 
            }
            // è™›ç©ºä¹‹é¡
            else if (s && s.id === 'shield_void') {
                if (s.val > 0) {
                     let consume = Math.random() < 0.3; 
                     if (consume) s.val--;
                     let reflect = Math.floor(mDmg * 0.5);
                     enemy.hp -= reflect;
                     if (!consume) {
                         logHtml += `<span class='block-text'>ğŸª è™›ç©ºæŠ˜å°„ï¼(è€ä¹…ç¶­æŒ / åå½ˆ ${reflect})</span><br>`;
                     } else {
                         logHtml += `<span class='block-text'>ğŸª è™›ç©ºæŠ˜å°„ï¼(æ¶ˆè€—è€ä¹… / åå½ˆ ${reflect})</span><br>`;
                         if (s.val <= 0) {
                             Player.equipment.shield = null;
                             logHtml += `<span class='damage-text'>é¡é¢ç¢è£‚ï¼Œå›æ­¸è™›ç©º...</span><br>`;
                             this.recalcStats();
                         }
                     }
                     applyDamage = false;
                }
            }
            // æ™®é€šæ ¼æ“‹
            else if (s && s.val > 0) {
                s.val--;
                logHtml += `<span class='block-text'>ğŸ›¡ï¸ æ ¼æ“‹!</span> (${s.val})<br>`;
                applyDamage = false;
                if (s.val <= 0) {
                    Player.equipment.shield = null;
                    logHtml += `<span class='damage-text'>ç›¾ç‰Œç¢è£‚!</span><br>`;
                    this.recalcStats();
                }
            }

            // --- å‚·å®³çµç®— ---
            if (applyDamage) {
                // é€†é±—é¾è£åæ“Š
                let enemyCrit = Math.random() < 0.1; 
                if (enemyCrit) {
                     mDmg = Math.floor(mDmg * 1.5);
                     logHtml += "<span class='damage-text'>æ•µäººæš´æ“Šï¼</span> ";
                     if (Player.equipment.armor && Player.equipment.armor.id === 'armor_dragon' && Math.random() < 0.1 && !enemy.isGod) {
                         if (enemy.tier === 'boss' || enemy.isTrueForm) {
                             let trueDmg = Math.floor(enemy.hp * 0.1);
                             enemy.hp -= trueDmg;
                             logHtml += `<span style='color:red'>ğŸ‰ é¾ä¹‹æ€’ï¼åæ“Šé€ æˆ ${trueDmg} çœŸå¯¦å‚·å®³ï¼</span><br>`;
                         } else {
                             enemy.hp = 0;
                             logHtml += `<span style='color:red'>ğŸ‰ é¾ä¹‹æ€’ï¼ç›´æ¥æ–¬æ®ºäº†æ•µäººï¼</span><br>`;
                             this.combatWin();
                             return;
                         }
                     }
                }

                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                logHtml += `${enemy.name} æ”»æ“Šé€ æˆ ${mDmg} å‚·å®³ã€‚`;

                // ğŸ§› é®®è¡€ä¼¯çˆµ - å¸è¡€çµç®—
                if (enemy.name.includes("é®®è¡€ä¼¯çˆµ")) {
                    let heal = Math.floor(mDmg * 0.5);
                    enemy.hp = Math.min(enemy.maxHp, enemy.hp + heal);
                    logHtml += ` (ä¼¯çˆµå›å¾© ${heal} HP)`;
                }
            }
        }
        
        this.renderEvent(`âš”ï¸ æˆ°é¬¥ - ${enemy.name}`, 
            `æ•µæ–¹ HP: ${Math.max(0, enemy.hp)}`, 
            logHtml, enemy.icon);

        if (Player.hp <= 0) {
            this.checkDeath(enemy.name);
        } else {
            this.updateUI();
        }
    },
    
    // --- Crafting ---
    triggerCraftingTable() {
        GameState.phase = "crafting";
        GameState.craftingCount = 0;
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ”¨ è£½ä½œå°", "ä½ ç™¼ç¾äº†ä¸€å€‹å»¢æ£„çš„è£½ä½œå°ã€‚", "å‰©é¤˜è£½ä½œæ¬¡æ•¸: 2", "âš’ï¸");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderCraftingUI();
    },

    renderCraftingUI() {
        const area = document.getElementById('crafting-area');
        area.innerHTML = "";
        area.classList.remove('hidden');

        let craftables = Object.values(CONFIG.accessories);
        if (Player.history.items.has("çœŸå¯¦ä¹‹å¿ƒ")) {
            craftables.push(CONFIG.bible);
        }

        let html = "<h4>å¯è£½ä½œ (é»æ“Šåˆæˆ)</h4><div class='craft-grid'>";
        
        craftables.forEach(item => {
            const recipe = item.recipe;
            const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';

            html += `<div class="craft-item" onclick="Game.craftItem('${item.id}')">
                <div class="m-top">
                    <span>${item.icon} ${item.name}</span> 
                    <span style="font-size:0.8em; color:#aaa;">é…æ–¹</span>
                </div>
                <div class="craft-req ${statusClass}">
                    éœ€: ${recipe.mat} (${owned}/${recipe.count})
                </div>
                <div style="font-size:0.7em; color:#666; margin-top:2px;">
                    ${canCraft ? "âœ… å¯åˆæˆ" : "âŒ ç´ æä¸è¶³"}
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    craftItem(itemId) {
        if (GameState.phase !== "crafting") return;
        if (GameState.craftingCount >= 2) {
            alert("è£½ä½œå°å·²ç¶“å£æ‰äº†ï¼");
            this.nextEvent();
            return;
        }

        let itemTemplate = Object.values(CONFIG.accessories).find(i => i.id === itemId);
        if (itemId === 'inferno_bible') itemTemplate = CONFIG.bible;

        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æä¸è¶³ï¼");
            return;
        }

        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        let newItem = Object.assign({}, itemTemplate);
        if(newItem.type === 'special') newItem.type = 'material'; 
        
        this.addItemToInventory(newItem);
        GameState.craftingCount++;

        this.showFloatingText("åˆæˆæˆåŠŸ!", "#4caf50");
        this.log(`åˆæˆäº† ${newItem.name}`);

        if (GameState.craftingCount >= 2) {
            this.renderEvent("ğŸ”¨ è£½ä½œå°æå£", "è£½ä½œå°å´©å¡Œäº†...", "ç„¡æ³•ç¹¼çºŒä½¿ç”¨ã€‚", "ğŸ’¥");
            document.getElementById('crafting-area').classList.add('hidden');
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        } else {
            this.renderCraftingUI();
        }
        this.updateUI();
    },

openPortableCrafting(mode = 'normal') {
        const modal = document.getElementById('portable-crafting-modal');
        // å„²å­˜ç•¶å‰æ¨¡å¼åˆ° datasetï¼Œä»¥ä¾¿ render æ™‚åˆ¤æ–·
        modal.dataset.mode = mode;
        
        // ä¿®æ”¹æ¨™é¡Œé¡è‰²ä»¥ç¤ºå€åˆ¥
        const titleEl = modal.querySelector('h3');
        if (mode === 'inferno') {
            titleEl.innerText = "ğŸ”¥ ç…‰ç„çˆç« (ä¾¿æ”œç‰ˆ)";
            titleEl.style.color = "#ff3300";
        } else {
            titleEl.innerText = "ğŸ§° æ”œå¸¶å¼å·¥ä½œæª¯";
            titleEl.style.color = "#e0e0e0";
        }

        modal.style.display = 'flex';
        this.renderPortableCrafting();
    },

    // [ä¿®æ”¹] æ¸²æŸ“åˆ—è¡¨ (æ ¹æ“šæ¨¡å¼é¡¯ç¤ºä¸åŒæ¸…å–®)
    renderPortableCrafting() {
        const modal = document.getElementById('portable-crafting-modal');
        const mode = modal.dataset.mode || 'normal';
        const area = document.getElementById('portable-craft-content');
        area.innerHTML = "";

        let craftables = [];

        if (mode === 'inferno') {
            // ç…‰ç„æ¨¡å¼ï¼šåªé¡¯ç¤ºç¥è©±è£å‚™
            craftables = [...CONFIG.forgeItems];
        } else {
            // ä¸€èˆ¬æ¨¡å¼ï¼šé¡¯ç¤ºé£¾å“ + è–ç¶“
            craftables = Object.values(CONFIG.accessories);
            if (Player.history.items.has("çœŸå¯¦ä¹‹å¿ƒ")) {
                craftables.push(CONFIG.bible);
            }
        }

        let html = "<div class='craft-grid'>";
        
        craftables.forEach(item => {
            const recipe = item.recipe;
            if (!recipe) return; 

            const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;
            const canCraft = owned >= recipe.count;
            const statusClass = canCraft ? 'ok' : 'no';
            // ç…‰ç„è£å‚™é¡¯ç¤ºç´…è‰²åå­—
            const nameColor = (mode === 'inferno') ? '#ff5555' : '#fff';
            
            html += `<div class="craft-item" onclick="Game.craftPortableItem('${item.id}')">
                <div class="m-top">
                    <span style="color:${nameColor}">${item.icon} ${item.name}</span>
                </div>
                <div class="craft-req ${statusClass}">éœ€: ${recipe.mat} (${owned}/${recipe.count})</div>
                <div style="font-size:0.7em; color:${canCraft ? '#4caf50' : '#666'}; margin-top:2px;">
                    ${canCraft ? "âœ… é»æ“Šè£½ä½œ" : "âŒ ç´ æä¸è¶³"}
                </div>
            </div>`;
        });
        html += "</div>";
        area.innerHTML = html;
    },

    // [ä¿®æ”¹] è£½ä½œé‚è¼¯ (æ”¯æ´æŸ¥æ‰¾ç¥è©±è£å‚™)
    craftPortableItem(itemId) {
        // å…ˆæ‰¾é£¾å“
        let itemTemplate = Object.values(CONFIG.accessories).find(i => i.id === itemId);
        // å†æ‰¾ç‰¹æ®Š
        if (itemId === 'inferno_bible') itemTemplate = CONFIG.bible;
        // æœ€å¾Œæ‰¾ç…‰ç„è£å‚™
        if (!itemTemplate) itemTemplate = CONFIG.forgeItems.find(i => i.id === itemId);
        
        if (!itemTemplate) return;

        const recipe = itemTemplate.recipe;
        const owned = Player.inventory.material.filter(m => m.name === recipe.mat).length;

        if (owned < recipe.count) {
            alert("ç´ æä¸è¶³ï¼");
            return;
        }

        // æ‰£é™¤ç´ æ
        let toRemove = recipe.count;
        const newMats = [];
        for (let m of Player.inventory.material) {
            if (m.name === recipe.mat && toRemove > 0) {
                toRemove--;
            } else {
                newMats.push(m);
            }
        }
        Player.inventory.material = newMats;

        // çµ¦äºˆç‰©å“
        let newItem = Object.assign({}, itemTemplate);
        if(newItem.type === 'special') newItem.type = 'material'; 
        
        this.addItemToInventory(newItem);

        this.showFloatingText("è£½ä½œæˆåŠŸ!", "#ff3300");
        this.updateUI(); 
        this.renderPortableCrafting(); 
    },


    // --- Helpers ---
    checkAchievements() {
        let newUnlock = false;
        CONFIG.achievements.forEach(ach => {
            if (!Player.achievements.has(ach.id)) {
                // [FIX] åªæœ‰ç•¶æˆå°± check å‡½å¼ç‚ºçœŸæ™‚æ‰è§¸ç™¼
                if (ach.check(Player)) {
                    Player.achievements.add(ach.id);
                    this.showFloatingText(`ğŸ† ${ach.name}`, 'gold');
                    newUnlock = true;
                }
            }
        });
        if (newUnlock) this.checkAchievements();
    },

    checkDrops(type) {
        let needed = [];
        CONFIG.monsters.forEach(m => {
            needed.push(m.drop);
            needed.push(m.eliteDrop);
            if (type === 'prospector') needed.push(m.bossDrop);
        });
        // [FIX] æª¢æŸ¥é‚è¼¯ä¿®æ­£ï¼Œç¢ºä¿æ¯å€‹ç‰©å“éƒ½å·²åœ¨ history.items ä¸­
        return needed.every(item => Player.history.items.has(item));
    },

    checkAllItems() {
        const all = this.getAllItems('items').concat(this.getAllItems('accessories')).concat(this.getAllItems('inferno'));
        // [FIX] æ’é™¤è™›æ“¬æˆå°±ç‰©å“
        return all.filter(i => i.type !== 'special' && i.type !== 'revive').every(i => Player.history.items.has(i.name)); 
    },
    
    getCollectedItemsCount() {
        return Player.history.items.size; 
    },

    checkTierComplete(tiers) {
        const targets = CONFIG.achievements.filter(a => tiers.includes(a.rarity) && !a.hidden);
        return targets.every(a => Player.achievements.has(a.id));
    },

    checkAllAchievements() {
        const others = CONFIG.achievements.filter(a => a.id !== 'true_rest');
        return others.every(a => Player.achievements.has(a.id));
    },

    showAchievements() {
        const modal = document.getElementById('achieve-modal');
        const list = document.getElementById('achieve-list-content');
        const stats = document.getElementById('achieve-stats');
        list.innerHTML = "";
        modal.style.display = 'flex';

        // [æ–°å¢] æª¢æŸ¥æ˜¯å¦æ“æœ‰ç…‰ç„è–ç¶“
        const hasBible = Player.history.items.has("ç…‰ç„è–ç¶“");

        // è¨ˆç®—å¯è¦‹æˆå°±æ•¸é‡
        let visibleTotal = CONFIG.achievements.filter(a => {
            // å¦‚æœå·²è§£é– -> å¯è¦‹
            if (Player.achievements.has(a.id)) return true;
            // å¦‚æœæ˜¯ç…‰ç„é¡åˆ¥ä¸”æœ‰è–ç¶“ -> å¯è¦‹
            if (a.category === 'inferno' && hasBible) return true;
            // å¦‚æœä¸æ˜¯éš±è— -> å¯è¦‹
            if (!a.hidden) return true;
            
            return false;
        }).length;

        let unlockedCount = Player.achievements.size;
        
        stats.innerText = `é€²åº¦: ${unlockedCount} / ${visibleTotal}`;

        CONFIG.achievements.forEach(ach => {
            const unlocked = Player.achievements.has(ach.id);
            
            // åˆ¤æ–·æ˜¯å¦éš±è—
            let isHidden = ach.hidden && !unlocked;

            // [æ–°å¢] é‚è¼¯ï¼šå¦‚æœæœ‰ç…‰ç„è–ç¶“ï¼Œä¸”è©²æˆå°±æ˜¯ç…‰ç„é¡åˆ¥ï¼Œå‰‡å¼·åˆ¶é¡¯ç¤º (å–æ¶ˆéš±è—)
            if (hasBible && ach.category === 'inferno') {
                isHidden = false;
            }

            if (isHidden) return; // å¦‚æœä»ç„¶éš±è—ï¼Œè·³éä¸æ¸²æŸ“

            const div = document.createElement('div');
            div.className = `achieve-item ${unlocked ? 'unlocked' : ''}`;
            let colorClass = CONFIG.rarityDisplay[ach.rarity].color;
            div.innerHTML = `
                <div class="achieve-info">
                    <div class="achieve-name" style="${unlocked ? 'color:white' : ''}">${ach.name}</div>
                    <div class="achieve-cond">${ach.cond}</div>
                </div>
                <div class="achieve-badge ${colorClass}">${CONFIG.rarityDisplay[ach.rarity].label}</div>
            `;
            list.appendChild(div);
        });
    },

    selectClass(classType) {
        Player.class = classType;
        document.getElementById('class-modal').style.display = 'none';
        
        // --- åŸæœ‰çš„è·æ¥­é‚è¼¯ ---
        if (classType === 'knight') {
            const lance = { name: "é¨å£«é•·æ§", type: "weapon", val: 12, rarity: "uncommon", price: 80, icon: "ğŸ”±" };
            this.addItemToInventory(lance, false);
            this.equip(0, 'equipment'); 
        } 
        else if (classType === 'challenger') {
            const potion = { name: "å¼·åŠ›è—¥æ°´", type: "consumable", val: 80, rarity: "uncommon", price: 60, icon: "ğŸ·", desc: "æ¢å¾©80é»ç”Ÿå‘½" };
            this.addItemToInventory(potion, false);
        }
        else if (classType === 'cultist') {
            const demonBuffs = Object.values(CONFIG.buffs).filter(b => b.type === 'demon');
            Player.buff = demonBuffs[Math.floor(Math.random() * demonBuffs.length)];
            this.updateUI();
        } 
        // --- æ–°å¢ï¼šå± é¾è€…é‚è¼¯ (ç”±æ­¤é–‹å§‹) ---
        else if (classType === 'dragonslayer') {
            // 1. çµ¦äºˆå± é¾åˆ€ (åŸºæ–¼å± é¾åŠæ•¸å€¼ï¼Œæ”¹åæ”¹åœ–ç¤º)
            const swordBase = CONFIG.itemPool.find(i => i.name === "å± é¾åŠ");
            if (swordBase) {
                const dao = { ...swordBase, name: "å± é¾åˆ€", icon: "ğŸ”ª" };
                this.addItemToInventory(dao, false);
                this.equip(0, 'equipment'); // è‡ªå‹•è£å‚™
            }
            
            // 2. çµ¦äºˆé¾é±—é§ç”²
            const armorBase = CONFIG.itemPool.find(i => i.name === "é¾é±—é§ç”²");
            if (armorBase) {
                this.addItemToInventory({ ...armorBase }, false);
                this.equip(0, 'equipment'); // è‡ªå‹•è£å‚™
            }

            
            this.updateUI();
        }
        // --- æ–°å¢çµæŸ ---
        else {
            this.updateUI();
        }

        // æ›´æ–°é€™è£¡çš„ badgeMap ä»¥ç¢ºä¿é¸æ“‡ç•¶ä¸‹èƒ½æ­£ç¢ºé¡¯ç¤º
        const badgeMap = { 
            'knight': 'ğŸ›¡ï¸ é¨å£«', 'merchant': 'ğŸ’° å•†è²©', 'thief': 'ğŸ—¡ï¸ ç›œè³Š', 
            'cultist': 'ğŸ˜ˆ æƒ¡é­”ä¿¡å¾’', 'scarecrow': 'ğŸŒ¾ ç¨»è‰äºº', 'ape': 'ğŸ¦ äººçŒ¿',
            'challenger': 'ğŸ§— æŒ‘æˆ°è€…',
            'dragonslayer': 'ğŸ‰ å± é¾è€…' // <--- è¨˜å¾—é€™è£¡ä¹Ÿè¦åŠ 
        };
        document.getElementById('class-badge').innerText = badgeMap[classType];
        
        // ç¢ºä¿ç‹€æ…‹æ­£ç¢º
        GameState.phase = "event_end"; 

        this.renderEvent("æº–å‚™å°±ç·’", "ä½ çš„å†’éšªå³å°‡é–‹å§‹...", "ç¥ä½ å¥½é‹ï¼", "âœ¨");

        // [é‡è¦ä¿®å¾©] å¼·åˆ¶å°‡æŒ‰éˆ•æ›´æ–°ç‚ºã€Œé–‹å§‹å†’éšªã€
        this.setButtons("é–‹å§‹å†’éšª", "nextEvent", "ç„¡", null, true);
    },

    triggerAnim(id, animClass) {
        const el = document.getElementById(id);
        if(el) {
            el.classList.remove(animClass);
            void el.offsetWidth;
            el.classList.add(animClass);
        }
    },

    showFloatingText(text, color) {
        const display = document.getElementById('event-display');
        const div = document.createElement('div');
        div.className = 'floating-text';
        div.innerHTML = text;
        div.style.color = color;
        display.appendChild(div);
        setTimeout(() => div.remove(), 1000);
    },



    combatWin() {
        const enemy = GameState.currentEnemy;
Player.isConfused = false;
        let isGodKill = enemy.isGod;
        let isOldOneKill = enemy.isOldOne; // [NEW] èˆŠæ—¥æ”¯é…è€…æ“Šæ®ºåˆ¤å®š

if (enemy.isGardenBoss) {
            // çµ¦äºˆåŸåˆä¹‹åŠ
            const sword = CONFIG.infernoItems.find(i => i.id === 'w_primordial');
            this.addItemToInventory({...sword});
            
            GameState.phase = "event_end";
            this.renderEvent("ğŸ‘» æ®˜é­‚æ¶ˆæ•£", 
                "é‚£ç¸·é­‚é­„éœ²å‡ºäº†æ¬£æ…°çš„ç¬‘å®¹ï¼ŒåŒ–ä½œå…‰é»æ¶ˆå¤±äº†ã€‚", 
                "ç©ºä¸­è¿´ç›ªè‘—æœ€å¾Œçš„è²éŸ³ï¼š<br><span style='font-size:1.5em; color:#00ffcc; font-weight:bold;'>ã€Œå°±.....æ‹œè¨—ä½ äº†ã€‚ã€</span><br><br>ç²å¾— <span class='rarity-ultra'>åŸåˆä¹‹åŠ</span>", 
                "âœ¨");
            
            this.showFloatingText("ç²å¾— åŸåˆä¹‹åŠ", "#00ffcc");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return; // ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œå¾ŒçºŒä¸€èˆ¬æ‰è½
        }

        // [FIX] æ‡¶æƒ°è©›å’’ï¼šæ”¹åœ¨æˆ°é¬¥å‹åˆ©æ™‚è¨ˆç®— (ç¬¦åˆã€ŒæŒçºŒ 10 å ´ã€çš„å®šç¾©)
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            if (isNaN(Player.sinState.slothCount)) Player.sinState.slothCount = 10; // é˜²å‘†
            
            Player.sinState.slothCount--;
            if (Player.sinState.slothCount <= 0) {
                Player.debuff = null; // ç§»é™¤è©›å’’
                const ring = CONFIG.sinItems.find(i => i.id === 'acc_sloth');
                this.addItemToInventory({...ring});
                alert("ğŸ’¤ æ‡¶æƒ°çš„è©¦ç…‰çµæŸï¼Œç²å¾—ã€çœ æˆ’ã€‘ï¼");
                this.checkAchievements(); // æª¢æŸ¥æ€ æƒ°æˆå°±
            }
        }

        // [NEW] äº¡è€…é …éŠ - æˆåŠŸå¾©æ´»
        if (Player.ghostTurns > 0) {
            Player.ghostTurns = 0; // æ¸…é™¤éˆé­‚å€’æ•¸
            Player.hp = Math.floor(Player.maxHp * 0.2); // å¾©æ´»ä¸¦æ¢å¾© 20% è¡€é‡
            this.showFloatingText("éˆé­‚å¥ªèˆï¼", "#00ffcc");
            // ä¸ä½¿ç”¨ returnï¼Œè®“ç¨‹å¼ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œæ‰è½çµç®—
        }

        // [NEW] æ°¸ç”Ÿè­·ç¬¦ - æ”¶é›†éˆé­‚
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery')) {
            if (Player.souls < 200) {
                Player.souls++;
                this.showFloatingText("éˆé­‚ +1", "#00ffcc");
            }
        }
        if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_minotaur') {
            if (Math.random() < 0.01) { // 1% æ©Ÿç‡
                Player.permanentCritBonus = (Player.permanentCritBonus || 0) + 0.03;
                this.showFloatingText("æš´æ“Šæ½›èƒ½æå‡!", "#ff00ff");
                alert("ğŸª“ ã€ç‰›é ­äººæˆ°æ–§ã€‘é£²è¡€é€²åŒ–ï¼\n\nä½ çš„åŸºç¤æš´æ“Šç‡æ°¸ä¹…æå‡äº† 3%ï¼");
            }
        }

if (Player.equipment.weapon && Player.equipment.weapon.id === 'w_void_breaker') {
            if (Math.random() < 0.10) { // 10% æ©Ÿç‡
                Player.baseAtk += 100;
                this.showFloatingText("è™›ç©ºåå™¬! æ”»+100", "#9c27b0");
                // å¯ä»¥é¸æ“‡æ˜¯å¦å½ˆçª—æç¤ºï¼Œé¿å…å¤ªç…©
                // alert("ğŸŒŒ ã€è™›ç©ºç ´æ»…åŠã€‘åå™¬äº†æ•µäººçš„éˆé­‚ï¼\n\nåŸºç¤æ”»æ“ŠåŠ›æ°¸ä¹…æå‡ 100 é»ï¼");
            }
        }

        // [FIX] æš´æ€’ï¼šä¿®å¾©æ‰è½é‚è¼¯
        if (enemy.isSin && enemy.sinType === 'wrath') {
            // æª¢æŸ¥æ˜¯å¦å¾©æ´»ï¼šæ¬¡æ•¸å°æ–¼ 2 ä¸” 80% æ©Ÿç‡
            if (Player.sinState.wrathRevive < 2 && Math.random() < 0.8) {
                Player.sinState.wrathRevive++;
                
                // [ä¿®æ”¹] å€ç‡æ”¹æˆ 2.0 (æ•¸å€¼ç¿»å€)
                enemy.hp = Math.floor(enemy.maxHp * 2.0);
                enemy.maxHp = enemy.hp; 
                enemy.atk = Math.floor(enemy.atk * 2.0);
                
                this.renderEvent("ğŸ˜¡ ä¸æ­»æ€’ç«", "ç‹‚æˆ°å£«æ‹’çµ•å€’ä¸‹ï¼", "ã€Œå¼å–”å–”å–”ï¼ï¼ï¼ã€(å±¬æ€§ç¿»å€)", "ğŸ”¥");
                this.showFloatingText("å¾©æ´»ï¼", "red");
                
                setTimeout(() => { this.updateUI(); }, 1000);
                return; 
            } 
            else {
                // æ²’å¾©æ´»(é‹æ°£ä¸å¥½ æˆ– æ¬¡æ•¸å·²æ»¿) -> çœŸæ­£æ­»äº¡ï¼Œçµ¦äºˆæŒ‡è™
                const knuckles = CONFIG.sinItems.find(i => i.id === 'acc_wrath');
                this.addItemToInventory({...knuckles});
                this.checkAchievements(); // æª¢æŸ¥æš´æ€’æˆå°±
            }
        }
        
        // [NEW] å…¶ä»–ç½ªæƒ¡ Boss å›ºå®šæ‰è½
        if (enemy.isSin && enemy.sinType === 'pride') {
            const eye = CONFIG.sinItems.find(i => i.id === 'acc_pride');
            this.addItemToInventory({...eye});
            this.checkAchievements(); // æª¢æŸ¥å‚²æ…¢æˆå°±
        }
        if (enemy.isSin && enemy.sinType === 'greed') {
             const icon = CONFIG.sinItems.find(i => i.id === 'acc_greed');
             this.addItemToInventory({...icon});
             this.checkAchievements(); // æª¢æŸ¥è²ªå©ªæˆå°±
        }
        if (enemy.isSin && enemy.sinType === 'envy') {
             const item = CONFIG.sinItems.find(i => i.id === 'acc_envy');
             // è£å‚™å·²åœ¨ resolveEnvyTrade çµ¦äºˆ
             this.checkAchievements(); // æª¢æŸ¥å«‰å¦’æˆå°±
        }
        if (enemy.isSin && enemy.sinType === 'gluttony') {
             const item = CONFIG.sinItems.find(i => i.id === 'acc_gluttony');
             // è£å‚™å·²åœ¨ resolveGluttonySacrifice çµ¦äºˆ
             this.checkAchievements(); // æª¢æŸ¥æš´é£Ÿæˆå°±
        }
        if (enemy.isSin && enemy.sinType === 'lust') {
             const item = CONFIG.sinItems.find(i => i.id === 'acc_lust');
             // è£å‚™å·²åœ¨ resolveLustAccept çµ¦äºˆ
             this.checkAchievements(); // æª¢æŸ¥è‰²æ…¾æˆå°±
        }


        GameState.phase = "event_end";
        
        if(Player.depth === 1000 && enemy.tier === 'boss' && !Player.inInferno) {
            Player.kill1000Boss = true;
        }

        let drops = [];
        let dropText = "";

        let gold = enemy.baseGold || 100;
        if (enemy.tier === "elite") gold *= 2;
        if (enemy.tier === "boss") gold *= 5;
        
        let goldMul = 1;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_gob_1') goldMul += 0.05;
            if(acc.id === 'acc_gob_2') goldMul += 0.10;
            if(acc.id === 'acc_gob_3') goldMul += 0.20;
        });
        
        // [NEW] è²ªå©ªè–åƒåŠ æˆ
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_greed')) goldMul += 1.0;

        gold = Math.floor(gold * goldMul);
        Player.gold += gold;
        this.showFloatingText(`+${gold} G`, "#ffd700");
        dropText += `é‡‘å¹£ +${gold} <br>`;

if (isGodKill) {
            const hourglass = {...CONFIG.specialItems.hourglass};
            this.addItemToInventory(hourglass);
            
            // [NEW] è‰è‰çµ²æˆ€æ„›æˆå°±åˆ¤å®š
            if (Player.lilithBlessing && !Player.lilithSacrificed) {
                 // ç²å¾—æˆ€æ„›æˆå°± (è‰è‰çµ²ç”Ÿå­˜)
                 Player.lilithBlessing = false; // ç§»é™¤ç‹€æ…‹ï¼Œä½†æˆå°±å·²é”æˆ
                 dropText += "<span style='color:#ff00ff;'>ğŸ’— è‰è‰çµ²çš„æ„›ï¼šå¥¹ç•™åœ¨äº†ä½ èº«é‚Šã€‚</span><br>";
            } else if (Player.lilithSacrificed) {
                // ç²å¾—å‹åˆ©æˆå°± (è‰è‰çµ²çŠ§ç‰²)
                dropText += "<span style='color:#ff0000;'>ğŸ’” é­…é­”çš„å‹åˆ©ï¼šå¥¹åŒ–å…‰æ¶ˆæ•£äº†...</span><br>";
            }

            GameState.phase = "event_end";
            this.renderEvent("ğŸ† å¼’ç¥è€…", 
                "ä½ æ“Šæ•—äº†ç¥ä¹‹ä»£è¡Œè€…ï¼Œæ‰“ç ´äº†é€™å€‹ä¸–ç•Œçš„æ·é–ã€‚", 
                "ç²å¾— <span class='rarity-ultra'>è¼ªè¿´æ²™æ¼</span>ã€‚<br>éŠæˆ²é€²å…¥ç„¡ç›¡æ¨¡å¼ï¼Œæˆ–ä½¿ç”¨æ²™æ¼é–‹å•Ÿæ–°çš„è¼ªè¿´ã€‚", 
                "â³");
            
            this.showFloatingText("ç²å¾— è¼ªè¿´æ²™æ¼", "#00ffcc");
            this.checkAchievements(); // æª¢æŸ¥å¼’ç¥è€…æˆå°±
            this.setButtons("ç¹¼çºŒç„¡ç›¡å†’éšª", "nextEvent", "ç„¡", null, true);
            return; // ç›´æ¥çµæŸï¼Œä¸åŸ·è¡Œä¸€èˆ¬æ‰è½
        }
        
        if (isOldOneKill) {
             this.checkAchievements(); // æª¢æŸ¥èˆŠæ—¥çµ‚çµæˆå°±
        }


// [NEW] æ‰è½å·§å…‹åŠ› (0.1%)
        if (Math.random() < 0.001) {
             const choco = {...CONFIG.specialItems.chocolate};
             this.addItemToInventory(choco);
             dropText += `ç²å¾— <span class='rarity-epic'>${choco.name}</span><br>`;
        }

        if (enemy.isTrueForm) {
            if (CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"]) {
                drops.push({ ...CONFIG.lootData["çœŸå¯¦ä¹‹å¿ƒ"], name: "çœŸå¯¦ä¹‹å¿ƒ", type: "loot" });
            }
        } 
        else if (Player.inInferno) {
             let dropRate = 0.5; // é è¨­ 50%
             const dName = enemy.drop;
             
             // 1. T1: å²èŠå§† / é­”çœ¼ (50%)
             if (dName === "æš—å½±å‡è† " || dName === "è™›ç©ºä¹‹å¡µ") dropRate = 0.50;
             
             // 2. T2: é­”åƒ / æˆ°é¦¬ (40%)
             else if (dName === "ç†”å²©æ ¸å¿ƒ" || dName === "å¤¢é­˜ä¹‹è§’") dropRate = 0.40;
             
             // 3. T3 (èè‹±): é¨å£« / è§¸æ‰‹ (30%)
             else if (dName === "è…æœ½é§ç”²" || dName === "æ··æ²Œç¥ç¶“") dropRate = 0.30;
             
             // 4. T4 (Boss): ä¼¯çˆµ / å·«å¦– (20%)
             else if (dName === "é®®è¡€ç²¾è¯" || dName === "å‘½åŒ£ç¢ç‰‡") dropRate = 0.20;
             
             // 5. T5 (å¤§Boss): é­”é¾ (10%)
             else if (dName === "é­”é¾é€†é±—") dropRate = 0.10;
             
             // 6. ç‰¹æ®Š: èˆŠæ—¥æ”¯é…è€… (100%) - å› ç‚ºé­é‡ç‡æ¥µä½(0.1%)ï¼Œä¿æŒå¿…æ‰ä»¥å…ç„¡æ³•ç•¢æ¥­
             else if (dName === "ä¸å¯åç‹€ä¹‹ç‰©") dropRate = 1.0;

             if (Math.random() < dropRate && CONFIG.lootData[dName]) { 
                drops.push({ ...CONFIG.lootData[dName], name: dName, type: "loot" });
             }
        }

else {
            // --- [FIX] é€™è£¡æ˜¯è£œä¸Šçš„ï¼šè¡¨å±¤ä¸–ç•Œæ‰è½é‚è¼¯ ---
            let dName = "";
            // æ ¹æ“šéšç´šæ±ºå®šæ‰è½ç‰© (é€™äº›å±¬æ€§åœ¨ CONFIG.monsters éƒ½æœ‰å®šç¾©)
            if (enemy.tier === 'boss') dName = enemy.bossDrop;
            else if (enemy.tier === 'elite') dName = enemy.eliteDrop;
            else dName = enemy.drop;

            // ç¢ºä¿è©²ç‰©å“å­˜åœ¨æ–¼ lootData ä¸­
            if (dName && CONFIG.lootData[dName]) {
                drops.push({ ...CONFIG.lootData[dName], name: dName, type: "loot" });
            }
        }


        if (Math.random() < 0.1) {
            drops.push(this.generateRandomItem(enemy.tier));
        }

        drops.forEach(item => {
            this.addItemToInventory(item);
            let colorClass = item.rarity ? CONFIG.rarityDisplay[item.rarity].color : "";
            if(item.rarity === 'mythic') colorClass = 'rarity-mythic';
            dropText += `ç²å¾— <span class='${colorClass}'>${item.name}</span><br>`;
        });

        let winTitle = "ğŸ† æˆ°é¬¥å‹åˆ©";
        if(enemy.isTrueForm) winTitle = "ğŸ‘‘ å¼’ç¥è€…";
        if(Player.inInferno) winTitle = "ğŸ”¥ ç…‰ç„å‹åˆ©";

        this.renderEvent(winTitle, "ä½ æ“Šæ•—äº†æ•µäººï¼", dropText || "æ²’æœ‰æ‰è½ä»»ä½•ç‰©å“ã€‚", "ğŸ‰");
        document.getElementById('event-icon').className = "monster-icon"; 
        this.checkAchievements();
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },

   flee() {
// [æ–°å¢] éˆé­‚å‹æ…‹ç¦æ­¢é€ƒè·‘æª¢æŸ¥
        if (Player.ghostTurns > 0) {
            this.showFloatingText("éˆé­‚ç„¡æ³•é€ƒé›¢...", "gray");
            this.setButtons("æ€¨å¿µæ”»æ“Š (2å€å‚·)", "combatRound", "ç„¡æ³•é€ƒè·‘", null, true);
            return;
        }

        // 1. å®šç¾©é€ƒè·‘ç‡
        let fleeRate = 0.5;

        if (GameState.currentEnemy && GameState.currentEnemy.isGardenBoss) {
            fleeRate = 1.0; 
            this.showFloatingText("ä½ é¸æ“‡äº†é›¢é–‹...", "#fff");
        }

        if (Player.buff) {
            if (Player.buff.id === 'angel_wings') fleeRate = 0.6;
            if (Player.buff.id === 'demon_wager') {
                fleeRate = 0.8;
                if (Math.random() < 0.01) {
                    Player.hp = 0;
                    this.checkDeath("æ­»æ–¼æƒ¡é­”è³­ç´„");
                    return;
                }
            }
        }
        
        // --- [FIX: å•é¡Œ 5] æ‡¶æƒ°è©›å’’å¹³è¡¡èª¿æ•´ ---
        // é›–ç„¶ç„¡æ³•æ”»æ“Šï¼Œä½†é€ƒè·‘ç‡å¤§å¹…æå‡ï¼Œé¿å…å› å¿…é ˆæˆåŠŸ10æ¬¡è€Œå—åˆ°éå¤šå‚·å®³
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
             fleeRate = 0.8; // æå‡è‡³ 80%
        }

        // 3. åŸ·è¡Œé€ƒè·‘åˆ¤å®š
        if (Math.random() < fleeRate) {
            // --- é€ƒè·‘æˆåŠŸ ---

            // --- [FIX: å•é¡Œ 5] æ‡¶æƒ°è©›å’’æ‰£é™¤é‚è¼¯ (ç§»è‡³æˆåŠŸå€å¡Š) ---
            if (Player.debuff && Player.debuff.id === 'sloth_curse') {
                if (isNaN(Player.sinState.slothCount)) Player.sinState.slothCount = 10;
                
                Player.sinState.slothCount--;
                
                // å¦‚æœæ¬¡æ•¸æ­¸é›¶ï¼Œè§£é™¤è©›å’’
                if (Player.sinState.slothCount <= 0) {
                    Player.debuff = null;
                    const ring = CONFIG.sinItems.find(i => i.id === 'acc_sloth');
                    this.addItemToInventory({...ring});
                    alert("ğŸ’¤ æ‡¶æƒ°çš„è©¦ç…‰çµæŸï¼Œç²å¾—ã€çœ æˆ’ã€‘ï¼");
                    this.checkAchievements(); 
                    
                    // ç«‹å³è§£é–æ”»æ“ŠæŒ‰éˆ•
                    const btnMain = document.getElementById('btn-main');
                    if (btnMain) {
                        btnMain.disabled = false;
                        btnMain.innerText = "æˆ°é¬¥";
                        btnMain.style.opacity = "1";
                        btnMain.style.cursor = "pointer";
                    }
                } else {
                    this.showFloatingText(`æ‡¶æƒ°è©›å’’: å‰© ${Player.sinState.slothCount} å ´`, "gray");
                }
            }

            GameState.phase = "event_end";
            this.renderEvent("ğŸ’¨ é€ƒè·‘æˆåŠŸ", "ä½ æˆåŠŸç”©æ‰äº†æ€ªç‰©ã€‚", "", "ğŸƒ");
            document.getElementById('event-icon').className = "monster-icon";
            
            // ç¢ºä¿æŒ‰éˆ•æ¢å¾©å¯ç”¨ç‹€æ…‹
            const btnMain = document.getElementById('btn-main');
            if (btnMain) { // å¢åŠ åˆ¤æ–·é˜²æ­¢å ±éŒ¯
                btnMain.disabled = false;
                btnMain.style.opacity = "1";
                btnMain.style.cursor = "pointer";
            }
            
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        } else {
            // --- é€ƒè·‘å¤±æ•— ---
            const enemy = GameState.currentEnemy;
            let mDmg = enemy.atk;
            let msg = "";
            let s = Player.equipment.shield;
            
            // çœ æˆ’æ¸›å‚·
            if (Player.equipment.accessories.some(a => a && a.id === 'acc_sloth')) {
                mDmg = Math.floor(mDmg * 0.5);
                this.showFloatingText("çœ æˆ’æ¸›å‚·", "#aaa");
            }
            
            this.triggerAnim('event-icon', 'anim-lunge');

if (Player.buff && Player.buff.id === 'demon_wealth') {
                let loss = 5;
                if (Player.gold < 5) loss = Player.gold; // é¿å…æ‰£åˆ°è² æ•¸
                Player.gold -= loss;
                this.showFloatingText(`-${loss} G`, "gray");
                msg += `<br><span class='damage-text'>æƒ¡é­”çš„å¥‘ç´„ç”Ÿæ•ˆï¼šé‡‘å¹£ -${loss}</span>`;
            }

            if (s && s.val > 0) {
                s.val--;
                this.showFloatingText("æ ¼æ“‹!", "#2196f3");
                msg = `é€ƒè·‘å¤±æ•—ï¼ä½†<span class='block-text'>ç›¾ç‰ŒæŠµæ“‹äº†è¿½æ“Š</span>ï¼`;
                if (s.val <= 0) {
                    msg += `<br><span class='damage-text'>ğŸ’” ä½ çš„ ${s.name} ç¢è£‚äº†ï¼</span>`;
                    Player.equipment.shield = null;
                    this.recalcStats();
                }
            } else {
                Player.hp -= mDmg;
                this.triggerAnim('game-container', 'anim-screen-shake');
                this.showFloatingText(`-${mDmg}`, "red");
                msg = `é€ƒè·‘å¤±æ•—ï¼å—åˆ° ${mDmg} å‚·å®³ã€‚`;
            }
            
            if (Player.hp <= 0) {
                this.checkDeath("é€ƒè·‘å¤±æ•—è¢«æ®ºæ­»");
            } else {
                this.renderEvent(`âš”ï¸ ${enemy.name}`, `æ•µæ–¹ HP: ${enemy.hp}`, msg, enemy.icon);
                this.updateUI();
            }
        }
    },

    // --- Standard Events ---
    triggerClassEvent() {
        if(Player.inInferno) { this.triggerInfernoCombat(); return; }
        GameState.phase = "event_end";
        if (Player.class === 'knight') this.handleKnightEvent();
        else if (Player.class === 'merchant') this.handleMerchantEvent();
        else if (Player.class === 'thief') this.handleThiefEvent();
        else if (Player.class === 'cultist') this.handleCultistEvent();
        else this.nextEvent();
    },
    handleKnightEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš”ï¸ é¨å£«çš„è·è²¬", "ç™¼ç¾ä¸€ç¾¤è¢«æ€ªç‰©åŒ…åœçš„æ¢éšªè€…...", "æ˜¯å¦å‡ºæ‰‹ç›¸åŠ©ï¼Ÿ", "ğŸ›¡ï¸");
        this.setButtons("å¹«åŠ© (60%å‹)", "resolveKnightHelp", "ç„¡è¦–", "nextEvent", false);
    },
    resolveKnightHelp() {
        if (Math.random() < 0.6) {
            Player.gold += 100;
            this.showFloatingText("+100 G", "gold");
            this.renderEvent("âš”ï¸ æ•‘æ´æˆåŠŸ", "ä½ æˆåŠŸæ“Šé€€äº†æ€ªç‰©ï¼", "ç²å¾—å ±é…¬ <span class='gold-text'>100 G</span>", "ğŸ‰");
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("âš”ï¸ æ•‘æ´å¤±æ•—", "æ€ªç‰©å¤ªå¼·äº†ï¼Œä½ å—äº†é‡å‚·...", `æå¤± <span class='damage-text'>${dmg} HP</span>`, "ğŸ©¸");
            if (Player.hp <= 0) { this.checkDeath("æ­»æ–¼æ•‘æ´è¡Œå‹•"); return; }
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    handleMerchantEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("âš–ï¸ é»‘å¸‚äº¤æ˜“", "é‡åˆ°ä¸€åå¯ç–‘çš„é»‘å¸‚å•†äººã€‚", "èŠ±è²» 66 G è³¼è²·ç¥ç§˜ç‰©å“ï¼Ÿ(10% è¢«é¨™)", "ğŸ•µï¸");
        this.setButtons("äº¤æ˜“ (66 G)", "resolveMerchantTrade", "é›¢é–‹", "nextEvent", false);
    },
    resolveMerchantTrade() {
        if (Player.gold < 66) { alert("é‡‘å¹£ä¸è¶³ï¼"); return; }
        Player.gold -= 66;
        this.showFloatingText("-66 G", "gold");
        if (Math.random() < 0.1) {
            this.renderEvent("ğŸ’¸ è¢«é¨™äº†ï¼", "å•†äººæ‹¿äº†éŒ¢å°±è·‘äº†ï¼", "ä½ ä»€éº¼éƒ½æ²’å¾—åˆ°ã€‚", "ğŸ’¨");
        } else {
            let item;
            if (Math.random() < 0.01) {
                const legends = CONFIG.itemPool.filter(i => i.rarity === 'legendary' || i.rarity === 'epic');
                item = Object.assign({}, legends[Math.floor(Math.random() * legends.length)]);
            } else {
                item = this.generateSpecificItem(['weapon', 'armor', 'shield', 'consumable']);
            }
            this.addItemToInventory(item);
            this.renderEvent("âš–ï¸ äº¤æ˜“æˆåŠŸ", "ä½ ç²å¾—äº†ä¸€å€‹ç¥ç§˜åŒ…è£¹...", `ç²å¾— <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    handleThiefEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—ï¸ é‡‘è‰²å¯¶ç®±", "é è™•ç™¼ç¾ä¸€å€‹æ•£ç™¼å…‰èŠ’çš„å¯¶ç®±...", "å˜—è©¦æ‰“é–‹ï¼Ÿ(5% ç²å¾—ç¥å™¨)", "âœ¨");
        this.setButtons("æ‰“é–‹", "resolveThiefChest", "é›¢é–‹", "nextEvent", false);
    },
    resolveThiefChest() {
        if (Math.random() < 0.05) {
            const artifacts = CONFIG.itemPool.filter(i => i.rarity === 'legendary' && ['è–åŠ Excalibur', 'ç¥ä¹‹å…‰è¼', 'åŸƒç™¸æ–¯ä¹‹ç›¾'].includes(i.name));
            if (artifacts.length > 0) {
                const template = artifacts[Math.floor(Math.random() * artifacts.length)];
                const item = Object.assign({}, template);
                this.addItemToInventory(item);
                this.renderEvent("âœ¨ å‚³èªªç¾ä¸–", "å¯¶ç®±è£¡ç«Ÿç„¶æ˜¯å‚³èªªç¥å™¨ï¼", `ç²å¾— <span class='rarity-legendary'>${item.name}</span>`, "ğŸ‘‘");
            } else {
                const item = this.generateRandomItem();
                this.addItemToInventory(item);
                this.renderEvent("ğŸ“¦ ç²å¾—ç‰©å“", "", `ç²å¾— ${item.name}`, "ğŸ“¦");
            }
        } else {
            let dmg = Math.floor(Player.hp * 0.5);
            Player.hp -= dmg;
            this.showFloatingText(`-${dmg} HP`, "red");
            this.renderEvent("ğŸ’¥ é™·é˜±è§¸ç™¼", "å¼·åŠ›çš„é­”æ³•ç‚¸é£›äº†ä½ ï¼", `æå¤± <span class='damage-text'>${dmg} HP</span>`, "ğŸ’£");
            if (Player.hp <= 0) { this.checkDeath("æ­»æ–¼é‡‘è‰²å¯¶ç®±é™·é˜±"); return; }
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    handleCultistEvent() {
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ² æƒ¡é­”çš„éŠæˆ²", "æƒ¡é­”é‚€è«‹ä½ ç©æ¯”å¤§å°...", "è´å¾—ç¨€æœ‰è£å‚™ï¼Œè¼¸äº†å‰© 1% è¡€é‡ã€‚", "ğŸ˜ˆ");
        this.setButtons("æ¥å—æŒ‘æˆ°", "resolveCultistGame", "æ‹’çµ•", "nextEvent", false);
    },
    resolveCultistGame() {
        const pRoll = Math.floor(Math.random() * 6) + 1;
        const dRoll = Math.floor(Math.random() * 6) + 1;
        let resultHtml = `ä½ æ“²å‡ºäº† ${pRoll}ï¼Œæƒ¡é­”æ“²å‡ºäº† ${dRoll}ã€‚<br>`;
        if (pRoll > dRoll) {
            let rarity = 'rare';
            let r = Math.random();
            if (r < 0.1) rarity = 'legendary';
            else if (r < 0.3) rarity = 'epic';
            let pool = CONFIG.itemPool.filter(i => i.rarity === rarity && ['weapon', 'armor', 'shield'].includes(i.type));
            if (pool.length === 0) pool = CONFIG.itemPool.filter(i => i.rarity === 'rare');
            const template = pool[Math.floor(Math.random() * pool.length)];
            const item = Object.assign({}, template);
            this.addItemToInventory(item);
            this.renderEvent("ğŸ² å‹åˆ©ï¼", resultHtml, `æƒ¡é­”ä¸ç”˜å¿ƒåœ°çµ¦äº†ä½  <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`, "ğŸ‰");
        } else {
            Player.hp = Math.floor(Player.maxHp * 0.01) || 1;
            this.showFloatingText("HP -> 1%", "darkred");
            this.renderEvent("ğŸ² å¤±æ•—...", resultHtml, "æƒ¡é­”å¥ªèµ°äº†ä½ çš„ç”Ÿå‘½åŠ›...", "ğŸ’€");
        }
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    triggerHeal() {
        const oldHp = Player.hp;
        Player.hp = Player.maxHp; 
        const healed = Player.hp - oldHp;
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’– ä¼‘æ¯æ™‚åˆ»", "ä½ æ‰¾åˆ°ä¸€è™•å®‰å…¨çš„åœ°æ–¹ä¼‘æ¯ã€‚", `ç”Ÿå‘½å€¼ <span class='heal-text'>å®Œå…¨æ¢å¾©</span> (æ¢å¾©äº† ${healed} é»)ã€‚`, "ğŸ›Œ");
        if(healed > 0) this.showFloatingText(`+${healed} HP`, "#69f0ae");
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    triggerStatue() {
        GameState.phase = "event_end";
		// [NEW] è‹¥å·²å‹¾é¸è‡ªå‹•ç•¥éï¼Œç›´æ¥ç•¶ä½œæŒ‰ã€Œé›¢é–‹ã€
        if (Player.autoSkipStatue) {
            // çµ¦å€‹å°æç¤ºï¼ˆå¯è¦–éœ€è¦æ‹¿æ‰ï¼‰
            this.showFloatingText("ç•¥éç¥ˆç¦±è–åƒ", "#888888");
            this.nextEvent();   // ç›´æ¥è·³åˆ°ä¸‹ä¸€å€‹äº‹ä»¶
            return;
        }
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ—¿ ç¥ˆç¦±è–åƒ", "ä½ ç™¼ç¾äº†ä¸€åº§å¤è€çš„è–åƒ...", "æ˜¯å¦è¦é€²è¡Œç¥ˆç¦±ï¼Ÿ", "ğŸ™");
        this.setButtons("ç¥ˆç¦±", "pray", "é›¢é–‹", "nextEvent", false);
    },
    pray() {
        if (!CONFIG.buffs) return; 
        const isAngel = Math.random() < 0.5;
        const type = isAngel ? 'angel' : 'demon';
        const icon = isAngel ? "ğŸ‘¼" : "ğŸ˜ˆ";
        const options = Object.values(CONFIG.buffs).filter(b => b.type === type);
        if (options.length === 0) return;
        const selected = options[Math.floor(Math.random() * options.length)];
        Player.buff = selected;
        let title = isAngel ? "å¤©ä½¿è–åƒ" : "æƒ¡é­”è–åƒ";
        let style = isAngel ? "angel-text" : "demon-text";
        this.triggerAnim('event-icon', 'anim-spawn');
        let desc = `ä½ ç²å¾—äº† <span class='${style}'>${selected.name}</span> çš„æ•ˆæœã€‚<br><small>${selected.desc}</small>`;
        this.renderEvent(title, "ç¥ˆç¦±å¾—åˆ°äº†å›æ‡‰...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
        this.updateUI();
    },
    triggerMerchant() {
        GameState.phase = "merchant";
GameState.merchantRefreshed = false;
        this.generateMerchantStock();
        this.triggerAnim('event-icon', 'anim-spawn');
        this.renderEvent("ğŸ’° ç¥ç§˜å•†äºº", "ã€Œç´ æå¯æ˜¯å¾ˆå€¼éŒ¢çš„ï¼Œè¦è³£ä¸€äº›å—ï¼Ÿã€", "é»æ“Šå•†å“å¯æŸ¥çœ‹è©³æƒ…èˆ‡è³¼è²·", "ğŸ‘³");
        this.setButtons("é›¢é–‹", "nextEvent", "ç„¡", null, true);
        this.renderMerchantShop();
    },
    generateMerchantStock() {
        GameState.merchantStock = [];
        // [MODIFIED] å•†äººå¯è²· 6 å€‹ï¼Œå…¶ä»–äºº 4 å€‹
        let stockCount = (Player.class === 'merchant') ? 6 : 4;
        for(let i=0; i<stockCount; i++) {
            GameState.merchantStock.push(this.generateRandomItem());
        }
    },
    getItemDesc(item) {
        if (item.id === 'acc_phylactery') {
            return `${item.desc} (ç›®å‰éˆé­‚: ${Player.souls})`;
        }
        // -------------------------------------

        if (item.desc) return item.desc;
        if (item.type === 'weapon') return `æ”»æ“ŠåŠ› +${item.val}`;
        if (item.type === 'armor') return `ç”Ÿå‘½ä¸Šé™ +${item.val}`;
        if (item.type === 'shield') return `æŠµæ“‹ ${item.val} æ¬¡æ”»æ“Š`;
        if (item.type === 'loot') return `æˆ°åˆ©å“ (å¯é«˜åƒ¹å‡ºå”®)`;
        return "æœªçŸ¥ç‰©å“";
    },
renderMerchantShop() {
        const area = document.getElementById('merchant-area');
        area.innerHTML = "";
        area.classList.remove('hidden');
        
        // [ä¿®æ”¹ 1] ç§»é™¤åŸæœ¬é€™è£¡çš„ã€Œåˆ·æ–°æŒ‰éˆ•ã€é‚è¼¯ï¼Œåªä¿ç•™æ¨™é¡Œ
        let buyHtml = "<h4>è³¼è²·å•†å“</h4>"; 

        buyHtml += "<div class='merchant-grid'>";
        GameState.merchantStock.forEach((item, idx) => {
            if (!item) return;
            const desc = this.getItemDesc(item);
            const rarityColor = CONFIG.rarityDisplay[item.rarity].color;
            const isDemon = GameState.phase === 'demon_merchant';
            const priceLabel = isDemon ? `éœ€ ${item.price} G` : `${item.price} G`;
            
            buyHtml += `<div class="merchant-item ${rarityColor}" onclick="Game.buyItem(${idx})">
                <div class="m-top">
                    <span>${item.icon || 'ğŸ“¦'} ${item.name}</span>
                    <span class="gold-text">${priceLabel}</span>
                </div>
                <div class="m-desc">${desc}</div>
            </div>`;
        });
        buyHtml += "</div>";

        if (GameState.phase === 'demon_merchant' && Player.sinState.greedActive) {
            buyHtml += `<div style="margin-top:10px; border:1px solid red; padding:5px; text-align:center;">
                <div style="color:red; font-weight:bold;">â›“ï¸ æ¶ˆé™¤é»ƒé‡‘æ·é–</div>
                <button onclick="Game.removeGreedDebuff()" style="background:darkred; color:white; width:100%; margin-top:5px;">æ”¯ä»˜ 10000 G</button>
            </div>`;
        }

        // [ä¿®æ”¹ 2] åœ¨åº•éƒ¨åŠ å…¥ã€Œåˆ·æ–°ã€æŒ‰éˆ•ï¼Œæ”¾åœ¨ã€Œä¸€éµå‡ºå”®ã€çš„å·¦é‚Šï¼Œæ¨£å¼è¨­ç‚ºä¸€æ¨£å¤§å°
        let refreshBtnHtml = "";
        if (!GameState.merchantRefreshed) {
            // æœªåˆ·æ–°ï¼šé¡¯ç¤ºè—è‰²å°æŒ‰éˆ•
            refreshBtnHtml = `<button onclick="Game.refreshShop()" style="padding:5px 10px; font-size:0.8em; background:#2196f3; margin-right:5px;">ğŸ”„ åˆ·æ–°</button>`;
        } else {
            // å·²åˆ·æ–°ï¼šé¡¯ç¤ºæ–‡å­—æç¤º
            refreshBtnHtml = `<span style="color:#666; font-size:0.8em; margin-right:10px;">(å·²åˆ·æ–°)</span>`;
        }

       // [ä¿®æ”¹] é€™è£¡åŠ å…¥äº†ã€Œé¸æ“‡å‡ºå”®ã€æŒ‰éˆ•
        buyHtml += `<div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <h4>å‡ºå”®</h4>
            <div style="display:flex; align-items:center; gap: 5px;">
                ${refreshBtnHtml}
                <button onclick="Game.openSellMenu()" style="padding:5px 10px; font-size:0.8em; background:#ff9800; color:black; font-weight:bold;">é¸æ“‡å‡ºå”®</button>
                <button onclick="Game.sellAllMaterials()" style="padding:5px 10px; font-size:0.8em; background:#d32f2f;">ä¸€éµå‡ºå”®</button>
            </div>
        </div>
        <p style='font-size:0.8em; color:#888'>é»æ“Šä¸‹æ–¹èƒŒåŒ…ç‰©å“å³å¯å‡ºå”®ã€‚</p>`;
        
        area.innerHTML = buyHtml;
    },
    buyItem(idx) {
        const item = GameState.merchantStock[idx];
        if (!item) return;
        if (Player.gold >= item.price) {
            Player.gold -= item.price;
            this.addItemToInventory(item);
            GameState.merchantStock[idx] = null;
            this.showFloatingText("- " + item.price + " G", "yellow");
            this.log(`è³¼è²·äº† ${item.name}`);
            this.updateUI();
            this.renderMerchantShop();
        } else {
            alert("é‡‘å¹£ä¸è¶³ï¼");
        }
    },

refreshShop() {
        if (GameState.merchantRefreshed) return;

        // åˆ¤æ–·æ˜¯å“ªç¨®å•†äºº
        if (GameState.phase === 'merchant') {
            this.generateMerchantStock();
        } else if (GameState.phase === 'demon_merchant') {
            this.generateDemonStock();
        } else {
            return;
        }

        GameState.merchantRefreshed = true; // æ¨™è¨˜ç‚ºå·²åˆ·æ–°
        this.showFloatingText("å•†å“å·²åˆ·æ–°", "#2196f3");
        this.renderMerchantShop(); // é‡æ–°æ¸²æŸ“ä»‹é¢
    },
    removeGreedDebuff() {
        if (Player.gold >= 10000) {
            Player.gold -= 10000;
            Player.sinState.greedActive = false;
            
            // [FIX] åªç§»é™¤è²ªå©ªè©›å’’ï¼Œä¸å½±éŸ¿å…¶ä»– debuff (å¦‚æœæœªä¾†æœ‰å¤šé‡ debuff éœ€æ”¹é‚è¼¯ï¼Œç›®å‰ç°¡å–®è™•ç†)
            if (Player.debuff && Player.debuff.id === 'greed_shackle') {
                Player.debuff = null;
            }
            
            this.showFloatingText("æ·é–è§£é™¤", "white");
            this.renderMerchantShop();
            this.updateUI();
        } else {
            alert("é‡‘å¹£ä¸è¶³ï¼");
        }
    },
// [æ–°å¢] åˆ¤æ–·ç‰©å“æ˜¯å¦å—ä¿è­· (å…±ç”¨é‚è¼¯)
    isProtectedItem(item) {
        if (item.type === 'revive') return true;
const protectedNames = ['å½ˆå¼“', 'é‰¤å­', 'å……æ»¿é­”åŠ›çš„å·§å…‹åŠ›', 'ç´™æ¢', 'åŸç½ªä¹‹å† ', 'è¼ªè¿´æ²™æ¼', 'ç¥è–å…‰åŠ', 'çœŸå¯¦ä¹‹å¿ƒ'];
        if (protectedNames.includes(item.name)) return true;
        return false;
    },

    // [æ–°å¢] é–‹å•Ÿé¸æ“‡å‡ºå”®é¸å–®
    openSellMenu() {
        const modal = document.getElementById('sell-modal');
        const grid = document.getElementById('sell-options-grid');
        grid.innerHTML = "";
        
        // çµ±è¨ˆå„ç¨€æœ‰åº¦çš„å¯å‡ºå”®ç‰©å“
        const stats = { common: [], uncommon: [], rare: [], epic: [], legendary: [] };
        let hasItems = false;

        Player.inventory.material.forEach(item => {
            if (this.isProtectedItem(item)) return; // è·³éå—ä¿è­·ç‰©å“
            
            // æ­¸é¡
            if (stats[item.rarity]) {
                stats[item.rarity].push(item);
                hasItems = true;
            }
        });

        const rarityLabels = {
            common: { label: "ä¸€èˆ¬", color: "#b0b0b0" },
            uncommon: { label: "å„ªè³ª", color: "#4caf50" },
            rare: { label: "ç¨€æœ‰", color: "#2196f3" },
            epic: { label: "å²è©©", color: "#9c27b0" },
            legendary: { label: "å‚³èªª", color: "#ffd700" }
        };

        // ç”ŸæˆæŒ‰éˆ•
        Object.keys(rarityLabels).forEach(rarity => {
            const items = stats[rarity];
            if (items.length > 0) {
                // è¨ˆç®—ç¸½åƒ¹
                let totalPrice = 0;
                items.forEach(i => {
                    let p = i.price || 0;
                    if (Player.class === 'merchant') p = Math.floor(p * 1.2);
                    totalPrice += p;
                });

                const info = rarityLabels[rarity];
                
                // å»ºç«‹æŒ‰éˆ•
                const btn = document.createElement('button');
                btn.style.cssText = `width:100%; padding:10px; border:1px solid ${info.color}; background:rgba(0,0,0,0.3); color:${info.color}; display:flex; justify-content:space-between; align-items:center; cursor:pointer; margin-bottom:5px;`;
                btn.innerHTML = `
                    <span>${info.label}ç´ æ (x${items.length})</span>
                    <span style="color:gold; font-weight:bold;">+${totalPrice} G</span>
                `;
                btn.onclick = () => this.sellByRarity(rarity);
                grid.appendChild(btn);
            }
        });

        if (!hasItems) {
            grid.innerHTML = "<div style='color:#666; padding:20px;'>æ²’æœ‰å¯å‡ºå”®çš„ç´ æ</div>";
        }

        modal.style.display = 'flex';
    },

    // [æ–°å¢] åŸ·è¡Œç‰¹å®šç¨€æœ‰åº¦å‡ºå”®
    sellByRarity(rarity) {
        let total = 0;
        let count = 0;
        const newMats = [];
        
        Player.inventory.material.forEach(item => {
            // å¦‚æœæ˜¯è©²ç¨€æœ‰åº¦ ä¸” ä¸å—ä¿è­· -> è³£æ‰
            if (item.rarity === rarity && !this.isProtectedItem(item)) {
                let p = item.price || 0;
                if (Player.class === 'merchant') p = Math.floor(p * 1.2);
                total += p;
                count++;
            } else {
                newMats.push(item); // ä¿ç•™
            }
        });

        Player.inventory.material = newMats;
        Player.gold += total;
        this.showFloatingText(`+ ${total} G`, "yellow");
        
        // é‡æ–°æ•´ç†ä»‹é¢èˆ‡é¸å–®
        this.updateUI();
        this.openSellMenu(); // é‡æ–°æ•´ç†é¸å–®æ•¸å­—
        this.renderMerchantShop(); // æ›´æ–°èƒŒæ™¯çš„å•†åº—ä»‹é¢
    },

    sellAllMaterials() {
        if (GameState.phase !== "merchant" && GameState.phase !== "demon_merchant") return;
        
        // å…ˆæª¢æŸ¥æœ‰æ²’æœ‰å¯è³£çš„ (æ’é™¤å—ä¿è­·ã€ç¥è©±ã€æ¥µå‚³èªª)
        const sellable = Player.inventory.material.filter(i => 
            !this.isProtectedItem(i) && 
            i.rarity !== 'mythic' && 
            i.rarity !== 'ultra'
        );

        if (sellable.length === 0) {
            alert("æ²’æœ‰å¯å‡ºå”®çš„ç´ æ (å—ä¿è­·ç‰©å“èˆ‡ç¥è©±ç´šä»¥ä¸Šä¸æœƒè¢«å‡ºå”®)ã€‚");
            return;
        }

        if(!confirm(`ç¢ºå®šè¦å‡ºå”®æ‰€æœ‰ä¸€èˆ¬ç´ æå—ï¼Ÿ\n(å—ä¿è­·ç‰©å“èˆ‡ç¥è©±ç´šä»¥ä¸Šä¸æœƒè¢«è¨ˆç®—)`)) return;

        let total = 0;
        const newMats = [];
        
        Player.inventory.material.forEach(item => {
            // [ä¿®æ”¹] ä¿ç•™æ¢ä»¶ï¼šå—ä¿è­· OR ç¥è©±ç´š OR æ¥µå‚³èªªç´š
            if (this.isProtectedItem(item) || item.rarity === 'mythic' || item.rarity === 'ultra') {
                newMats.push(item);
            } else {
                let price = item.price; 
                if (Player.class === 'merchant') price = Math.floor(price * 1.2);
                total += price;
            }
        });
        
        Player.inventory.material = newMats;
        Player.gold += total;
        this.showFloatingText("+ " + total + " G", "yellow");
        this.updateUI();
    },
    sellItem(index, category) {
        // [FIX] ä¿®æ­£ï¼šå…ˆå–å¾— item ç‰©ä»¶ï¼Œæ‰èƒ½é€²è¡Œæª¢æŸ¥
        const item = Player.inventory[category][index];
        if (!item) return;

        // [MODIFIED] åŠ å…¥ä¿è­· (ç¾åœ¨ item å·²å®šç¾©ï¼Œå¯ä»¥æª¢æŸ¥äº†)
        if (this.isProtectedItem(item)) {
            alert("é€™ä»¶ç‰©å“ç„¡æ³•å‡ºå”®ï¼");
            return;
        }
        
        if (GameState.phase !== "merchant" && GameState.phase !== "demon_merchant") return; 
        
        let price = item.price || 0;
        if (['weapon', 'armor', 'shield', 'consumable'].includes(item.type)) {
            price = Math.floor(price * 0.8);
        }
        if (Player.class === 'merchant') {
            price = Math.floor(price * 1.2);
        }
        
        if(confirm(`ç¢ºå®šè¦ä»¥ ${price} G å‡ºå”® ${item.name} å—ï¼Ÿ`)) {
            Player.inventory[category].splice(index, 1);
            Player.gold += price;
            this.showFloatingText("+ " + price + " G", "yellow");
            this.updateUI();
        }
    },

    triggerChest() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        // ä¿®æ”¹ï¼šä¸å†ç›´æ¥è¨ˆç®—çµæœï¼Œè€Œæ˜¯è©¢å•ç©å®¶
        this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "è§’è½è£¡æ”¾è‘—ä¸€å€‹æ™®é€šçš„æœ¨è£½å¯¶ç®±...", "è£¡é¢å¯èƒ½æœ‰å¯¶ç‰©ï¼Œä½†ä¹Ÿå¯èƒ½æ˜¯è‡´å‘½çš„é™·é˜±ã€‚\nè¦å†’éšªæ‰“é–‹å—ï¼Ÿ", "ğŸ“¦");
        
        // è¨­å®šæŒ‰éˆ•ï¼šæ‰“é–‹ -> åŸ·è¡Œ resolveChestï¼Œé›¢é–‹ -> ä¸‹ä¸€å€‹äº‹ä»¶
        this.setButtons("æ‰“é–‹", "resolveChest", "é›¢é–‹", "nextEvent", false);
    },

    // æ–°å¢ï¼šè™•ç†æ‰“é–‹å¯¶ç®±å¾Œçš„é‚è¼¯ (åŸæœ¬çš„ç¨‹å¼ç¢¼ç§»åˆ°é€™è£¡)
    resolveChest() {
        // --- ç‰¹æ®Šæ‰è½åˆ¤å®š (ä¿æŒåŸæœ¬æ©Ÿç‡) ---
        if (Math.random() < 0.005) {
            const choco = {...CONFIG.specialItems.chocolate};
            this.addItemToInventory(choco);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", `ç²å¾—äº†æ•£ç™¼ç”œå‘³çš„ <span class='rarity-epic'>${choco.name}</span>ï¼`, "ğŸ«");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }
        if (Math.random() < 0.01) {
            const feather = {...CONFIG.phoenixFeather};
            this.addItemToInventory(feather);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", "å¥‡è¹Ÿç™¼ç”Ÿäº†ï¼ç²å¾— <span class='rarity-legendary'>ä¸æ­»é³¥çš„ç¾½æ¯›</span>ï¼", "ğŸª¶");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }
        
        if (Math.random() < 0.01 && CONFIG.lootData["å½ˆå¼“"]) {
            const item = { ...CONFIG.lootData["å½ˆå¼“"], name: "å½ˆå¼“", type: "material" };
            this.addItemToInventory(item);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", `ç²å¾—äº†ç‰¹æ®Šçš„å·¥å…· <span class='rarity-rare'>å½ˆå¼“</span>ï¼`, "ğŸªƒ");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }

        if (Math.random() < 0.01 && CONFIG.lootData["é‰¤å­"]) {
            const item = { ...CONFIG.lootData["é‰¤å­"], name: "é‰¤å­", type: "material" };
            this.addItemToInventory(item);
            this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", `ç²å¾—äº†ç‰¹æ®Šçš„å·¥å…· <span class='rarity-rare'>é‰¤å­</span>ï¼`, "ğŸª");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }

        if (Math.random() < 0.01) {
            const tool = CONFIG.itemPool.find(i => i.name === "æ”œå¸¶å¼å·¥ä½œæª¯");
            if (tool) {
                this.addItemToInventory({...tool});
                this.renderEvent("ğŸ“¦ ç™¼ç¾å¯¶ç®±", "ä½ æ‰“é–‹äº†å¯¶ç®±...", `ç™¼ç¾äº†ç¨€æœ‰çš„ä¾¿åˆ©å·¥å…·ï¼<br>ç²å¾— <span class='rarity-rare'>æ”œå¸¶å¼å·¥ä½œæª¯</span>ï¼`, "ğŸ§°");
                this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
                return;
            }
        }

        // --- ä¸€èˆ¬ RNG åˆ¤å®š (é‡‘å¹£/é“å…·/é™·é˜±) ---
        const roll = Math.random();
        let title = "ğŸ“¦ ç™¼ç¾å¯¶ç®±";
        let desc = "";
        let icon = "ğŸ“¦";
        let isThief = Player.class === 'thief';
        let safeRoll = isThief ? roll * 0.8 : roll; // ç›œè³Šæ¯”è¼ƒä¸å®¹æ˜“é‡åˆ°é™·é˜±

        if (safeRoll < 0.30) {
            const amount = Math.floor(Math.random() * 50) + 10 + (Player.depth * 2);
            Player.gold += amount;
            desc = `ç²å¾—äº† <span class='gold-text'>${amount} G</span>`;
            this.showFloatingText(`+${amount} G`, "#ffd700");
        } else if (safeRoll < 0.60) {
            const item = this.generateSpecificItem(['consumable']);
            this.addItemToInventory(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (safeRoll < 0.80) {
            const item = this.generateSpecificItem(['weapon', 'armor', 'shield']);
            this.addItemToInventory(item);
            desc = `ç²å¾—äº† <span class='${CONFIG.rarityDisplay[item.rarity].color}'>${item.name}</span>`;
        } else if (safeRoll < 0.90) {
            desc = "è£¡é¢ç©ºç©ºå¦‚ä¹Ÿ...";
        } else {
            // é™·é˜±åˆ¤å®š
            const dmg = Math.floor(Player.maxHp * 0.15);
            Player.hp = Math.max(0, Player.hp - dmg);
            desc = `æ˜¯é™·é˜±ï¼å—åˆ°äº† <span class='damage-text'>${dmg}</span> é»å‚·å®³ã€‚`;
            this.triggerAnim('game-container', 'anim-screen-shake');
            this.showFloatingText(`-${dmg} HP`, "red");
            if(Player.hp === 0) { this.checkDeath("æ­»æ–¼å¯¶ç®±é™·é˜±"); return; }
        }

        this.renderEvent(title, "ä½ æ‰“é–‹äº†å¯¶ç®±...", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },


triggerInfernoHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        // çµ¦äºˆä¸æ­»é³¥ç¾½æ¯›
        const feather = {...CONFIG.phoenixFeather};
        this.addItemToInventory(feather);

        this.renderEvent("ğŸ¦… å“ˆæ¯”è·¯é", 
            "ä¸€éš»çœ¼ç¥éŠ³åˆ©çš„å“ˆæ¯”é£›éç…‰ç„ä¸Šç©ºï¼Œç‰ ç™¼ç¾äº†ä½ ...", 
            "å‡ºä¹æ„æ–™åœ°ï¼Œç‰ æ²’æœ‰æ”»æ“Šï¼Œè€Œæ˜¯ä¸Ÿä¸‹äº†ä¸€æ ¹ç‡ƒç‡’è‘—å¾®å…‰çš„ç¾½æ¯›å¾Œé£›èµ°äº†ã€‚<br><br>ç²å¾— <span class='rarity-legendary'>ä¸æ­»é³¥çš„ç¾½æ¯›</span>", 
            "ğŸ¦…");
            
        this.setButtons("æ’¿èµ·ä¸¦ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },

    triggerHarpy() {
        GameState.phase = "event_end";
        this.triggerAnim('event-icon', 'anim-spawn');
        
        if (Player.class === 'scarecrow') {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            this.renderEvent("ğŸ¦… é­é‡å“ˆæ¯”", "ä¸€éš»å“ˆæ¯”çªç„¶è¥²ä¾†ï¼", 
                "èº«ç‚ºç¨»è‰äººï¼Œä½ çš„å¤–è¡¨åš‡è·‘äº†å“ˆæ¯”ï¼<br>æ’¿åˆ°äº†ç‰ æ‰è½çš„ <span class='gold-text'>500 G</span>ï¼", "ğŸŒ¾");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }

        const slingIndex = Player.inventory.material.findIndex(i => i.name === 'å½ˆå¼“');
        if (slingIndex !== -1) {
            Player.inventory.material.splice(slingIndex, 1);
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            this.renderEvent("ğŸ¦… é­é‡å“ˆæ¯”", "ä¸€éš»å“ˆæ¯”çªç„¶è¥²ä¾†ï¼", `ä½ ä½¿ç”¨ <span class='rarity-rare'>å½ˆå¼“</span> æ“Šé€€äº†ç‰ ï¼(å½ˆå¼“å·²æå£)<br>æ’¿åˆ°äº†ç‰ æ‰è½çš„ <span class='gold-text'>500 G</span>ï¼`, "ğŸªƒ");
            this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
            return;
        }
        
        let repelBonus = 0;
        let autoRepel = false;
        Player.equipment.accessories.forEach(acc => {
            if(!acc) return;
            if(acc.id === 'acc_orc_1') repelBonus += 0.1;
            if(acc.id === 'acc_orc_2') repelBonus += 0.3;
            if(acc.id === 'acc_orc_3') autoRepel = true;
        });

        let winChance = 0.2 + repelBonus;
        let outcome = Math.random();
        let title = "ğŸ¦… é­é‡å“ˆæ¯”";
        let desc = "";
        let icon = "ğŸ¦…";

        if (autoRepel || outcome < winChance) {
            Player.gold += 500;
            this.showFloatingText("+500 G", "#ffd700");
            let extraMsg = autoRepel ? "(è™Ÿè§’å¨æ‡¾!)" : "";
            desc = `ä½ æˆåŠŸæ“Šé€€äº†å“ˆæ¯”${extraMsg}ï¼Œæ’¿åˆ°äº†å®ƒæ‰è½çš„ <span class='gold-text'>500 G</span>ï¼`;
        } else {
            const type = Math.floor(Math.random() * 4);
            if (type === 0) { Player.inventory.equipment = []; desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡æ‰€æœ‰çš„ <span class='damage-text'>è£å‚™</span>ï¼"; } 
            else if (type === 1) { Player.inventory.consumable = []; desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡æ‰€æœ‰çš„ <span class='damage-text'>æ¶ˆè€—å“</span>ï¼"; } 
            else if (type === 2) { 
                // [MODIFIED] å“ˆæ¯”ä¿è­·æ©Ÿåˆ¶
                const keptItems = Player.inventory.material.filter(i => 
                    this.isProtectedItem(i) // ä½¿ç”¨æ–°ä¿è­·å‡½å¼
                );
                const lostCount = Player.inventory.material.length - keptItems.length;
                Player.inventory.material = keptItems;
                
                if (lostCount > 0) desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èƒŒåŒ…è£¡å¤§éƒ¨åˆ†çš„ <span class='damage-text'>ç´ æ</span>ï¼(é‡è¦ç‰©å“é™¤å¤–)";
                else desc = "å“ˆæ¯”ç¿»äº†ç¿»ä½ çš„èƒŒåŒ…ï¼Œå»æ²’æ‰¾åˆ°æ„Ÿèˆˆè¶£çš„ç´ æã€‚";
            } 
            else { Player.gold = 0; desc = "å“ˆæ¯”æ¶èµ°äº†ä½ èº«ä¸Šæ‰€æœ‰çš„ <span class='damage-text'>é‡‘å¹£</span>ï¼"; }
        }
        this.renderEvent(title, "ä¸€éš»å“ˆæ¯”çªç„¶å¾ç©ºä¸­è¥²ä¾†ï¼", desc, icon);
        this.setButtons("ç¹¼çºŒ", "nextEvent", "ç„¡", null, true);
    },
    triggerCombat(isForcedBoss, checkTrueForm) {
        GameState.phase = "combat";

GameState.combatTurn = 0;
        GameState.enemyDominated = false;
        let baseMonster;
        let tier = "normal";
        let canFlee = true;

        if (isForcedBoss) {
            baseMonster = CONFIG.monsters[9]; 
            tier = "boss";
            canFlee = false;
        } else {
            baseMonster = this.getWeightedMonster();
            let rand = Math.random();
            if (Player.depth > 300) {
                if (rand < 0.1) tier = "normal"; else if (rand < 0.55) tier = "elite"; else tier = "boss";
            } else if (Player.depth > 100) {
                if (rand < 0.1) tier = "boss"; else if (rand < 0.6) tier = "elite"; else tier = "normal";
            } else {
                if (rand < 0.01) tier = "boss"; else if (rand < 0.11) tier = "elite"; else tier = "normal";
            }
        }

        let hpMul = 1, atkMul = 1;
        let namePrefix = "";
        
        if (Player.depth > 500) { hpMul *= 1.5; namePrefix += "æ·±æ·µ "; }
        if (tier === "elite") { hpMul *= 2; atkMul *= 1.5; namePrefix += "èè‹± "; }
        else if (tier === "boss") { hpMul *= 3; atkMul *= 2; namePrefix += "é¦–é ˜ "; }

        let enemy = {
            ...baseMonster,
            name: namePrefix + baseMonster.name,
            maxHp: Math.floor(baseMonster.hp * hpMul),
            hp: Math.floor(baseMonster.hp * hpMul),
            atk: Math.floor(baseMonster.atk * atkMul),
            tier: tier
        };

        // --- [NEW] åŸç½ªä¹‹å† ï¼šä¸–ç•Œç•°è®Š ---
        const hasCrown = Player.inventory.material.some(i => i.name === "åŸç½ªä¹‹å† ");
        if (hasCrown && !isForcedBoss && !enemy.isTrueForm) {
            enemy.name = "åŸåˆ " + enemy.name;
            enemy.hp *= 2;
            enemy.maxHp *= 2;
            enemy.atk *= 2;
            // æ¯æ¬¡æˆ°é¬¥éƒ½æç¤º
            this.showFloatingText("ä¸–ç•Œæ­£åœ¨å´©å¡Œ...", "#ff0000");
            setTimeout(() => this.showFloatingText("å¿«æ‰¾åˆ°é›¢é–‹çš„æ–¹æ³•", "#ff0000"), 1500);
        }

        if (checkTrueForm && !Player.inInferno) {
            const hasSword = Player.equipment.weapon && Player.equipment.weapon.name === "è–åŠ Excalibur";
            const hasArmor = Player.equipment.armor && Player.equipment.armor.name === "ç¥ä¹‹å…‰è¼";
            if (hasSword && hasArmor) {
                enemy.name = "é­”ç‹çœŸèº«";
                enemy.maxHp = 4000;
                enemy.hp = 4000;
                enemy.atk = 200;
                enemy.isTrueForm = true;
            }
        }

        GameState.currentEnemy = enemy;
        let iconClass = "monster-icon";
        if(tier === "elite") iconClass += " monster-elite glow-blue";
        if(tier === "boss") iconClass += " monster-boss glow-red";
        if(enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";

        document.getElementById('event-icon').className = iconClass;
        this.triggerAnim('event-icon', 'anim-spawn');
        
        this.renderEvent(`âš”ï¸ é­é‡ ${enemy.name}`, 
            `HP: ${enemy.hp} | æ”»æ“Š: ${enemy.atk}`, 
            "æº–å‚™æˆ°é¬¥ï¼", enemy.icon);
        this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", !canFlee);
if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main');
            const btnSub = document.getElementById('btn-sub');

            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ‡¶æƒ° (ç„¡æ³•æ”»æ“Š)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";

            btnSub.disabled = false;
            btnSub.innerText = "é€ƒè·‘";
        } else {
            document.getElementById('btn-main').disabled = false;
            document.getElementById('btn-main').style.opacity = "1";
            document.getElementById('btn-main').style.cursor = "pointer";
        }
    },

checkDeath(reason) {
const hasNecklace = Player.equipment.accessories.some(a => a && a.id === 'acc_dead');
        
        // 1. ã€å„ªå…ˆè§¸ç™¼ã€‘äº¡è€…é …éŠ
        // åªè¦æœ‰é …éŠä¸”é‚„æ²’è®Šé¬¼ï¼Œå°±å…ˆè®Šèº« (æœ€å„ªå…ˆ)
        if (hasNecklace && Player.hp <= 0 && Player.ghostTurns === 0 && GameState.currentEnemy && GameState.phase === 'combat') {
            Player.hp = 1;
            Player.ghostTurns = 3;
            this.renderEvent("ğŸ’€ äº¡è€…æ€¨å¿µ", "ä½ æ‹’çµ•å€’ä¸‹...", "é€²å…¥éˆé­‚å‹æ…‹ï¼(3å›åˆå…§å¿…é ˆæ“Šæ®ºæ•µäººï¼Œæ”»æ“ŠåŠ›ç¿»å€)", "ğŸ‘»");
            this.setButtons("æ€¨å¿µæ”»æ“Š (2å€å‚·)", "combatRound", "ç„¡æ³•é€ƒè·‘", null, true);
            this.updateUI();
            return; // é€™è£¡ returnï¼Œå› ç‚ºå·²ç¶“è®Šèº«äº†
        }

        // 2. ã€ä¿®æ”¹é€™è£¡ã€‘éˆé­‚å‹æ…‹å€’æ•¸
        if (Player.ghostTurns > 0) {
            Player.ghostTurns--;
            if (Player.ghostTurns <= 0) {
                // --- [FIX] ä¿®æ”¹é‡é»ï¼šéˆé­‚æ¶ˆæ•£å¾Œï¼Œä¸ç›´æ¥è™•æ­»ï¼Œè€Œæ˜¯ã€Œä¸ returnã€å¾€ä¸‹èµ° ---
                this.showFloatingText("éˆé­‚å‹æ…‹çµæŸ...", "gray");
                // è®“ç¨‹å¼ç¹¼çºŒå¾€ä¸‹åŸ·è¡Œï¼Œå»æª¢æŸ¥æœ‰æ²’æœ‰ç¾½æ¯›æˆ–è‰è‰çµ²
                // (æ³¨æ„ï¼šé€™è£¡ç§»é™¤åŸæœ¬çš„ this.playerDie å’Œ return)
            } else {
                // å¦‚æœé‚„æœ‰å›åˆæ•¸ï¼Œé–è¡€ä¸¦ return
                Player.hp = 1;
                this.renderEvent("ğŸ‘» éˆé­‚å‹æ…‹", `å‰©é¤˜ ${Player.ghostTurns} å›åˆ`, "ä½ ä¾é æ€¨å¿µç¶­æŒè‘—å½¢é«”...<br>å¿…é ˆç›¡å¿«æ“Šæ®ºæ•µäººï¼", "ğŸ’€");
                this.setButtons("æ€¨å¿µæ”»æ“Š (2å€å‚·)", "combatRound", "ç„¡æ³•é€ƒè·‘", null, true);
                this.updateUI();
                return; 
            }
        }        
        // [NEW] æ°¸ç”Ÿè­·ç¬¦ (å¾©æ´»)
        const hasPhylactery = Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery');
        if (hasPhylactery && Player.hp <= 0 && Player.souls >= 50) {
            Player.souls -= 50;
            Player.hp = Math.floor(Player.maxHp * 0.5);
            this.showFloatingText("å‘½åŒ£å¾©æ´»", "#00ffcc");
            this.renderEvent("âš±ï¸ æ°¸ç”Ÿè­·ç¬¦", "å‘½åŒ£ç ´ç¢ï¼Œé‡çµ„äº†ä½ çš„è»€é«”ã€‚", `æ¶ˆè€— 50 éˆé­‚ï¼Œå¾©æ´»ï¼(å‰©é¤˜éˆé­‚: ${Player.souls})`, "âœ¨");
            this.updateUI();
            return;
        }

        // ä¸æ­»é³¥ç¾½æ¯›é‚è¼¯
    const featherIdx = Player.inventory.material.findIndex(i => i.id === 'phoenix_feather');
    if (featherIdx !== -1) {
        Player.inventory.material.splice(featherIdx, 1);
        Player.hp = Math.floor(Player.maxHp * 0.5);
        
        this.renderEvent("ğŸ”¥ æµ´ç«é‡ç”Ÿ", "ä¸æ­»é³¥çš„ç¾½æ¯›ç‡ƒç‡’æ®†ç›¡...", "ä½ å¾©æ´»äº†ä¸¦æ¢å¾© 50% HPã€‚<br>è«‹é‡æ•´æ…‹å‹¢ï¼Œæº–å‚™ç¹¼çºŒæˆ°é¬¥ã€‚", "ğŸ¦…");
        
        // ğŸ”´ [ä¿®æ”¹é‡é»] é€™è£¡åŠ å…¥ && GameState.phase === 'combat' çš„åˆ¤æ–·
        // åªæœ‰ç•¶ã€Œæœ‰æ•µäººè³‡æ–™ã€ä¸”ã€Œç•¶å‰è™•æ–¼æˆ°é¬¥ç‹€æ…‹ã€æ™‚ï¼Œæ‰å…è¨± "resumeCombat"
        if (GameState.currentEnemy && GameState.phase === 'combat') {
            this.setButtons("é‡æ•´æ…‹å‹¢ (ç¹¼çºŒ)", "resumeCombat", "ç„¡", null, true);
        } else {
            // å¦‚æœæ˜¯é™·é˜±æ­»äº¡ (phase ç‚º event_end)ï¼Œå‰‡é¡¯ç¤ºå€–å­˜ä¸¦å‰å¾€ä¸‹ä¸€å€‹äº‹ä»¶
            this.setButtons("å€–å­˜ (ç¹¼çºŒ)", "nextEvent", "ç„¡", null, true);
        }
        
        this.updateUI();
        return;
    }

// --- [FIX] è‰è‰çµ²ç»ç¥­äº‹ä»¶ ---
        // æ¢ä»¶ï¼šæ‰“ç¥ + è‰è‰çµ²åœ¨å ´ + è‰è‰çµ²é‚„æ²’çŠ§ç‰²
        if (GameState.currentEnemy && GameState.currentEnemy.isGod && Player.lilithBlessing && !Player.lilithSacrificed) {
            
            // 1. æ¨™è¨˜çŠ§ç‰² (æ°¸ä¹…é˜²æ­¢å†æ¬¡è§¸ç™¼)
            Player.lilithSacrificed = true;
            
            // 2. ç§»é™¤ç¥ç¦ç‹€æ…‹ (è®“è‰è‰çµ²åœ¨ UI ä¸Šæ¶ˆå¤±ï¼Œä½†å¥¹çš„æ•¸å€¼åŠ æˆæœƒä¿ç•™åˆ°ä¸‹ä¸€è¼ª recalc)
            Player.lilithBlessing = false; 

            // 3. æ•¸å€¼è®Šæ›´
            Player.lastInspirationTurns = 3; 
            // Player.maxHp += 6666; // é€™è£¡ä¸éœ€è¦åŠ ï¼Œå› ç‚ºæœƒåœ¨ recalcStats() ä¸­è™•ç† (å¦‚æœæ²’æœ‰å…¶ä»–é…ä»¶ï¼ŒMaxHPæœƒä¸‹é™)
            Player.hp = Player.maxHp;        
            
            // 4. å‰Šå¼±ç¥
            const dmgToGod = Math.floor(GameState.currentEnemy.hp * 0.5);
            GameState.currentEnemy.hp -= dmgToGod;
            // 5. è¦†è“‹ä¸ƒå®—ç½ª DEBUFF (å¦‚æœæœ‰çš„è©±)
            if (Player.debuff) {
                Player.debuff = null;
                this.showFloatingText("è©›å’’æ·¨åŒ–", "#fff");
            }
            
            // é‡æ–°è¨ˆç®— stats ä»¥å¥—ç”¨ MaxHP +6666
            this.recalcStats();

            // 6. æ¼”å‡º
            this.renderEvent("ğŸ’” èµ·æºé­”æ³•", 
                "å°±åœ¨è‡´å‘½ä¸€æ“Šå³å°‡è½ä¸‹æ™‚ï¼Œè‰è‰çµ²æ“‹åœ¨äº†ä½ èº«å‰ã€‚", 
                `ã€Œæ´»ä¸‹å»...ç¬¨è›‹...ã€<br>å¥¹åŒ–ç‚ºäº†ç„¡æ•¸å…‰é»æ¶ˆæ•£äº†ã€‚<br><br>
                <span style='color:#ff69b4'>ç²å¾—ã€æœ€å¾Œçš„é¼“èˆã€‘ (3å›åˆç„¡è¦–ç¥ä¹‹åŠ›ï¼ŒHP+6666ï¼Œå…¨å›å¾©)<br>
                ç¥ä¹‹ä»£è¡Œè€…å—åˆ°é‡å‰µ (HP -50%)</span>`, 
                "âœ¨");
            
            // [NEW] æª¢æŸ¥çœŸèª æˆå°±
            this.checkAchievements();
            
            this.setButtons("å¸¶è‘—å¥¹çš„ä»½æˆ°é¬¥ (ç¹¼çºŒ)", "resumeCombat", "ç„¡", null, true);
            this.updateUI();
            return;
        }

        this.playerDie(reason);
    },


resumeCombat() {
        const enemy = GameState.currentEnemy;
        if (!enemy) {
            this.nextEvent();
            return;
        }

        GameState.phase = "combat";
        
        // 1. é‚„åŸæ€ªç‰©è¦–è¦ºç‰¹æ•ˆ
        let iconClass = "monster-icon";
        if (Player.inInferno) iconClass += " glow-inferno";
        if (enemy.tier === 'elite') iconClass += " monster-elite glow-blue";
        if (enemy.tier === 'boss') iconClass += " monster-boss glow-red";
        if (enemy.isTrueForm) iconClass = "monster-icon monster-true-form glow-purple";
        
        // ç¥ä¹‹ä»£è¡Œè€…ç‰¹æ•ˆ
        if (enemy.isGod) iconClass = "monster-icon glow-void";

        document.getElementById('event-icon').className = iconClass;

        // 2. é¡¯ç¤ºæˆ°é¬¥è³‡è¨Š
        this.renderEvent(`âš”ï¸ ${enemy.name}`, 
            `HP: ${enemy.hp} | æ”»æ“Š: ${enemy.atk}`, 
            "ä½ é‡æ–°æ¡ç·Šäº†æ­¦å™¨ï¼Œæˆ°é¬¥ç¹¼çºŒï¼", enemy.icon);

        const iconEl = document.getElementById('event-icon');
        iconEl.onclick = () => Game.inspectEnemy();
        iconEl.style.cursor = "help";

        // --- [FIX] 3. ä¿®æ­£å¾©æ´»å¾Œçš„é€ƒè·‘é‚è¼¯ (åŠ å…¥ä¾‹å¤–åå–®) ---
        const escapableBosses = ['é®®è¡€ä¼¯çˆµ', 'å·«å¦–ç‹', 'æ·±æ·µé­”é¾'];
        const isEscapable = escapableBosses.some(name => enemy.name.includes(name));

        // åˆ¤æ–·æ˜¯å¦å¯ä»¥é€ƒè·‘ï¼š
        // ä¸æ˜¯ä¸ƒå®—ç½ª AND ä¸æ˜¯èˆŠæ—¥æ”¯é…è€… AND ä¸æ˜¯ç¥ AND (ä¸æ˜¯BOSS OR æ˜¯ä¾‹å¤–åå–®) AND ä¸æ˜¯èŠ±åœ’å‹‡è€…
        const canFlee = !enemy.isSin && 
                        !enemy.isOldOne && 
                        !enemy.isGod && 
                        (enemy.tier !== 'boss' || isEscapable) || 
                        enemy.isGardenBoss; // èŠ±åœ’å‹‡è€…ç¸½æ˜¯å¯é€ƒè·‘

        // setButtons ç¬¬äº”å€‹åƒæ•¸æ˜¯ disableSub (æ˜¯å¦ç¦ç”¨å‰¯æŒ‰éˆ•)ï¼Œæ‰€ä»¥è¦ç”¨ !canFlee
        this.setButtons("æˆ°é¬¥", "combatRound", "é€ƒè·‘", "flee", !canFlee);
        // ----------------------------------------------------

        // 4. è™•ç†æ‡¶æƒ°è©›å’’
        if (Player.debuff && Player.debuff.id === 'sloth_curse') {
            const btnMain = document.getElementById('btn-main');
            const btnSub = document.getElementById('btn-sub');
            btnMain.disabled = true;
            btnMain.innerText = "ğŸ’¤ æ‡¶æƒ° (ç„¡æ³•æ”»æ“Š)";
            btnMain.style.opacity = "0.6";
            btnMain.style.cursor = "not-allowed";
            // æ‡¶æƒ°æ™‚é€ƒè·‘æŒ‰éˆ•ä¸€å®šé–‹å•Ÿ (é™¤éè©²æ€ªç‰©æœ¬èº«å¼·åˆ¶ä¸èƒ½é€ƒï¼Œé‚£ä¸Šé¢ setButtons æœƒè™•ç†)
            btnSub.disabled = !canFlee; 
            btnSub.innerText = "é€ƒè·‘";
        }

        this.updateUI();
    },
    playerDie(reason) {  // <--- è£œå›é€™å€‹å‡½æ•¸æ¨™é ­
        GameState.phase = "dead";
        Player.hp = 0;
        this.updateUI();
        localStorage.removeItem('fantasy_adventure_save_v2');
        let cause = reason ? reason : "æœªçŸ¥åŸå› ";
        this.renderEvent("â˜ ï¸ ä½ æ­»äº†", `æ­»å› ï¼š${cause}<br>å†’éšªçµæŸã€‚æœ€çµ‚æ·±åº¦: ${Player.depth}`, "é‡æ–°æ•´ç†ç¶²é ä»¥é‡æ–°é–‹å§‹", "ğŸª¦");
        this.setButtons("é‡æ–°å†’éšª", "restart", "ç„¡", null, true);
    },
    restart() { location.reload(); },

    getWeightedMonster() {
        let activeMonsters = [];
        if (Player.depth < 50) {
            let weakWeight = 99 / 4; 
            let strongWeight = 1 / 6; 
            CONFIG.monsters.forEach((m, idx) => {
                let tempM = {...m};
                tempM.weight = (idx < 4) ? weakWeight : strongWeight;
                activeMonsters.push(tempM);
            });
        } else {
            activeMonsters = CONFIG.monsters;
        }
        let totalWeight = 0;
        for (let m of activeMonsters) totalWeight += m.weight;
        let randomVal = Math.random() * totalWeight;
        for (let m of activeMonsters) {
            if (randomVal < m.weight) return m;
            randomVal -= m.weight;
        }
        return activeMonsters[0];
    },
    generateRandomItem(tierModifier = "normal") {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        if (tierModifier === "boss" && (rarityKey === "common" || rarityKey === "uncommon")) rarityKey = "rare";
        const pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey);
        if (pool.length === 0) return this.generateRandomItem("normal");
        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },
    generateSpecificItem(allowedTypes) {
        const r = Math.random();
        let rarityKey = "common";
        let table = CONFIG.rarityProb;
        let acc = 0;
        for (let key in table) {
            acc += table[key];
            if (r <= acc) { rarityKey = key; break; }
        }
        let pool = CONFIG.itemPool.filter(i => i.rarity === rarityKey && allowedTypes.includes(i.type));
        if (pool.length === 0) pool = CONFIG.itemPool.filter(i => allowedTypes.includes(i.type));
        const template = pool[Math.floor(Math.random() * pool.length)];
        return Object.assign({}, template);
    },
    addItemToInventory(item, render = true) {
        // [FIX] åªæœ‰åœ¨ history.items ä¸­ä¸å­˜åœ¨æ™‚æ‰æ·»åŠ 
        if (!Player.history.items.has(item.name)) {
            Player.history.items.add(item.name);
            // ä¸éœ€è¦åœ¨é€™è£¡æª¢æŸ¥æ‰€æœ‰æˆå°±ï¼Œäº¤çµ¦ checkAchievements() çµ±ä¸€è™•ç†
        }
        
        if (['weapon', 'armor', 'shield'].includes(item.type)) {
            Player.inventory.equipment.push(item);
        } else if (item.type === 'consumable') {
            Player.inventory.consumable.push(item);
        } else if (item.type === 'accessory') {
            Player.inventory.accessory.push(item);
        } else {
            Player.inventory.material.push(item);
        }
        if (render) this.updateUI();
    },
   handleItemClick(index, category) {
        // 1. å•†äººæª¢æŸ¥
        if (GameState.phase === "merchant" || GameState.phase === "demon_merchant") {
            this.sellItem(index, category);
            return;
        }

        const item = Player.inventory[category][index];
        const type = item.type;

        // --- [FIX] 2. ç‹€æ…‹æª¢æŸ¥ï¼šä¿®æ­£é–å®šé‚è¼¯ ---
        
        // A. æˆ°é¬¥ä¸­ï¼šåªæœ‰å°ä»˜ã€Œå‚²æ…¢é¡åƒã€æ‰ç¦æ­¢æ›è£
        if (GameState.phase === "combat") {
            const isPrideFight = GameState.currentEnemy && GameState.currentEnemy.sinType === 'pride';
            
            if (isPrideFight) {
                // å‚²æ…¢æˆ°ï¼šç¦æ­¢æ›´æ›ä¸»è¦è£å‚™ (é˜²æ­¢ä½œå¼Šç©¿å›é˜²å…·ï¼Œæˆ–æ‰‹æ®˜æ›æ‰æ­¦å™¨)
                if (['weapon', 'armor', 'shield'].includes(type)) {
                    alert("åœ¨å‚²æ…¢çš„æ±ºé¬¥ä¸­ï¼Œä½ ç„¡æ³•æ›´æ›ä¸»è¦è£å‚™ï¼");
                    return;
                }
                // é£¾å“å…è¨±é€šé
            } 
            // [FIX] ä¸€èˆ¬æˆ°é¬¥ä¸å†é–å®šï¼Œæ¢å¾©è‡ªç”±æ›è£
        }

        // B. äº‹ä»¶ä¸­ï¼šåªæœ‰ã€Œå‚²æ…¢ä¹‹é–€ã€æ‰é–å®š
        if (GameState.phase === "sin_event") {
            // æª¢æŸ¥æ˜¯å¦ç‚ºå‚²æ…¢ (pride)
            if (GameState.currentSinType === 'pride') {
                if (['weapon', 'armor', 'shield'].includes(type)) {
                    alert("åœ¨å‚²æ…¢ä¹‹é–€é¢å‰ï¼Œä½ ç„¡æ³•éš±è—(æ›´æ›)ä½ çš„ä¸»è¦è£å‚™ï¼\n(ä½†å¯ä»¥èª¿æ•´é£¾å“)");
                    return;
                }
            }
        }
        // ----------------------------------------

        // 3. ç‰©å“ä½¿ç”¨é‚è¼¯
        if (['weapon', 'armor', 'shield'].includes(type)) {
            if(confirm(`è¦è£å‚™ ${item.name} (${this.getItemDesc(item)}) å—ï¼Ÿ`)) this.equip(index, category);
        } else if (type === 'accessory') {
             this.promptEquipAccessory(index);
        } else if (type === 'consumable') {
            if(confirm(`è¦ä½¿ç”¨ ${item.name} (${item.desc}) å—ï¼Ÿ`)) this.useItem(index, category);
        } else {
             alert(`${item.icon} ${item.name}: ${item.desc || "ç´ æ/æˆ°åˆ©å“"}`);
        }
    },
    equip(index, category) {
        const item = Player.inventory[category][index];
        
        // --- [æ–°å¢] ç¨»è‰äººè£å‚™é™åˆ¶ ---
        if (Player.class === 'scarecrow') {
            if (item.name === "é¨å£«ç›¾" || item.name === "å¡”ç›¾") {
                alert("ç¨»è‰äººçš„æ‰‹è‡‚å¤ªç´°äº†ï¼Œæ‹¿ä¸å‹•é€™éº¼é‡çš„ç›¾ç‰Œï¼\n(ç¨»è‰äººç„¡æ³•è£å‚™ é¨å£«ç›¾ èˆ‡ å¡”ç›¾)");
                return; // ç›´æ¥ä¸­æ–·ï¼Œä¸åŸ·è¡Œå¾ŒçºŒè£å‚™å‹•ä½œ
            }
        }
        // ---------------------------

        const type = item.type;
        if (!['weapon', 'armor', 'shield'].includes(type)) return;
        if (Player.equipment[type]) this.addItemToInventory(Player.equipment[type], false);
        Player.equipment[type] = item;
        Player.inventory[category].splice(index, 1);
        this.recalcStats();
        this.updateUI();    
        this.log(`è£å‚™äº† ${item.name}`);
    },
    promptEquipAccessory(index) {
        const item = Player.inventory.accessory[index];
        let desc = this.getItemDesc(item);
        
        // [FIX] å°‡ desc åŠ å…¥æç¤ºæ–‡å­—ä¸­
        let slot = prompt(`ã€${item.name}ã€‘\n${desc}\n\nè¦è£å‚™åˆ°å“ªå€‹æ¬„ä½ï¼Ÿ(è¼¸å…¥ 1, 2 æˆ– 3)`, "1");
        
        if (slot === "1" || slot === "2" || slot === "3") {
            let slotIdx = parseInt(slot) - 1;
            if (Player.equipment.accessories[slotIdx]) {
                this.addItemToInventory(Player.equipment.accessories[slotIdx], false);
            }
            Player.equipment.accessories[slotIdx] = item;
            Player.inventory.accessory.splice(index, 1);
            this.recalcStats();
            this.updateUI();
        }
    },
   unequip(type) {
        // [FIX] 1. å‚²æ…¢ä¹‹é–€äº‹ä»¶é–å®š (åƒ…é™ Pride)
        if (GameState.phase === "sin_event" && GameState.currentSinType === 'pride') {
            alert("åœ¨å‚²æ…¢ä¹‹é–€é¢å‰ï¼Œä½ ç„¡æ³•å¸ä¸‹ä¸»è¦è£å‚™ï¼");
            return;
        }

        // [FIX] 2. å‚²æ…¢æˆ°é¬¥é–å®š (é˜²æ­¢æ‰‹æ®˜è„«æ­¦)
        if (GameState.phase === "combat") {
            const isPrideFight = GameState.currentEnemy && GameState.currentEnemy.sinType === 'pride';
            if (isPrideFight && type !== 'accessory') { // æ­¦å™¨/é˜²å…·/ç›¾ç‰Œéƒ½é–
                alert("åœ¨èˆ‡é¡åƒæ±ºé¬¥æ™‚ï¼Œçµ•ä¸èƒ½æ”¾ä¸‹æ­¦å™¨æˆ–ç©¿ä¸Šé˜²å…·ï¼");
                return;
            }
        }

        if (!Player.equipment[type]) return;
        const item = Player.equipment[type];
        this.addItemToInventory(item, false); 
        Player.equipment[type] = null;
        this.recalcStats();
        this.updateUI();
    },

        unequipAccessory(slotIdx) {
        if (!Player.equipment.accessories[slotIdx]) return;
        const item = Player.equipment.accessories[slotIdx];
        this.addItemToInventory(item, false);
        Player.equipment.accessories[slotIdx] = null;
        this.recalcStats();
        this.updateUI();
    },
    useItem(index, category) {
        if (Player.hp <= 0) return;
        const item = Player.inventory[category][index];

        // [æ–°å¢] è¼ªè¿´æ²™æ¼é‚è¼¯ (æ”¾åœ¨é€™è£¡æ‰å°)
        if (item.name === "è¼ªè¿´æ²™æ¼") {
            this.openRebirthMenu(); 
            return;
        }
// [æ–°å¢] æ”œå¸¶å¼å·¥ä½œæª¯é‚è¼¯
        if (item.name === "æ”œå¸¶å¼å·¥ä½œæª¯") {
            if(confirm("è¦ä½¿ç”¨æ”œå¸¶å¼å·¥ä½œæª¯å—ï¼Ÿ(ä½¿ç”¨å¾Œæ¶ˆå¤±)")) {
                // 1. æ¶ˆè€—ç‰©å“
                Player.inventory[category].splice(index, 1);
                
                // 2. æ›´æ–°èƒŒåŒ… UI (è®“ç‰©å“æ¶ˆå¤±)
                this.updateUI();
                
                // 3. é–‹å•ŸåŠŸèƒ½
                this.openPortableCrafting();
                this.showFloatingText("å·¥ä½œæª¯å±•é–‹", "#eee");
            }
            return;
        }
// [æ–°å¢] ç…‰ç„çˆå·è»¸é‚è¼¯
        if (item.name === "ç…‰ç„çˆå·è»¸") {
            if(confirm("è¦æ¶ˆè€—å·è»¸å¬å–šç…‰ç„çˆç«å—ï¼Ÿ")) {
                Player.inventory[category].splice(index, 1); // æ¶ˆè€—
                this.updateUI();
                this.openPortableCrafting('inferno'); // é–‹å•Ÿç…‰ç„æ¨¡å¼
                this.showFloatingText("ç…‰ç„çˆç«é¡¯ç¾", "#ff3300");
            }
            return;
        }
        // è¡€ä¹‹å¥‘ç´„é™åˆ¶
        if (Player.equipment.accessories.some(a => a && a.id === 'acc_blood')) {
             if (item.name.includes("è—¥æ°´") || item.name.includes("è—¥åŠ‘") || item.name.includes("è¡€")) {
                 alert("ã€è¡€ä¹‹å¥‘ç´„ã€‘ç¦æ­¢ä½¿ç”¨æ²»ç™‚ç‰©å“ï¼ä½ åªèƒ½é å¸è¡€ç¶­ç”Ÿã€‚");
                 return;
             }
        }

        // ä¸€èˆ¬æ¶ˆè€—å“é‚è¼¯
        if (item.name.includes("è—¥æ°´") || item.name.includes("è—¥åŠ‘") || item.name.includes("å“ˆæ¯”è¡€")) {
            let heal = item.val;
            Player.hp = Math.min(Player.maxHp, Player.hp + heal);
            Player.inventory[category].splice(index, 1);
            this.showFloatingText(`+${heal} HP`, "#69f0ae");
            this.updateUI();
        }
        else if (item.name.includes("æ·¨åŒ–è¡€")) {
            Player.hp = Player.maxHp;
            Player.inventory[category].splice(index, 1);
            this.showFloatingText("HP MAX", "#69f0ae");
            this.updateUI();
        }
    },

    // [æ–°å¢] é–‹å•Ÿè¼ªè¿´é¸å–® (å¿…é ˆæ”¾åœ¨ useItem å¤–é¢)
    openRebirthMenu() {
        let allAccessories = [];
        // 1. èƒŒåŒ…è£¡çš„
        Player.inventory.accessory.forEach(acc => allAccessories.push(acc));
        // 2. èº«ä¸Šè£å‚™çš„
        Player.equipment.accessories.forEach(acc => {
            if (acc) allAccessories.push(acc);
        });

        if (allAccessories.length === 0) {
            if(confirm("ä½ èº«ä¸Šæ²’æœ‰ä»»ä½•é£¾å“å¯ç¹¼æ‰¿ã€‚\nç¢ºå®šè¦ç›´æ¥é‡ç½®éŠæˆ²å—ï¼Ÿ(ä¸€åˆ‡å°‡æ­¸é›¶)")) {
                this.executeRebirth(null);
            }
            return;
        }

        const modal = document.getElementById('rebirth-modal');
        const list = document.getElementById('rebirth-list');
        list.innerHTML = "";

        // æ’åº
        allAccessories.sort((a, b) => {
            const valA = CONFIG.rarityDisplay[a.rarity]?.val || 0;
            const valB = CONFIG.rarityDisplay[b.rarity]?.val || 0;
            return valB - valA;
        });

        // ç”ŸæˆæŒ‰éˆ•
        allAccessories.forEach(item => {
            const div = document.createElement('div');
            let colorClass = CONFIG.rarityDisplay[item.rarity]?.color || 'rarity-common';
            
            div.className = `merchant-item ${colorClass}`;
            if(item.rarity === 'mythic') div.className += ' rarity-mythic';
            if(item.rarity === 'ultra') div.className += ' rarity-ultra';
            
            div.style.cssText = "cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; padding:10px; font-size:0.8em;";
            div.innerHTML = `
                <div style="font-size:2em; margin-bottom:5px;">${item.icon}</div>
                <div>${item.name}</div>
            `;
            
            div.onclick = () => {
                if(confirm(`ç¢ºå®šè¦ç¹¼æ‰¿ã€${item.name}ã€‘ä¸¦é–‹å§‹æ–°è¼ªè¿´å—ï¼Ÿ\n(å…¶ä»–æ‰€æœ‰ç‰©å“å°‡æœƒæ¶ˆå¤±)`)) {
                    this.executeRebirth(item);
                }
            };
            list.appendChild(div);
        });

        modal.style.display = 'flex';
    },

    // [æ–°å¢] åŸ·è¡Œè¼ªè¿´é‡ç½®
    executeRebirth(inheritedItem) {
        document.getElementById('rebirth-modal').style.display = 'none';

        // 1. é‡ç½®ç©å®¶æ•¸å€¼
        Player.hp = 100;
        Player.maxHp = 100;
        Player.baseMaxHp = 100;
        Player.baseAtk = 5;
        Player.gold = 100;
        Player.depth = 0;
        Player.class = null;
        
        // é‡ç½® flag
        Player.permanentCritBonus = 0;
        Player.lilithBlessing = false;
        Player.lilithSacrificed = false;
        Player.lastInspirationTurns = 0;
        Player.fairyEnhanceCount = 0;
        Player.elderEnhanceCount = 0;
        Player.permanentHpBonus = 0;
        Player.inInferno = false;
        Player.kill1000Boss = false;
        Player.souls = 0;
        Player.ghostTurns = 0;
        Player.bloodContractAtk = 0;
        Player.chaosRoll = 1;
        
        Player.sinState = { slothCount: 0, wrathRevive: 0, lustActive: false, greedActive: false };
        Player.buff = null;
        Player.debuff = null;
        Player.succubusStage = 0;

        // 2. æ¸…ç©ºèƒŒåŒ…èˆ‡è£å‚™
        Player.inventory = { 
            equipment: [], 
            consumable: [
                { name: "æ²»ç™‚è—¥æ°´", type: "consumable", val: 30, rarity: "common", price: 25, icon: "ğŸ§ª", desc: "æ¢å¾©30é»ç”Ÿå‘½" }
            ], 
            material: [],
            accessory: [] 
        };
        Player.equipment = { weapon: null, armor: null, shield: null, accessories: [null, null, null] };

        // 3. ç¹¼æ‰¿ç‰©å“
        if (inheritedItem) {
            const savedItem = JSON.parse(JSON.stringify(inheritedItem));
            this.addItemToInventory(savedItem, false);
        }
        
        // [NEW] æ¨™è¨˜ï¼šç©¿è¶Šéå» (è¼ªè¿´æˆå°±)
        Player.history.items.add("è¼ªè¿´å¾Œçš„è¨˜æ†¶"); 
        this.checkAchievements();

        // 4. é‡ç½®éŠæˆ²ç‹€æ…‹
        GameState.phase = "select_class";
        GameState.forgeUsed = false;
        GameState.merchantRefreshed = false;
        GameState.combatTurn = 0;
        GameState.enemyDominated = false;
        GameState.currentEnemy = null;
        GameState.craftingCount = 0;
        GameState.merchantStock = [];

        // 5. è¦–è¦ºé‚„åŸ
        document.body.classList.remove('inferno-mode');
        document.body.style.boxShadow = "";
        document.getElementById('merchant-area').classList.add('hidden');
        document.getElementById('crafting-area').classList.add('hidden');
        document.getElementById('class-badge').innerText = "";
        
        // 6. å•Ÿå‹•æ–°éŠæˆ²æµç¨‹
        this.updateUI();
        this.saveGame();
        
        document.getElementById('class-modal').style.display = 'flex';
        this.renderEvent("â³ è¼ªè¿´é–‹å§‹", "ä½ å¸¶è‘—æ¨¡ç³Šçš„è¨˜æ†¶å›åˆ°äº†èµ·é»...", inheritedItem ? `ä½ ç·Šæ¡è‘—æ‰‹ä¸­çš„ <span class="${CONFIG.rarityDisplay[inheritedItem.rarity].color}">${inheritedItem.name}</span>ã€‚` : "é€™æ¬¡ï¼Œä½ ä¸€ç„¡æ‰€æœ‰ã€‚", "âœ¨");

        this.setButtons("è«‹é¸æ“‡è·æ¥­", "showClassModal", "ç„¡", null, true);
        
        const floaters = document.querySelectorAll('.floating-text');
        floaters.forEach(el => el.remove());
        
        alert("â³ è¼ªè¿´é–‹å§‹ï¼\n\nä¸€åˆ‡å·²é‡ç½®ï¼Œè«‹é‡æ–°é¸æ“‡è·æ¥­ã€‚");
    },

getEnemySkillDesc(name) {
        if (name.includes("æš—å½±å²èŠå§†")) return "ã€æµé«”é–ƒé¿ã€‘\nå—åˆ°æ”»æ“Šæ™‚ 15% æ©Ÿç‡å®Œå…¨é–ƒé¿ï¼Œä¸¦å°æ”»æ“Šè€…é€ æˆå°‘é‡åå‚·ã€‚";
        if (name.includes("è™›ç©ºé­”çœ¼")) return "ã€è¦–ç·šæŠ˜å°„ã€‘\næ°¸ä¹…åå°„ 10% å—åˆ°å‚·å®³å›æ”»æ“Šè€…èº«ä¸Šã€‚";
        if (name.includes("ç†”å²©é­”åƒ")) return "ã€éç†±å…‰ç’°ã€‘\næ¯å›åˆçµæŸæ™‚ï¼Œç‡ƒç‡’é›™æ–¹ 5% æœ€å¤§ç”Ÿå‘½å€¼ã€‚";
        if (name.includes("å¤¢é­˜æˆ°é¦¬")) return "ã€ææ‡¼è¡é‹’ã€‘\næˆ°é¬¥çš„ç¬¬ 1 å›åˆï¼Œæ”»æ“ŠåŠ›æå‡ 100%ã€‚";
        if (name.includes("å¢®è½é¨å£«")) return "ã€äº¡è€…æ„å¿—ã€‘\nå—åˆ°è‡´æ­»å‚·å®³æ™‚ä¸æœƒæ­»äº¡ï¼Œè€Œæ˜¯é–è¡€ 1 å›åˆä¸¦å¤§å¹…æå‡æ”»æ“ŠåŠ›ã€‚";
        if (name.includes("æ··æ²Œè§¸æ‰‹")) return "ã€æ€ç¶­æ±¡æŸ“ã€‘\næ”»æ“Šæ™‚æœ‰ 15% æ©Ÿç‡é€ æˆã€Œæ··äº‚ã€ï¼Œä½¿ä½ ä¸‹å›åˆç„¡æ³•è¡Œå‹•ã€‚";
        if (name.includes("é®®è¡€ä¼¯çˆµ")) return "ã€ç”Ÿå‘½æ±²å–ã€‘\næ¯æ¬¡æ”»æ“Šé€ æˆçš„å‚·å®³ï¼Œæœƒè½‰åŒ–ç‚ºè‡ªèº« 50% çš„æ²»ç™‚é‡ã€‚";
        if (name.includes("å·«å¦–ç‹")) return "ã€å‘½åŒ£è­·ç›¾ã€‘\næ¯ 3 å›åˆç²å¾—ä¸€æ¬¡ç„¡æ•µè­·ç›¾ï¼Œå…ç–«è©²æ¬¡å‚·å®³ã€‚";
        if (name.includes("æ·±æ·µé­”é¾")) return "ã€é€†é±—ä¹‹æ€’ã€‘\nå—åˆ°ã€Œæš´æ“Šã€å‚·å®³æ™‚ï¼Œæœƒè¢«æ¿€æ€’ä¸¦ç«‹å³åæ“Šï¼ˆé€ æˆé¡å¤–å‚·å®³ï¼‰ã€‚";
        if (name.includes("èˆŠæ—¥æ”¯é…è€…")) return "ã€ä¸å¯åç‹€çš„ä½èªã€‘\néš¨è‘—å›åˆæ•¸å¢åŠ ï¼Œå°ç©å®¶å †ç–Šè¶Šä¾†è¶Šé«˜çš„çœŸå¯¦å‚·å®³ï¼ˆç²¾ç¥å´©å£ï¼‰ã€‚";
        
        // ç‰¹æ®Š BOSS
        if (name.includes("ç¥ä¹‹ä»£è¡Œè€…")) return "ã€ç¥ä¹‹æ¬Šèƒ½ã€‘\n1. å¨å£“ï¼šå°å°ç©å®¶æš´æ“Š (é™¤éæœ‰é¼“èˆ)\n2. è–æ½”åŠ›å ´ï¼šå–®æ¬¡å—å‚·ä¸Šé™ 111,111\n3. å¯©åˆ¤ä¹‹çœ¼ï¼šæ¯ 3 å›åˆå¼·åˆ¶å°‡ç©å®¶ HP æ­¸ 1\n4. è¦å‰‡ç ´å£ï¼šæ©Ÿç‡ç²‰ç¢ç›¾ç‰Œæˆ–ç‡’æ¯€å¾©æ´»ç¾½æ¯›";
        if (name.includes("å‚²æ…¢é¡åƒ")) return "ã€é¡åƒè¤‡è£½ã€‘\næ“æœ‰èˆ‡ä½ ç›¸ä¼¼çš„å±¬æ€§ï¼Œå¿…é ˆå¸ä¸‹é˜²å‚™æ‰èƒ½æˆ°å‹ã€‚";
        
        return "ç„¡ç‰¹æ®Šèƒ½åŠ› (æˆ–èƒ½åŠ›æœªçŸ¥)";
    },

    // --- [æ–°å¢] æŸ¥çœ‹æ€ªç‰©åŠŸèƒ½ ---
    inspectEnemy() {
        const enemy = GameState.currentEnemy;
        if (!enemy || GameState.phase !== 'combat') return;

        let desc = `ã€${enemy.name}ã€‘\n`;
        desc += `----------------\n`;
        desc += `â¤ï¸ ç”Ÿå‘½: ${Math.max(0, enemy.hp)} / ${enemy.maxHp}\n`;
        desc += `âš”ï¸ æ”»æ“Š: ${enemy.atk}\n`;
        desc += `----------------\n`;
        desc += `[ç‰¹æ®Šèƒ½åŠ›]\n${this.getEnemySkillDesc(enemy.name)}`;

        // æç¤ºç©å®¶é»æ“Šé—œé–‰
        alert(desc);
    },

    log(msg) { console.log(msg); },
    renderEvent(title, subtitle, content, icon) {
        document.getElementById('event-title').innerText = title;
        document.getElementById('event-desc').innerHTML = `<p>${subtitle}</p><p>${content}</p>`;
        
        const iconEl = document.getElementById('event-icon');
        if(icon) iconEl.innerText = icon;
        
        // --- [ä¿®æ­£ç‰ˆé‚è¼¯] ---
        // 1. å…ˆé‡ç½®ç‚ºé è¨­ç‹€æ…‹
        iconEl.onclick = null;
        iconEl.style.cursor = "default";

        // 2. å¦‚æœç•¶å‰æ˜¯ã€Œæˆ°é¬¥éšæ®µã€ï¼Œè‡ªå‹•ç¶å®šæŸ¥çœ‹åŠŸèƒ½
        // é€™æ¨£ç„¡è«–æ˜¯ combatRound é‚„æ˜¯ enemyAttackPhase å‘¼å«æ­¤å‡½å¼ï¼ŒåŠŸèƒ½éƒ½ä¸æœƒæ¶ˆå¤±
        if (GameState.phase === 'combat' && GameState.currentEnemy) {
            iconEl.onclick = () => Game.inspectEnemy();
            iconEl.style.cursor = "help";
        }
        // ------------------

        if(GameState.phase !== 'merchant' && GameState.phase !== 'demon_merchant') document.getElementById('merchant-area').classList.add('hidden');
        if(GameState.phase !== 'crafting') document.getElementById('crafting-area').classList.add('hidden');
    },
	setButtons(mainText, mainAction, subText, subAction, disableSub) {
		const b1 = document.getElementById('btn-main');
		const b2 = document.getElementById('btn-sub');

		// å…±ç”¨ä¸€å€‹å°å·¥å…·ï¼šåŒ…ä½çœŸæ­£çš„å‹•ä½œï¼Œé¿å…æ²å‹•
		const wrapAction = (btn, actionName) => {
			if (!Game[actionName]) return null;

			return (ev) => {
				// è¨˜éŒ„é»æ“Šå‰çš„æ²å‹•ä½ç½®
				const x = window.scrollX;
				const y = window.scrollY;

				// é˜»æ­¢ç€è¦½å™¨é è¨­è¡Œç‚ºï¼ˆåŒ…å«éƒ¨åˆ†è‡ªå‹•æ²å‹•é‚è¼¯ï¼‰
				if (ev) ev.preventDefault();

				// å…ˆæŠŠæŒ‰éˆ•çš„ç„¦é»æ‹¿æ‰ï¼Œé¿å…ä¹‹å¾Œå†è§¸ç™¼æ²å‹•
				btn.blur();

				// åŸ·è¡ŒåŸæœ¬çš„éŠæˆ²é‚è¼¯
				Game[actionName]();

				// é‚„åŸåˆ°é»ä¸‹å»ä¹‹å‰çš„ä½ç½®
				window.scrollTo(x, y);
			};
		};

		// ä¸»æŒ‰éˆ•
		b1.innerText = mainText;
		b1.onclick = wrapAction(b1, mainAction);

		// å‰¯æŒ‰éˆ•
		b2.innerText = subText;
		b2.onclick = subAction ? wrapAction(b2, subAction) : null;
		b2.disabled = disableSub;
	},
    updateUI() {
        this.updateStatsUI();
        
        const w = Player.equipment.weapon;
        const a = Player.equipment.armor;
        const s = Player.equipment.shield;
        
        const wEl = document.getElementById('slot-weapon');
        wEl.innerHTML = w ? `<span class="${CONFIG.rarityDisplay[w.rarity].color}">${w.icon} ${w.name} (+${w.val})</span>` : "ç„¡æ­¦å™¨";
        wEl.className = `equip-slot ${w ? CONFIG.rarityDisplay[w.rarity].color : ''}`;

        const aEl = document.getElementById('slot-armor');
        aEl.innerHTML = a ? `<span class="${CONFIG.rarityDisplay[a.rarity].color}">${a.icon} ${a.name} (+${a.val})</span>` : "ç„¡é˜²å…·";
        aEl.className = `equip-slot ${a ? CONFIG.rarityDisplay[a.rarity].color : ''}`;
        
        const sEl = document.getElementById('slot-shield');
        sEl.innerHTML = s ? `<span class="${CONFIG.rarityDisplay[s.rarity].color}">${s.icon} ${s.name} (${s.val})</span>` : "ç„¡ç›¾ç‰Œ";
        sEl.className = `equip-slot ${s ? CONFIG.rarityDisplay[s.rarity].color : ''}`;

        for(let i=0; i<3; i++) {
            const acc = Player.equipment.accessories[i];
            const el = document.getElementById(`slot-acc${i+1}`);
            el.innerHTML = acc ? `<span class="${CONFIG.rarityDisplay[acc.rarity].color}">${acc.icon} ${acc.name}</span>` : `é£¾å“æ¬„ ${i+1}`;
            el.className = `equip-slot ${acc ? CONFIG.rarityDisplay[acc.rarity].color : ''}`;
        }

        this.renderInvList('inv-equip', Player.inventory.equipment, 'equipment');
        this.renderInvList('inv-acc', Player.inventory.accessory, 'accessory');
        this.renderInvList('inv-consum', Player.inventory.consumable, 'consumable');
        this.renderInvList('inv-mat', Player.inventory.material, 'material');

		// [NEW] åŒæ­¥è‡ªå‹•ç•¥éè–åƒçš„ checkbox
        const chk = document.getElementById('opt-auto-skip-statue');
        if (chk) chk.checked = !!Player.autoSkipStatue;


        if (!GameState.isLoading && Player.hp > 0 && Player.class) {
            this.saveGame();
        }
    },
    updateStatsUI() {
        // [FIX] æŠŠé€™äº›æ›´æ–°æ•¸å€¼çš„ç¨‹å¼ç¢¼è£œå›ä¾†
        document.getElementById('hp-val').innerText = Player.hp;
        document.getElementById('max-hp-val').innerText = Player.maxHp;
        document.getElementById('atk-val').innerText = this.getAtk();
        document.getElementById('crit-val').innerText = this.getCritRate();
        document.getElementById('gold-val').innerText = Player.gold;
        document.getElementById('depth-val').innerText = Player.depth;
        
        // --- ä¸‹é¢æ˜¯åŸæœ¬çš„ç‹€æ…‹é¡¯ç¤ºé‚è¼¯ (ä¿æŒä¸è®Š) ---
        const buffEl = document.getElementById('buff-display');
		const buffTextEl = document.getElementById('buff-text');
        let statusHtml = "ç‹€æ…‹: ";
        let hasStatus = false;

        // 1. ä¸€èˆ¬ Buff
        if (Player.buff) {
            const style = Player.buff.type === 'angel' ? 'angel-text' : 'demon-text';
            statusHtml += `<span class="${style}" title="${Player.buff.desc}">[${Player.buff.name}]</span> `;
            hasStatus = true;
        }

        // 2. ä¸€èˆ¬ Debuff
        if (Player.debuff) {
            let tooltip = Player.debuff.desc;
            let displayName = Player.debuff.name;
            if (Player.debuff.id === 'sloth_curse') {
                let count = Player.sinState.slothCount;
                tooltip = `å…¨èº«ç„¡åŠ›ï¼Œç„¡æ³•æ”»æ“Šï¼Œåªèƒ½é€ƒè·‘ (å‰©é¤˜ ${count} å ´)`;
                displayName = `ğŸ’¤ æ‡¶æƒ° (${count})`; 
            }
            statusHtml += `<span class="damage-text" title="${tooltip}">[${displayName}]</span> `;
            hasStatus = true;
        }

        // 3. è‰è‰çµ²çš„ç¥ç¦ (å³ä½¿çŠ§ç‰²äº†ä¹Ÿé¡¯ç¤ºï¼Œä¸èˆ‡é¼“èˆè¦†è“‹)
        if (Player.lilithBlessing || Player.lilithSacrificed) {
            let title = Player.lilithSacrificed 
                ? "è‰è‰çµ²çš„ç²¾ç¥èˆ‡ä½ åŒåœ¨... (ç”Ÿå‘½ä¸Šé™+10000)" 
                : "è‰è‰çµ²èˆ‡ä½ ä¸¦è‚©ä½œæˆ°ï¼(ç”Ÿå‘½ä¸Šé™+10000)";
            
            statusHtml += `<span style="color:#ff69b4; font-weight:bold;" title="${title}">[ğŸ’— è‰è‰çµ²çš„ç¥ç¦]</span> `;
            hasStatus = true;
        }

        // 4. æœ€å¾Œçš„é¼“èˆ (å›åˆåˆ¶)
        if (Player.lastInspirationTurns > 0) {
            statusHtml += `<span style="color:#ff00ff; font-weight:bold; text-shadow:0 0 5px #fff;" title="ç„¡è¦–ç¥ä¹‹æ¬Šèƒ½ï¼(å‰©é¤˜ ${Player.lastInspirationTurns} å›åˆ)">[âœ¨ æœ€å¾Œçš„é¼“èˆ(${Player.lastInspirationTurns})]</span> `;
            hasStatus = true;
        }

// --- [æ–°å¢] é¡¯ç¤ºæ°¸ç”Ÿè­·ç¬¦éˆé­‚æ•¸ ---
        const hasPhylactery = Player.equipment.accessories.some(a => a && a.id === 'acc_phylactery');
        if (hasPhylactery) {
            // æ ¹æ“šéˆé­‚æ•¸é‡æ”¹è®Šé¡è‰² (æ»¿50å€‹è®Šäº®ç¶ è‰²ï¼Œå¦å‰‡ç‚ºç°è‰²)
            const soulColor = Player.souls >= 50 ? '#00ffcc' : '#888';
            statusHtml += `<span style="color:${soulColor}; font-weight:bold;" title="æ“Šæ®ºç´¯ç©éˆé­‚ï¼Œæ»¿50å¯å¾©æ´»">[âš±ï¸ éˆé­‚: ${Player.souls}]</span> `;
            hasStatus = true;
        }

        if (!hasStatus) statusHtml += "ç„¡";
        
        if (buffTextEl) buffTextEl.innerHTML = statusHtml;
        
        // é»æ“Šé¡¯ç¤ºè©³ç´°è³‡è¨Š
        buffEl.onclick = () => {
            let msg = "";
            if (Player.buff) msg += `ã€${Player.buff.name}ã€‘\n${Player.buff.desc}\n\n`;
            if (Player.debuff) msg += `ã€${Player.debuff.name}ã€‘\n${Player.debuff.desc}\n\n`;
            
            if (Player.lilithBlessing || Player.lilithSacrificed) {
                msg += `ã€ğŸ’— è‰è‰çµ²çš„ç¥ç¦ã€‘\n${Player.lilithSacrificed ? "é›–ç„¶å¥¹å·²æ¶ˆé€ï¼Œä½†é‚£ä»½å®ˆè­·çš„åŠ›é‡ä»æµæ·Œåœ¨ä½ é«”å…§ã€‚" : "è‰è‰çµ²èˆ‡ä½ åŒåœ¨ã€‚"}\nç”Ÿå‘½åŠ›å¤§å¹…æå‡ (+10000)ã€‚\n\n`;
            }
            
            if (Player.lastInspirationTurns > 0) msg += `ã€âœ¨ æœ€å¾Œçš„é¼“èˆã€‘\nè‰è‰çµ²æœ€å¾Œçš„é­”æ³•ã€‚ç„¡è¦–ç¥ä¹‹ä»£è¡Œè€…çš„æ‰€æœ‰ç‰¹æ®Šèƒ½åŠ›ï¼ŒæŒçºŒ ${Player.lastInspirationTurns} å›åˆã€‚`;
            
            if (msg) alert(msg);
        };
    },

    renderInvList(id, items, category) {
        const list = document.getElementById(id);
        list.innerHTML = "";
        items.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = `item ${CONFIG.rarityDisplay[item.rarity].color}`;
            if (item.rarity === 'epic') div.classList.add('rare-epic');
            if (item.rarity === 'legendary') div.classList.add('rare-legendary');
            if (item.rarity === 'mythic') div.classList.add('rarity-mythic');
            if (item.rarity === 'ultra') div.classList.add('rarity-ultra');
            div.innerHTML = `${item.icon || 'ğŸ“¦'} ${item.name}`;
            div.onclick = () => this.handleItemClick(idx, category);
            list.appendChild(div);
        });
    }, // <--- é€™è£¡ä¸€å®šè¦æœ‰é€—è™Ÿï¼
// [æ–°å¢] é–‹å•Ÿè©³ç´°èƒŒåŒ…è¦–çª— (è‡ªå‹•æ’åº)
    openInventoryModal(category) {
        const modal = document.getElementById('inventory-modal');
        const title = document.getElementById('inv-modal-title');
        const content = document.getElementById('inv-modal-content');
        
        const catName = {
            'equipment': 'ğŸ“¦ è£å‚™',
            'accessory': 'ğŸ’ é£¾å“',
            'consumable': 'ğŸ§ª æ¶ˆè€—å“',
            'material': 'ğŸ§© ç´ æ'
        }[category];

        title.innerText = `${catName} ä¸€è¦½ (ä¾ç¨€æœ‰åº¦æ’åº)`;
        content.innerHTML = "";

        // 1. è¤‡è£½ä¸€ä»½æ¸…å–®ä¸¦æ¨™è¨˜åŸå§‹ç´¢å¼•ï¼Œä»¥å…æ“ä½œéŒ¯èª¤
        let items = Player.inventory[category].map((item, index) => ({
            ...item,
            originalIndex: index 
        }));

        // 2. åŸ·è¡Œæ’åº (ç¥è©± > å‚³èªª > å²è©© > ç¨€æœ‰ > å„ªè³ª > ä¸€èˆ¬)
        items.sort((a, b) => {
            const valA = CONFIG.rarityDisplay[a.rarity]?.val || 0;
            const valB = CONFIG.rarityDisplay[b.rarity]?.val || 0;
            return valB - valA;
        });

        if (items.length === 0) {
            content.innerHTML = "<div style='grid-column:1/-1; text-align:center; color:#666; margin-top:50px;'>èƒŒåŒ…æ˜¯ç©ºçš„</div>";
        } else {
            items.forEach(item => {
                const div = document.createElement('div');
                let colorClass = CONFIG.rarityDisplay[item.rarity]?.color || 'rarity-common';
                
                // è¦–è¦ºæ¨£å¼
                div.className = `merchant-item ${colorClass}`;
                if(item.rarity === 'mythic') div.className += ' rarity-mythic';
                if(item.rarity === 'ultra') div.className += ' rarity-ultra';
                
                div.style.cssText = "cursor:pointer; display:flex; flex-direction:column; align-items:center; text-align:center; height:100%; justify-content:center; padding:15px;";
                
                // é¡¯ç¤ºåƒ¹æ ¼æˆ–æ•ˆæœ
                let subText = "";
                if(category === 'material') {
                    // å•†äººæ¨¡å¼é¡¯ç¤ºå”®åƒ¹
                    let p = item.price || 0;
                    if(GameState.phase === 'merchant' || GameState.phase === 'demon_merchant') {
                        if(Player.class === 'merchant') p = Math.floor(p * 1.2);
                        subText = `<span class="gold-text">${p} G</span>`;
                    }
                } else {
                    subText = `<span style="font-size:0.8em; color:#aaa;">${this.getItemDesc(item)}</span>`;
                }

                div.innerHTML = `
                    <div style="font-size:2em; margin-bottom:5px;">${item.icon || 'ğŸ“¦'}</div>
                    <div style="font-weight:bold; margin-bottom:5px; word-break:break-all;">${item.name}</div>
                    ${subText}
                `;
                
                // é»æ“Šäº‹ä»¶
                div.onclick = () => {
                    this.handleItemClick(item.originalIndex, category);
                    // æ“ä½œå¾Œåˆ·æ–°è¦–çª—
                    setTimeout(() => this.openInventoryModal(category), 100); 
                };
                
                content.appendChild(div);
            });
        }

        modal.style.display = 'flex';
    },
   
};

Game.init();
</script>
</body>
</html>









